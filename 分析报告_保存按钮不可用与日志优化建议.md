# 保存按钮不可用问题与日志压缩建议分析报告

## 1. 测试现象概述
- 场景：可靠传输模式发送大文件（示例：`test.pdf`，约 1 MB）。
- 结果：传输可以结束，无“队列繁忙”等提示，但工具栏中的“保存”按钮始终置灰，无法将接收数据另存为新文件。
- 同批次日志（`build/Debug/PortMaster_debug.log`）显示文件大小接近 26 MB，远超传输数据量。

## 2. 日志与代码层分析
1. **按钮状态未恢复**  
   - `build/Debug/PortMaster_debug.log` 在 17:35:43 只有一次 `可靠模式：等待临时缓存稳定，暂不启用保存按钮`，此后没有出现“启用保存按钮”的日志。  
   - `UpdateSaveButtonStatus()` 仅在连接、回调等场景调用。若状态始终停留在“等待临时缓存稳定”，说明判定条件 `hasPendingWrites` 或 `hasDataToSave` 一直为 false。

2. **重传失败导致临时缓存被删除**  
   - 日志末尾多次出现 `ReportError called: 数据包重传失败，序列号: 853/854/855...`，并伴随 `临时缓存文件已删除`。  
   - 在 `ThreadSafeAppendReceiveData` / `CloseTempCacheFile` 中，一旦调用 `CloseTempCacheFile()` 会：  
     - 关闭并删除临时文件 `m_tempCacheFilePath`；
     - 将 `m_totalReceivedBytes` 归零；  
     - `m_useTempCacheFile` 置为 false。  
   - 这意味着上层再查询队列时 `cachedBytes == 0`、`hasPendingWrites` 为 false，`UpdateSaveButtonStatus()` 会一直认定“尚无可保存的数据”，按钮保持禁用。

3. **重传失败未传递至 UI**  
   - `ProcessThread` 在 `重试次数 > m_config.maxRetries` 时虽然调用 `ReportError()`，但 `UpdateSaveButtonStatus()` 只要未检测到失败，就不会改写 UI 状态。
   - 用户仅看到“传输成功完成”日志，却不知道内部仍有大量重试并触发了临时缓存清理，导致数据实际已经丢失。

## 3. 问题根因总结
综合上述，保存按钮灰显的直接原因是：
1. 可靠通道在长时间重传后触发 “maxRetries exceeded”，执行 `CloseTempCacheFile()` 清除临时文件；
2. 上层并未意识到失败，仍显示“传输成功”；
3. `UpdateSaveButtonStatus()` 判定 `hasDataToSave == false`，保持禁用状态。

换言之，按钮不可用并非 UI 逻辑错误，而是底层已经把缓存数据清空却未同步失败状态。

## 4. 改进建议
1. **传输失败时立即更新 UI**  
   - 当 `ProcessThread` 判定重试超过上限并清理窗口时，应通过 `ReportError()` 或新的回调通知 `TransmissionTask` / UI：传输失败，需要人工处理。  
   - UI 接收到失败信号后要：  
     - 停止后续发送；  
     - 提示用户“文件传输失败，请重新发送”；  
     - 明确按钮禁用的原因。

2. **避免无谓删除临时缓存**  
   - 若保留临时缓存并标记“数据可能不完整”，仍可以允许用户手动保存以便排查。  
   - 可在 `CloseTempCacheFile()` 中区分：是在会话结束时调用，还是因重试失败调用，必要时不要删除临时文件。

3. **完善 `UpdateSaveButtonStatus()` 的判断**  
   - 增加失败状态检测（例如 `m_lastTransportError`），在失败后给出明确提示，而不是单纯“等待数据稳定”。  
   - 当 `m_useTempCacheFile` 已关闭但 `m_receiveDataCache` 仍保留数据时，可允许用户保存内存缓存。

4. **日志压缩方案**  
   - 当前日志含大量重复调试信息（`SendThread`、`ReceiveThread`、心跳、重传详情等），导致 1 MB 的数据生成近 26 MB 日志。建议：  
     1. 基于 `WriteVerbose()` 的机制，默认关闭详细日志，仅在 `m_receiveVerboseLogging` 打开时输出。  
     2. 对心跳、轮询日志进行节流，例如改为间隔记录或阈值变化时再输出。  
     3. 为关键路径引入简化日志格式（记录总次数而非每次事件），或提供“日志级别”设置，使用 INFO / WARN / ERROR 区分。
   - 这样能在保留必要诊断能力的情况下显著减小日志体积。

---
**报告编写时间**：2025-10-11 17:45  
