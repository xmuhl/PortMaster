# 回路测试可靠模式问题代码分析报告（进度闪烁、状态重复、保存延迟）

## 一、资料校验
- 对照 `docs/故障诊断报告-进度闪烁_状态重复_保存延迟-20251013.md` 中记录的三类现象，并结合 `修订工作记录20251013-164035.md` 的任务分解确认目标。
- 复核测试日志 `build/Debug/PortMaster_debug.log`，重点提取进度更新、可靠通道回调以及保存流程相关输出。

## 二、现象复盘（来自现有材料）
- 进度条闪烁：报告指出同一进度控件出现叠加闪烁，推测由多线程同时绘制导致。
- 状态文本重复：UI 状态栏出现“正在传输…：正在传输…”的双份文本。
- 保存延迟与误判：传输完成后保存按钮迟迟不可用，最终提示“没有数据可保存”。

## 三、日志侧取证
- `[17:16:40.757] 传输进度: 0/1113432 字节 (0%)` 与 `[17:17:15.897] 传输进度: 1113432/1113432 字节 (100%)`（`build/Debug/PortMaster_debug.log`）证明 UI 端的进度回调确实逐步拉齐到 100%，与报告描述一致。
- 多次出现的区块 `=== 轻量级UI更新信息 ===` / `接收数据大小: ...` / `ASCII预览: ...`（同日志文件）显示可靠模式在接收线程里高频地给 UI 投递刷新，佐证“重复覆盖”问题根源于多条更新路径同时生效。
- 日志未出现“OnReliableComplete”相关字样，说明当前版本虽然追加了写日志代码，但还需在后续修订中确认该分支是否被调用或日志是否被过滤。

## 四、源码交叉分析
### 1. 进度条闪烁的根因与现状
- `src/PortMasterDlg.cpp:677-698` 中的 `OnTransmissionProgress` 由传输任务线程触发，最终通过 `PostMessage(WM_USER + 11, …)` 将进度百分比发送到 UI 线程。
- `src/PortMasterDlg.cpp:3673-3688` 中的 `OnReliableProgress` 由可靠通道回调触发，历史代码曾直接调用 `m_progress.SetPos(percent)`，属于跨线程直接操作控件，正是闪烁/覆盖的根本原因；记录文件也把它列为 P0 修复项。
- 目前源码已经改为同样的 `PostMessage(WM_USER + 11, …)`，可避免非 UI 线程触控控件。后续仍需确认两路数据源（发送端进度 vs. 接收端进度）是否存在节奏差异，必要时应统一为单一来源或合并为“发送端驱动 + 接收端兜底”的策略。

### 2. 状态文本重复的根因与现状
- 发送任务在 `src/TransmissionTask.cpp:292-295` 中调用 `UpdateProgress`，并生成完整的“正在传输: X/Y 字节 (P%)”文本；
- UI 层此前在 `src/PortMasterDlg.cpp:687-691` 再次 `Format` 拼接同样的数值，导致重复文本。当前代码改为 UTF-8 → Unicode 转换后直接赋值，符合修订计划。
- 按照现有实现，若后续需要自定义显示格式，应改由后台传递原始数据结构，UI 层统一组装，以免再次出现重复。

### 3. 保存按钮延迟与“没有数据可保存”
- `src/PortMasterDlg.cpp:2631` 对临时缓存可用性的判断已调整为 `PathFileExists && GetTempCacheFileSize() > 0`，避免旧逻辑依赖可能被清零的 `m_totalReceivedBytes`。
- `src/PortMasterDlg.cpp:3700-3733` 在可靠通道完成时显式 `flush()` 并立即检查临时文件大小，只要文件存在且大于 0 即刻启用保存按钮；否则回退到 `UpdateSaveButtonStatus()` 的定时重试逻辑。
- `src/PortMasterDlg.cpp:2761-2771` 将稳定性检测的间隔缩短至 20ms，总等待时间降至约 100ms，缓解保存响应迟缓的问题。
- `WaitForReceiveDataStability`（`src/PortMasterDlg.cpp:4649-4695`）仍以 `m_totalReceivedBytes` 作为一致性判据之一；若未来出现“写入完成但统计未更新”的异常，应考虑再补充一次 `GetTempCacheFileSize()` 对比以提高鲁棒性。

### 4. 可靠通道进度同步与临界值处理
- 进度计算使用整数除法，`OnReliableProgress` 中已限制百分比上限为 100（`src/PortMasterDlg.cpp:3675-3687`），可避免因重传或超量上报导致的 >100% 问题。
- `m_reliableExpectedBytes` / `m_reliableReceivedBytes` 在同函数内受互斥量保护，可为后续“保存校验”提供准确基准；后续修订可利用该数据与文件大小的对比做保存前校验，提高错误提示的针对性。

## 五、结论与后续建议
- 三类故障均源于“多线程 UI 更新”和“数据判定依据过于分散”——现有源码已完成关键位置的线程隔离与判定统一，但相关日志尚未覆盖所有关键路径，建议在执行修订计划时补充验证步骤，确保 `OnReliableComplete` 等分支真实触发。
- 建议后续重点关注：
  1. 确认只保留一条权威进度通道，避免发送端/接收端进度互相拉扯造成的视觉跳变；
  2. 在保存流程中记录一次“文件大小 vs. 可靠通道期望值”的比对结果，及时提示潜在的落盘缺口；
  3. 强化日志覆盖面，以便在复现问题时快速定位尚未覆盖的路径。

（本报告仅完成现状分析与根因确认，尚未执行任何代码修订或构建操作。）
