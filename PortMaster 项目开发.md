你是一名资深 Windows C++/MFC 工程师，请严格按照以下规格开发名为 **PortMaster（端口大师）** 的桌面应用程序，并按交付要求输出全部设计与源码。

---

### 0. 平台与编码要求

- **操作系统兼容**：Windows 7 ~ Windows 11，支持 x86 与 x64。
- **编译环境**：Visual Studio 2022（中文界面），Toolset v143。
- **目标产物**：单一 EXE 绿色免安装版，静态链接运行库（/MT 或 /MTd）与静态链接 MFC。
- **编码规范**：
  - 源码、注释、资源、文档全部使用简体中文。
  - 所有源码/资源文件使用 UTF-8（带 BOM）；必要时在源码文件首部添加 `#pragma execution_character_set("utf-8")`。
  - `.rc` 与字符串表同样使用 UTF-8（带 BOM），禁止修改现有文件的编码格式。
- **配置存储**：优先写入程序所在目录，失败时回退到 `%LOCALAPPDATA%`。

---

### 0.1 编译脚本与验证策略

- 首选构建脚本：`autobuild_x86_debug.bat`（Win32 Debug，零错误零警告）。
- 备用构建脚本：`autobuild.bat`（Win32/x64、Debug/Release 全量构建）。
- 构建时若首选脚本不存在或失败，方可切换备用脚本。
- 每次构建后检查生成的 `msbuild_*.log`，确认 **0 error / 0 warning**。
- 构建环境要求遵循 `CLAUDE.md` 中的 Visual Studio 版本与工具链约束。

---

### 0.2 工作流程要求（摘自 CLAUDE.md，须严格执行）

1. **环境检测与初始化**：
   - 使用 CLAUDE.md 提供的脚本自动识别 WSL 或 PowerShell；设置工作目录（`C:\Users\huangl\Desktop\PortMaster` 或 `/mnt/c/Users/huangl/Desktop/PortMaster`）。
   - 输出当前环境、工作路径、备份仓库地址。
2. **修订记录创建**：
   - 每轮修订前生成 `修订工作记录YYYYMMDD-HHMMSS.md`，按模板写入修订概述、问题分析、计划安排等内容。
   - 未完成记录编写禁止开始代码修改。
3. **环境准备与同步**：
   - 进入工作目录，执行 `git pull --rebase`（自动区分 WSL/PowerShell 命令）。
4. **进度文档维护策略**：
   - 阶段一（开始任务）：记录开始时间与任务说明。
   - 阶段二（完成任务）：记录完成时间、关键改动、编译结果。
   - 阶段三（版本控制前）：整理最终内容；禁止在文档中记录具体提交/推送信息。
5. **编码规范复查**：
   - 仅修改必要文件；禁止提交 `.vs/`、`bin/`、`obj/`、`Debug/`、`Release/` 等忽略目录。
6. **智能编译流程**：
   - 判断变更文件类型；源码改动必须执行首选脚本编译，必要时回退备用脚本。
   - 保留关键日志片段，确认零错误零警告。
7. **版本控制与推送**：
   - `git add -A`，按 `类型: 简述`（feat/fix/docs/refactor/test/chore）提交；推送到可用远程（PortMaster/origin）。
   - 可选创建 `save-YYYYMMDD-HHMMSS` 标签。
8. **工作收尾汇报**：
   - 汇报最新 commit ID、推送结果、关键编译日志，以及遗留问题与建议。
9. **环境检查清单**：
   - WSL：确认路径可访问、`cmd.exe` 可调用、备份仓库可用、编译脚本存在。
   - PowerShell：确认 VS2022 安装、执行策略允许脚本、备份仓库可用。

---

### 1. 项目定位与品牌

- **项目名称**：PortMaster（端口大师）。
- **定位**：多端口（串口 / 并口 / USB 打印 / 网络打印 / 回路测试）数据读写与可靠传输辅助工具。
- **品牌特征**：跨端口通信、可靠协议保障、单文件部署、Win7~Win11 全兼容。

---

### 1.1 视觉资源集成

1. **项目主图标（ICO）**：`PortMaster_Icon.ico`，包含 16~256 像素分辨率，用作 `IDI_MAIN_ICON`。
2. **PNG 图标源文件**：`PortMaster_Icon.png`。
3. **启动画面**：`PortMaster_Splash.png`，启动时居中显示 2~3 秒或初始化阶段显示。
4. **集成要求**：所有资源均在 `.rc` 中声明并打包进 EXE；启动画面需兼容 Win7~Win11。

---

### 2. 功能需求

#### 2.1 支持的端口类型

1. **串口 COM**
   - API：`CreateFile`、`SetCommState`、`GetCommState`、`SetCommTimeouts`、`EscapeCommFunction`、`OVERLAPPED I/O`。
   - 参数配置：波特率、数据位、校验位、停止位、硬件流控（RTS/CTS、DTR/DSR）、软件流控（XON/XOFF）、读写超时、缓冲区大小。
   - 端口占用检测：连接前尝试打开句柄，失败时提示占用信息并提供重试。
2. **并口（LPT）**
   - 常用端口号：LPT1、LPT2 等。
   - 使用 `CreateFile` / `ReadFile` / `WriteFile` / `DeviceIoControl` 直接访问；不依赖打印机驱动或打印队列。
   - 需提示操作权限与兼容性注意事项。
3. **USB 打印端口**
   - 常用端口号：USB001、USB002 等。
   - 与并口相同，基于句柄直接读写，并提供在线/忙碌/错误等基本状态查询。
4. **网络打印端口**
   - 支持协议：RAW 9100、LPR/LPD、IPP-over-HTTP(S)。
   - 配置项：目标主机/IP、协议类型、端口号或队列名、连接超时、Keep-Alive、重连策略、可选认证（Basic/NTLM/证书）。
   - 默认直通模式，可按需启用可靠校验。
5. **回路测试端口**
   - 虚拟端口，用于本机自检与协议验证。
   - 支持直通与可靠模式，流程与真实端口一致，并输出回路统计信息。

#### 2.2 工作模式

- **直通模式**：直接对端口进行数据读写（并口/USB 为写入 + 状态查询）。
- **可靠模式**：启用自研可靠传输协议，对串口、回路测试、网络端口（可选）提供完整性保障。
- 模式选择仅与数据完整性需求关联，与 UI 控件布局解耦。

#### 2.3 操作特性

- 端口连接、断开、参数保存、配置加载均在连接面板完成。
- 输入窗口支持手动输入、文件加载、拖放单个文件；十六进制复选框统一控制发送与接收窗口显示格式。
- 长数据传输提供发送→暂停→继续→中断流程；暂停保留位置，继续从断点恢复；中断立即终止并根据模式决定是否保留断点。
- 统计信息：发送/接收字节、吞吐速率、ACK/NAK/重传计数、当前模式指示、回路测试轮次。
- 日志记录关键操作（连接、拖放、暂停、继续、中断、复制、保存、错误）。

---

### 3. 可靠传输协议

#### 3.1 帧格式（小端）

包头(0xAA55,2B) + 类型(1B) + 序号(2B) + 长度(2B) +
CRC32(4B, 多项式0xEDB88320, init 0xFFFFFFFF, final xor 0xFFFFFFFF，覆盖“类型|序号|长度|数据”) +
数据(0..N) + 包尾(0x55AA,2B)

- 类型：`0x01=START`、`0x02=DATA`、`0x03=END`、`0x10=ACK`、`0x11=NAK`。
- 默认负载上限：1024 字节（可配置）。

#### 3.2 流程

- 发送端：START → 等 ACK → DATA(N) 逐包 ACK/NAK/超时重传 → END → 等 ACK → 完成。
- 接收端：收到 START 回 ACK；DATA 序号与 CRC 正确则保存数据并 ACK；否则 NAK；收到 END 回 ACK。

#### 3.3 错误处理

- CRC 失败 → NAK + 记录错误计数。
- 超时 → 按动态超时参数重传；超过最大重试次数 → 报告失败。
- 链路错误后执行缓冲区清理，防止旧数据污染会话。

#### 3.4 状态机

- Sender：Idle → Starting → Sending → Ending → Done/Failed。
- Receiver：Idle → Ready → Receiving → Done/Failed。

#### 3.5 链路增强

- 支持粘包/半包/失步重同步；滑动窗口 = 1（逐包 ACK）。
- 动态超时估算：根据最近 RTT 平滑计算；串口长链路可自适应。
- 断点续传：START 帧可包含上次完成序号，重连后从断点恢复。
- 链路质量统计：记录 RTT、重传次数、吞吐速率，UI 可实时显示。
- 协议版本协商：START 帧携带版本号，支持兼容模式。
- 回路测试：对直通与可靠模式均输出轮次、成功/失败统计。

#### 3.6 START 元数据

ver(1B)=1, flags(1B), name_len(2B), name(UTF-8), file_size(8B,LE)[, mtime(8B)]

- 接收端按源文件名保存（重名自动追加序号）。
- 默认保存目录：用户指定或 `%LOCALAPPDATA%\PortIO\Recv`。

---

### 4. 架构与代码组织

- **接口层**：`ITransport`（Open/Close/Read/Write/IsOpen/Configure）。
- **实现类**：`SerialTransport`、`LptPortTransport`、`UsbPortTransport`、`NetworkPrintTransport`、`LoopbackTransport`。
- **协议层**：`ReliableChannel`（可靠模式控制）、`FrameCodec`、`CRC32`。
- **公共工具**：`TransportFactory`、`ConfigStore`、`IOWorker`（OVERLAPPED I/O）、`RingBuffer`、统计模块。
- **UI 层**：MFC 对话框，负责控件状态、操作命令、日志显示、进度条等。
- 分层架构遵循 `Application → Protocol → Transport → Hardware` 模式，与 CLAUDE.md 的架构指导一致。

---

### 5. UI 设计与交互细节

- **布局**：保持 `designUI.png` 结构：左侧连接控制、上部数据发送、下部数据接收、右侧操作面板、底部状态条。
- **端口选择**：
  - 端口类下拉包含串口、并口、USB 打印、网络打印、回路测试。
  - 根据端口类切换字段（串口参数、LPT/USB 口号、网络打印配置、回路模式）。
- **十六进制显示**：单一复选框控制发送与接收窗口展示格式，两者同步切换。
- **输入数据窗口**：
  - 支持拖入单个文件；小文件完整加载并可通过滚动条查看；超过阈值（如 1 MB）时仅显示开头片段并提示其余内容已进入后台缓冲。
  - “清空”按钮移除当前内容并重置统计。
- **发送 / 暂停 / 继续 / 停止**：
  - 初始按钮文本为“发送”；发送中切换为“暂停”；暂停后变成“继续”。
  - “停止”按钮在任意模式下始终保持“停止”标签，点击后立即结束当前传输任务并将界面状态恢复至待机。
  - 以上控制对直通与可靠模式均有效。
- **文件按钮**：打开文件选择器加载单文件，超阈值显示片段提示；记录最近使用列表供快速选择。
- **接收窗口**：
  - “清除”按钮清空接收窗口内容。
  - “复制”将当前显示格式（文本或十六进制）复制到剪贴板。
  - “保存”弹出标准“保存文件”对话框，用户命名后按当前显示模式写入文件；保存成功在日志区提示路径。
- **日志与状态**：
  - 右下日志窗口滚动记录操作与异常，并提供“导出日志”按钮。
  - 底部状态条集中展示连接状态、当前模式、吞吐速率、错误计数、回路测试轮次以及校验/统计提示，可手动重置回路计数。

界面 ASCII 草图：

+-------------------------------------------------------------------------------+
| PortMaster - 端口大师                                       模式:● 可靠传输    |
|-------------------------------------------------------------------------------|
| 连接控制                 | 数据发送                                        | 操作区 |
| ┌---------------------┐  | 输入数据  [□ 十六进制显示]  来源: 手动输入        | ┌----┐|
| | 端口类: 串口 ▼      |  |-----------------------------------------------| |发送 |
| | 端口: COM1  ▼       |  |                                               | |停止 |
| | 波特率: 9600 ▼      |  |   (支持拖入单个文件；超大文件仅显示头部)        | |清空 |
| | 数据位: 8  ▼        |  |                                               | |文件 |
| | 校验: None ▼        |  |-----------------------------------------------| └----┘|
| | 停止位: 1  ▼        |  | 数据接收（格式随十六进制选项同步切换）          | ┌显示┐|
| | 流控: RTS/CTS ▼     |  |-----------------------------------------------| |控制|
| | 读写超时: 200ms     |  |                                               | └----┘|
| | 占用检测: □         |  |                                               | ┌----┐|
| | 可可靠传输: □  ●    |  |                                               | |清除|
| | [连接]   [断开]     |  └-----------------------------------------------┘ |复制|
| └---------------------┘                                                      |保存|
|                                                                              | └----┘|
|-------------------------------------------------------------------------------|
| 日志: ... | 端口: COM1 | 模式: 可靠 | 速率: 12KB/s | 回路测试轮次: 3 | 校验: 通过 | 导出日志 |
+-------------------------------------------------------------------------------+

---

### 6. 配置管理与日志

- **配置文件（JSON）**：
  - 串口：端口号、波特率、数据位、校验位、停止位、流控、超时、可靠模式默认值。
  - 并口/USB：口号（LPT1/LPT2、USB001/USB002）、访问模式、可靠默认值。
  - 网络打印：目标主机/IP、协议、端口或队列、认证信息、超时、Keep-Alive、可靠模式开关。
  - 回路测试：最近使用的模式、统计信息。
  - UI 状态：十六进制复选框、窗口尺寸、最近文件列表等。
- **日志系统**：记录端口切换、连接状态、传输事件、错误、保存/复制操作；支持手动导出。

---

### 7. 手动测试要求

1. **串口直通测试**：选择串口 → 配置参数 → 发送测试字符串 → 确认接收窗口与发送内容一致 → 验证复制/保存。
2. **串口可靠测试**：启用可靠模式 → 发送文件（可拖放） → 观察 ACK/NAK/重传统计 → 验证暂停/继续/中断 → 检查接收文件。
3. **回路测试直通/可靠**：切换到回路端口 → 分别在两种模式下执行与串口一致的操作 → 检查回路轮次统计与日志。
4. **并口/USB 测试**：选择对应口号 → 写入样例数据 → 通过设备反馈或状态查询确认成功。
5. **网络打印测试**：配置目标主机/IP 与协议 → 发送测试页 → 检查打印设备响应或返回码。
6. **日志与保存操作**：验证复制、保存、导出日志按钮功能与提示信息。
7. 每阶段修改后执行首选构建脚本，确认零错误零警告并记录日志片段。

---

### 8. 非功能性与边界

- 并口/USB 不提供寄存器级访问；仅使用 Windows 用户态 API。
- 网络端口限定在打印设备或打印服务器场景，不当作通用 Socket 工具。
- 保持 Win7~Win11 兼容，必要时提供条件编译以回退至旧 API。
- 安全策略：操作日志留存、异常告警、监听类操作需用户确认、基础权限控制、支持网络端口 TLS/HTTPS。

---

### 9. 交付内容清单

1. 总体设计说明（中文，涵盖本文件全部要点）。
2. ASCII 类图/组件图（展示 Transport、ReliableChannel、UI、配置模块关系）。
3. 可靠协议规格表（含 START 元数据 TLV 与链路增强说明）。
4. 发送端/接收端状态机图（ASCII）。
5. 关键 C++ 源码（资源加载、启动画面、各 Transport、ReliableChannel、十六进制显示联动）。
6. `.rc` 资源文件（集成图标与启动画面）。
7. 配置保存/加载实现（含 JSON 结构示例）。
8. 手动测试指引（覆盖串口/回路/并口/USB/网络打印，含 UI 操作细节）。
9. 构建指南（说明脚本优先级、CLAUDE 工作流程步骤）。
10. 边界与风控清单。
11. 主界面 ASCII 草图与交互说明。
12. 最新修订工作记录文件（对应本轮工作流程）。

---

### 10. 后续扩展建议

- 增加脚本化测试工具，自动化执行回路测试场景。
- 引入插件式 Transport 机制，支持更多专用硬件接口。
- 可选集成数据加密模块，满足跨网段传输安全需求。
- 扩展协议以支持多线程发送与更大的滑动窗口。
- 考虑加入远程监控面板，实现设备状态实时推送。















