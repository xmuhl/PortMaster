#include "pch.h"
#include "PortMaster.h"
#include "PortConfigDialog.h"
#include "afxdialogex.h"

// CPortConfigDialog 瀵硅瘽妗?
IMPLEMENT_DYNAMIC(CPortConfigDialog, CDialogEx)

CPortConfigDialog::CPortConfigDialog(const std::string& transportType, const TransportConfig& config, CWnd* pParent /*=nullptr*/)
	: CDialogEx(IDD_PORT_CONFIG_DIALOG, pParent)
	, m_transportType(transportType)
	, m_config(config)
{

}

CPortConfigDialog::~CPortConfigDialog()
{
}

void CPortConfigDialog::DoDataExchange(CDataExchange* pDX)
{
	CDialogEx::DoDataExchange(pDX);
	DDX_Control(pDX, IDC_TRANSPORT_TYPE, m_ctrlTransportType);
	DDX_Control(pDX, IDC_BAUD_RATE, m_ctrlBaudRate);
	DDX_Control(pDX, IDC_DATA_BITS, m_ctrlDataBits);
	DDX_Control(pDX, IDC_PARITY, m_ctrlParity);
	DDX_Control(pDX, IDC_STOP_BITS, m_ctrlStopBits);
	DDX_Control(pDX, IDC_IP_ADDRESS, m_ctrlIpAddress);
	DDX_Control(pDX, IDC_PORT, m_ctrlPort);
	DDX_Control(pDX, IDC_IS_SERVER, m_ctrlIsServer);
	DDX_Control(pDX, IDC_CONNECT_TIMEOUT, m_ctrlConnectTimeout);
	DDX_Control(pDX, IDC_READ_TIMEOUT, m_ctrlReadTimeout);
	DDX_Control(pDX, IDC_WRITE_TIMEOUT, m_ctrlWriteTimeout);
	DDX_Control(pDX, IDC_RX_BUFFER_SIZE, m_ctrlRxBufferSize);
	DDX_Control(pDX, IDC_TX_BUFFER_SIZE, m_ctrlTxBufferSize);
	DDX_Control(pDX, IDC_SERIAL_GROUP, m_ctrlSerialGroup);
	DDX_Control(pDX, IDC_NETWORK_GROUP, m_ctrlNetworkGroup);
	DDX_Control(pDX, IDC_TIMEOUT_GROUP, m_ctrlTimeoutGroup);
	DDX_Control(pDX, IDC_BUFFER_GROUP, m_ctrlBufferGroup);
}

BEGIN_MESSAGE_MAP(CPortConfigDialog, CDialogEx)
	ON_BN_CLICKED(IDOK, &CPortConfigDialog::OnBnClickedOk)
	ON_BN_CLICKED(IDCANCEL, &CPortConfigDialog::OnBnClickedCancel)
	ON_CBN_SELCHANGE(IDC_TRANSPORT_TYPE, &CPortConfigDialog::OnCbnSelchangeTransportType)
END_MESSAGE_MAP()

BOOL CPortConfigDialog::OnInitDialog()
{
	CDialogEx::OnInitDialog();

	// 鍒濆鍖栦紶杈撶被鍨嬩笅鎷夋
	m_ctrlTransportType.AddString(L"涓插彛 (Serial)");
	m_ctrlTransportType.AddString(L"骞跺彛 (LPT)");
	m_ctrlTransportType.AddString(L"USB鎵撳嵃鏈?);
	m_ctrlTransportType.AddString(L"TCP瀹㈡埛绔?);
	m_ctrlTransportType.AddString(L"TCP鏈嶅姟绔?);
	m_ctrlTransportType.AddString(L"UDP");
	m_ctrlTransportType.AddString(L"鏈湴鍥炵幆");

	// 璁剧疆褰撳墠浼犺緭绫诲瀷
	if (m_transportType == "Serial") m_ctrlTransportType.SetCurSel(0);
	else if (m_transportType == "LPT") m_ctrlTransportType.SetCurSel(1);
	else if (m_transportType == "USB") m_ctrlTransportType.SetCurSel(2);
	else if (m_transportType == "TCP_Client") m_ctrlTransportType.SetCurSel(3);
	else if (m_transportType == "TCP_Server") m_ctrlTransportType.SetCurSel(4);
	else if (m_transportType == "UDP") m_ctrlTransportType.SetCurSel(5);
	else if (m_transportType == "Loopback") m_ctrlTransportType.SetCurSel(6);

	// 鍒濆鍖栨牎楠屼綅涓嬫媺妗?	m_ctrlParity.AddString(L"鏃犳牎楠?);
	m_ctrlParity.AddString(L"濂囨牎楠?);
	m_ctrlParity.AddString(L"鍋舵牎楠?);

	// 鍒濆鍖栧仠姝綅涓嬫媺妗?	m_ctrlStopBits.AddString(L"1浣?);
	m_ctrlStopBits.AddString(L"2浣?);

	// 鍔犺浇閰嶇疆鍒版帶浠?	LoadConfigToControls();
	
	// 鏇存柊鎺т欢鍙鎬?	UpdateControlVisibility();

	return TRUE;
}

void CPortConfigDialog::OnBnClickedOk()
{
	// 淇濆瓨鎺т欢鍒伴厤缃?	SaveControlsToConfig();
	
	CDialogEx::OnOK();
}

void CPortConfigDialog::OnBnClickedCancel()
{
	CDialogEx::OnCancel();
}

void CPortConfigDialog::OnCbnSelchangeTransportType()
{
	int sel = m_ctrlTransportType.GetCurSel();
	switch (sel)
	{
	case 0: m_transportType = "Serial"; break;
	case 1: m_transportType = "LPT"; break;
	case 2: m_transportType = "USB"; break;
	case 3: m_transportType = "TCP_Client"; break;
	case 4: m_transportType = "TCP_Server"; break;
	case 5: m_transportType = "UDP"; break;
	case 6: m_transportType = "Loopback"; break;
	}
	
	UpdateControlVisibility();
}

void CPortConfigDialog::UpdateControlVisibility()
{
	bool isSerial = (m_transportType == "Serial");
	bool isNetwork = (m_transportType == "TCP_Client" || m_transportType == "TCP_Server" || m_transportType == "UDP");
	bool isTcpServer = (m_transportType == "TCP_Server");
	
	// 涓插彛鐩稿叧鎺т欢
	m_ctrlSerialGroup.ShowWindow(isSerial ? SW_SHOW : SW_HIDE);
	m_ctrlBaudRate.ShowWindow(isSerial ? SW_SHOW : SW_HIDE);
	m_ctrlDataBits.ShowWindow(isSerial ? SW_SHOW : SW_HIDE);
	m_ctrlParity.ShowWindow(isSerial ? SW_SHOW : SW_HIDE);
	m_ctrlStopBits.ShowWindow(isSerial ? SW_SHOW : SW_HIDE);
	
	// 缃戠粶鐩稿叧鎺т欢
	m_ctrlNetworkGroup.ShowWindow(isNetwork ? SW_SHOW : SW_HIDE);
	m_ctrlIpAddress.ShowWindow(isNetwork ? SW_SHOW : SW_HIDE);
	m_ctrlPort.ShowWindow(isNetwork ? SW_SHOW : SW_HIDE);
	m_ctrlIsServer.ShowWindow(isTcpServer ? SW_SHOW : SW_HIDE);
}

void CPortConfigDialog::LoadConfigToControls()
{
	CString temp;
	
	// 涓插彛閰嶇疆
	temp.Format(L"%d", m_config.baudRate);
	m_ctrlBaudRate.SetWindowText(temp);
	
	temp.Format(L"%d", m_config.dataBits);
	m_ctrlDataBits.SetWindowText(temp);
	
	m_ctrlParity.SetCurSel(m_config.parity);
	m_ctrlStopBits.SetCurSel(m_config.stopBits - 1);
	
	// 缃戠粶閰嶇疆
	m_ctrlIpAddress.SetWindowText(CString(m_config.ipAddress.c_str()));
	
	temp.Format(L"%d", m_config.port);
	m_ctrlPort.SetWindowText(temp);
	
	m_ctrlIsServer.SetCheck(m_config.isServer ? BST_CHECKED : BST_UNCHECKED);
	
	// 瓒呮椂閰嶇疆
	temp.Format(L"%d", m_config.connectTimeoutMs);
	m_ctrlConnectTimeout.SetWindowText(temp);
	
	temp.Format(L"%d", m_config.readTimeoutMs);
	m_ctrlReadTimeout.SetWindowText(temp);
	
	temp.Format(L"%d", m_config.writeTimeoutMs);
	m_ctrlWriteTimeout.SetWindowText(temp);
	
	// 缂撳啿鍖洪厤缃?	temp.Format(L"%zu", m_config.rxBufferSize);
	m_ctrlRxBufferSize.SetWindowText(temp);
	
	temp.Format(L"%zu", m_config.txBufferSize);
	m_ctrlTxBufferSize.SetWindowText(temp);
}

void CPortConfigDialog::SaveControlsToConfig()
{
	CString temp;
	
	// 涓插彛閰嶇疆
	m_ctrlBaudRate.GetWindowText(temp);
	m_config.baudRate = _ttoi(temp);
	
	m_ctrlDataBits.GetWindowText(temp);
	m_config.dataBits = _ttoi(temp);
	
	m_config.parity = m_ctrlParity.GetCurSel();
	m_config.stopBits = m_ctrlStopBits.GetCurSel() + 1;
	
	// 缃戠粶閰嶇疆
	m_ctrlIpAddress.GetWindowText(temp);
	m_config.ipAddress = CT2A(temp);
	
	m_ctrlPort.GetWindowText(temp);
	m_config.port = _ttoi(temp);
	
	m_config.isServer = (m_ctrlIsServer.GetCheck() == BST_CHECKED);
	
	// 瓒呮椂閰嶇疆
	m_ctrlConnectTimeout.GetWindowText(temp);
	m_config.connectTimeoutMs = _ttoi(temp);
	
	m_ctrlReadTimeout.GetWindowText(temp);
	m_config.readTimeoutMs = _ttoi(temp);
	
	m_ctrlWriteTimeout.GetWindowText(temp);
	m_config.writeTimeoutMs = _ttoi(temp);
	
	// 缂撳啿鍖洪厤缃?	m_ctrlRxBufferSize.GetWindowText(temp);
	m_config.rxBufferSize = _ttoi(temp);
	
	m_ctrlTxBufferSize.GetWindowText(temp);
	m_config.txBufferSize = _ttoi(temp);
}