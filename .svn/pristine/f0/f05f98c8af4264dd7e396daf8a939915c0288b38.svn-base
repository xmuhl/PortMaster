#pragma once

#include "../Transport/ITransport.h"
#include <string>
#include <map>
#include <vector>

// 閰嶇疆绠＄悊鍣?- 澶勭悊JSON鏍煎紡閰嶇疆鏂囦欢
class ConfigManager
{
public:
    ConfigManager();
    ~ConfigManager();
    
    // 閰嶇疆鏂囦欢鎿嶄綔
    bool LoadConfig(const std::string& filePath = "");
    bool SaveConfig(const std::string& filePath = "") const;
    bool ResetToDefaults();
    
    // 浼犺緭閰嶇疆
    // 传输配置
    bool SaveTransportConfig(const std::string& transportType, const TransportConfig& config);
    TransportConfig LoadTransportConfig(const std::string& transportType) const;
    std::vector<std::string> GetSavedTransportTypes() const;
    
    // 通用配置项
    void SetValue(const std::string& section, const std::string& key, const std::string& value);
    void SetValue(const std::string& section, const std::string& key, int value);
    void SetValue(const std::string& section, const std::string& key, bool value);
    void SetValue(const std::string& section, const std::string& key, double value);
    
    std::string GetString(const std::string& section, const std::string& key, const std::string& defaultValue = "") const;
    int GetInt(const std::string& section, const std::string& key, int defaultValue = 0) const;
    bool GetBool(const std::string& section, const std::string& key, bool defaultValue = false) const;
    double GetDouble(const std::string& section, const std::string& key, double defaultValue = 0.0) const;
    
    // 搴旂敤绋嬪簭鐗瑰畾閰嶇疆
    struct AppConfig
    {
        // 绐楀彛璁剧疆
        int windowX = 100;
        int windowY = 100;
        int windowWidth = 800;
        int windowHeight = 600;
        bool windowMaximized = false;
        
        // 鍙潬浼犺緭璁剧疆
        int ackTimeoutMs = 1000;
        int maxRetries = 3;
        size_t maxPayloadSize = 1024;
        std::string receiveDirectory;
        
        // 鐣岄潰璁剧疆
        bool hexViewEnabled = true;
        bool textViewEnabled = true;
        bool showTimestamp = true;
        
        // 鏃ュ織璁剧疆
        bool enableLogging = true;
        std::string logDirectory;
        int maxLogFiles = 10;
        
        // 娴嬭瘯璁剧疆
        bool autoTest = false;
        std::string testDataFile;
    };
    
    AppConfig GetAppConfig() const;
    void SetAppConfig(const AppConfig& config);
    
    // 閰嶇疆鏂囦欢璺緞绠＄悊
    static std::string GetDefaultConfigPath();
    static std::string GetUserConfigPath();
    std::string GetCurrentConfigPath() const { return m_configFilePath; }

private:
    std::string m_configFilePath;
    mutable std::map<std::string, std::map<std::string, std::string>> m_config;
    
    // JSON 杈呭姪鏂规硶锛堢畝鍗曞疄鐜帮級
    bool ParseJsonFile(const std::string& filePath);
    bool WriteJsonFile(const std::string& filePath) const;
    std::string EscapeJsonString(const std::string& str) const;
    std::string UnescapeJsonString(const std::string& str) const;
    
    // 璺緞杈呭姪鏂规硶
    // 路径辅助方法
    bool EnsureDirectoryExists(const std::string& filePath) const;
    std::string GetSectionKey(const std::string& section, const std::string& key) const;
    
    // 默认值设置
    void SetDefaultValues();
    TransportConfig GetDefaultTransportConfig(const std::string& transportType) const;
};