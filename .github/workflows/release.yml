name: Release Validation

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  release-validation:
    name: Release Validation
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3

      - name: Get Version
        id: get_version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $version = "${{ github.ref_name }}"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Run Release Validation
        run: python ci_cd_integration.py release --version ${{ steps.get_version.outputs.version }}

      - name: Check Validation Result
        run: |
          $result = Get-Content ci_artifacts/release_validation_${{ steps.get_version.outputs.version }}.json | ConvertFrom-Json
          if (-not $result.overall_success) {
            Write-Error "å‘å¸ƒéªŒè¯å¤±è´¥"
            exit 1
          }
        shell: pwsh

      - name: Build Release Binaries
        run: |
          # æ„å»ºReleaseé…ç½®
          msbuild PortMaster.sln /p:Configuration=Release /p:Platform=x86 /m

      - name: Create Release Package
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $packageDir = "PortMaster-$version"

          New-Item -ItemType Directory -Path $packageDir

          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’Œä¾èµ–
          Copy-Item "bin/Release/PortMaster.exe" -Destination "$packageDir/"

          # å¤åˆ¶æ–‡æ¡£
          Copy-Item "README.md" -Destination "$packageDir/" -ErrorAction SilentlyContinue
          Copy-Item "AUTOMATION_README.md" -Destination "$packageDir/" -ErrorAction SilentlyContinue
          Copy-Item "CHANGELOG.md" -Destination "$packageDir/" -ErrorAction SilentlyContinue

          # åˆ›å»ºZIPåŒ…
          Compress-Archive -Path "$packageDir/*" -DestinationPath "PortMaster-$version.zip"
        shell: pwsh

      - name: Generate Release Notes
        id: release_notes
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $validationResult = Get-Content "ci_artifacts/release_validation_$version.json" | ConvertFrom-Json

          $notes = @"
## PortMaster $version

### éªŒè¯ç»“æœ

"@

          foreach ($step in $validationResult.steps) {
            $status = if ($step.success) { "âœ…" } else { "âŒ" }
            $notes += "`n- $status $($step.name)"

            if ($step.details.total_tests) {
              $notes += " ($($step.details.passed_tests)/$($step.details.total_tests))"
            }
          }

          $notes += @"

### æµ‹è¯•è¦†ç›–

- å•å…ƒæµ‹è¯•: $($validationResult.steps | Where-Object { $_.name -eq 'å•å…ƒæµ‹è¯•' } | Select-Object -ExpandProperty details | Select-Object -ExpandProperty total_tests) ä¸ª
- é›†æˆæµ‹è¯•: $($validationResult.steps | Where-Object { $_.name -eq 'é›†æˆæµ‹è¯•' } | Select-Object -ExpandProperty details | Select-Object -ExpandProperty total_tests) ä¸ª
- æ€§èƒ½æµ‹è¯•: é€šè¿‡
- å›å½’æµ‹è¯•: æ— å›å½’

### ä¸‹è½½

- Windows x86: PortMaster-$version.zip

### å®‰è£…è¯´æ˜

1. ä¸‹è½½å¹¶è§£å‹ PortMaster-$version.zip
2. è¿è¡Œ PortMaster.exe
3. æŸ¥çœ‹ AUTOMATION_README.md äº†è§£è‡ªåŠ¨åŒ–åŠŸèƒ½

### å·²çŸ¥é—®é¢˜

æ— 
"@

          $notes | Set-Content -Path "release_notes.md"
          echo "notes<<EOF" >> $env:GITHUB_OUTPUT
          echo "$notes" >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: PortMaster ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            PortMaster-${{ steps.get_version.outputs.version }}.zip
            ci_artifacts/release_validation_${{ steps.get_version.outputs.version }}.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-${{ steps.get_version.outputs.version }}
          path: |
            PortMaster-${{ steps.get_version.outputs.version }}.zip
            ci_artifacts/
            release_notes.md
          retention-days: 365

      - name: Create Release Baseline
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          python -c "from autotest_integration import AutoTestIntegration; at = AutoTestIntegration(); at.create_baseline('$version')"
        shell: pwsh

      - name: Commit Release Baseline
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add AutoTest/baselines/
          git commit -m "chore: æ·»åŠ å‘å¸ƒç‰ˆæœ¬å›å½’åŸºçº¿ ${{ steps.get_version.outputs.version }}" || echo "æ— å˜æ›´"
          git push || echo "æ¨é€å¤±è´¥æˆ–æ— å˜æ›´"
        shell: pwsh

  deploy-documentation:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: release-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Build Documentation
        run: |
          # å¦‚æœæœ‰æ–‡æ¡£ç”Ÿæˆå·¥å…·ï¼Œåœ¨è¿™é‡Œè¿è¡Œ
          # ä¾‹å¦‚: mkdocs build æˆ– sphinx-build

          # ç›®å‰æˆ‘ä»¬åªæ˜¯å¤åˆ¶Markdownæ–‡æ¡£
          mkdir -p docs
          cp README.md docs/
          cp AUTOMATION_README.md docs/
          cp Week*.md docs/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          commit_message: 'docs: æ›´æ–°æ–‡æ¡£ ${{ steps.get_version.outputs.version }}'

  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: release-validation

    steps:
      - name: Send Release Notification
        uses: actions/github-script@v6
        with:
          script: |
            const version = '${{ steps.get_version.outputs.version }}';

            // åˆ›å»ºå‘å¸ƒå…¬å‘ŠIssue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ å‘å¸ƒ ${version}`,
              body: `æ–°ç‰ˆæœ¬ ${version} å·²å‘å¸ƒï¼\n\n[æŸ¥çœ‹å‘å¸ƒè¯¦æƒ…](${context.payload.repository.html_url}/releases/tag/${version})\n\n[ä¸‹è½½é“¾æ¥](${context.payload.repository.html_url}/releases/download/${version}/PortMaster-${version}.zip)`,
              labels: ['release', 'announcement']
            });

            // å¦‚æœé…ç½®äº†Webhookï¼Œå‘é€é€šçŸ¥
            // await fetch('YOUR_WEBHOOK_URL', {
            //   method: 'POST',
            //   headers: { 'Content-Type': 'application/json' },
            //   body: JSON.stringify({ version, url: `${context.payload.repository.html_url}/releases/tag/${version}` })
            // });
