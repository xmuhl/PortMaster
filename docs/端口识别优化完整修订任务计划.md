# PortMaster 端口识别优化完整修订任务计划

## 📋 修订概述

**修订日期**：2025-10-29
**修订目标**：解决PortMaster在切换到物理设备端口（串口、并口、USB打印、网络打印）时，用户无法准确识别和选择正确端口的问题
**预期成果**：通过异步扫描、设备信息增强、连接状态重检等方式，显著提升用户体验

---

## 📊 详细任务清单

### ✅ 阶段一：需求分析与设计
- [x] 需求确认与任务规划
- [x] 分析所有端口类型现状
- [x] 设计通用端口信息结构
- [x] 确定网络打印机配置对话框方案

---

### 🔄 阶段二：网络打印机配置对话框实现
**任务状态**：⏳ 待开始
**预计时间**：40-50分钟
**复杂度**：中等

#### 任务列表：
- [ ] 1.1 创建对话框资源文件
  - 文件：`resources\NetworkPrinterConfigDialog.rc`
  - 文件：`resource.h` - 添加对话框ID定义
  - 资源内容：IP地址、端口号、协议类型输入框

- [ ] 1.2 实现对话框类
  - 文件：`src\NetworkPrinterConfigDialog.h/.cpp`
  - 关键方法：SetNetworkConfig(), GetNetworkConfig(), TestConnection()
  - 功能：IP格式验证、端口范围检查、TCP连接测试

- [ ] 1.3 集成到PortConfigPresenter
  - 文件：`src\PortConfigPresenter.h/.cpp`
  - 新增方法：OnNetworkPrinterConfigSelected(), AddCustomNetworkPrinter()

**完成标准**：
- [ ] 对话框可以正常弹出
- [ ] 可以配置网络打印机参数
- [ ] 连接测试功能正常

---

### 🔄 阶段三：增强串口枚举（获取设备描述）
**任务状态**：⏳ 待开始
**预计时间**：30-40分钟
**复杂度**：中等

#### 任务列表：
- [ ] 3.1 新增端口信息结构
  - 文件：`Common\CommonTypes.h`
  - 新增：PortType枚举、PortStatus枚举、PortInfo结构体
  - 功能：统一描述所有端口类型

- [ ] 3.2 增强串口枚举方法
  - 文件：`Transport\SerialTransport.h/.cpp`
  - 新增方法：EnumerateSerialPortsWithInfo()
  - 功能：使用SetupAPI枚举、设备友好名称获取、端口状态检测

- [ ] 3.3 设备信息获取细节
  - 实现：GetDeviceFriendlyName() - 从注册表获取设备名称
  - 实现：CheckSerialPortStatus() - 检测端口可用性

**完成标准**：
- [ ] 串口列表显示设备描述（如"COM3 - CH340"）
- [ ] 端口状态检测准确

---

### 🔄 阶段四：增强并口枚举（获取设备描述）
**任务状态**：⏳ 待开始
**预计时间**：25-35分钟
**复杂度**：低

#### 任务列表：
- [ ] 4.1 新增并口枚举方法
  - 文件：`Transport\ParallelTransport.h/.cpp`
  - 新增方法：EnumerateParallelPortsWithInfo()
  - 功能：使用WMI查询并口设备信息、注册表查询打印机信息

- [ ] 4.2 并口状态检测
  - 实现：端口可用性检测（1000ms超时）
  - 显示：设备描述和状态信息

**完成标准**：
- [ ] 并口列表显示设备信息（如"LPT1 - EPSON L3150"）
- [ ] 状态检测准确

---

### 🔄 阶段五：增强USB打印枚举（获取设备描述）
**任务状态**：⏳ 待开始
**预计时间**：20-30分钟
**复杂度**：低

#### 任务列表：
- [ ] 5.1 增强现有枚举方法
  - 文件：`Transport\UsbPrintTransport.h/.cpp`
  - 修改：EnumerateUsbPortsWithInfo()
  - 改进：设备名称获取、设备ID解析、设备状态检测

- [ ] 5.2 状态文本本地化
  - 实现：状态转换为中文描述（就绪/忙碌/离线/缺纸）

**完成标准**：
- [ ] USB列表显示设备名称（如"USB001 - Canon iP7200"）
- [ ] 状态信息清晰准确

---

### 🔄 阶段六：增强网络打印枚举（预定义+对话框配置）
**任务状态**：⏳ 待开始
**预计时间**：30-40分钟
**复杂度**：中等

#### 任务列表：
- [ ] 6.1 保留现有基础
  - 文件：`Transport\NetworkPrintTransport.cpp`
  - 保持：预定义列表（127.0.0.1:9100, 192.168.1.100:9100）

- [ ] 6.2 新增连接状态检测
  - 新增方法：ScanNetworkPrintersWithInfo()
  - 功能：TCP连接测试（1000ms超时）

- [ ] 6.3 集成配置对话框
  - 文件：`src\PortConfigPresenter.cpp`
  - 修改：UpdateNetworkPrintPortParameters()
  - 功能：添加"[配置网络打印机...]"选项

**完成标准**：
- [ ] 网络端口列表显示连通性状态
- [ ] 配置对话框可以正常添加自定义打印机

---

### 🔄 阶段七：实现统一异步端口扫描框架
**任务状态**：⏳ 待开始
**预计时间**：50-60分钟
**复杂度**：高

#### 任务列表：
- [ ] 7.1 端口扫描管理器
  - 文件：`src\PortConfigPresenter.h`
  - 新增类：PortScanner
  - 功能：异步扫描接口、进度回调、完成回调

- [ ] 7.2 异步扫描实现
  - 文件：`src\PortConfigPresenter.cpp`
  - 功能：后台线程扫描、UI立即响应、消息机制更新

- [ ] 7.3 消息处理机制
  - 文件：`src\PortMasterDlg.h/.cpp`
  - 新增消息：WM_UPDATE_USB_PORTS等
  - 功能：线程安全UI更新

**完成标准**：
- [ ] 扫描过程UI不阻塞
- [ ] 状态栏实时显示进度
- [ ] 扫描完成后正确更新列表

---

### 🔄 阶段八：集成状态栏进度反馈
**任务状态**：⏳ 待开始
**预计时间**：15-20分钟
**复杂度**：低

#### 任务列表：
- [ ] 8.1 状态栏消息规范
  - 文件：`src\StatusDisplayManager.h`
  - 新增方法：UpdateScanStatus(), UpdateConnectionStatus()

- [ ] 8.2 消息内容定义
  - 扫描阶段：开始、进行中、完成、失败
  - 连接阶段：轻量检测、错误提示

**完成标准**：
- [ ] 状态栏消息准确反映当前操作
- [ ] 用户可以清晰了解操作进度

---

### 🔄 阶段九：优化所有端口类型的显示格式
**任务状态**：⏳ 待开始
**预计时间**：20-30分钟
**复杂度**：低

#### 任务列表：
- [ ] 9.1 统一显示格式
  - 已连接：端口名 - 设备名 (已连接)
  - 未连接：端口名 (未连接)
  - 忙碌：端口名 - 设备名 (已连接，忙碌)

- [ ] 9.2 默认选择逻辑
  - 优先选择已连接设备
  - 其次选择可用设备
  - 最后选择第一个设备

**完成标准**：
- [ ] 所有端口类型显示格式统一
- [ ] 默认选择逻辑正确

---

### 🔄 阶段十：实现连接状态重检与重试机制
**任务状态**：⏳ 待开始
**预计时间**：30-40分钟
**复杂度**：中等

#### 任务列表：
- [ ] 10.1 轻量级检测实现
  - 文件：`src\PortMasterDlg.cpp`
  - 新增方法：QuickCheckPortStatus()
  - 功能：500ms超时检测、各端口类型检测

- [ ] 10.2 连接按钮处理
  - 修改：OnBnClickedButtonConnect()
  - 功能：轻量检测、错误提示、保持按钮启用

**完成标准**：
- [ ] 连接按钮始终启用
- [ ] 错误提示明确准确
- [ ] 重检机制正常工作

---

### 🔄 阶段十一：编译验证与功能测试
**任务状态**：⏳ 待开始
**预计时间**：30-40分钟
**复杂度**：-

#### 任务列表：
- [ ] 11.1 编译验证
  - 验证编译无错误、无警告
  - 确认链接成功，生成PortMaster.exe

- [ ] 11.2 功能测试（5种端口类型）
  - 串口测试：扫描、设备描述、默认选择、连接重检
  - 并口测试：扫描、设备信息、错误提示
  - USB测试：扫描、设备名称、状态检测
  - 网络打印测试：预设检测、配置对话框、连接测试
  - 回路测试：无扫描、连接功能

- [ ] 11.3 性能测试
  - 扫描总时间 ≤ 10秒
  - UI响应时间 ≤ 50ms
  - 内存占用增长 ≤ 10MB

**完成标准**：
- [ ] 所有测试用例通过
- [ ] 性能指标达标
- [ ] 编译验证通过

---

### 🔄 阶段十二：文档更新与任务总结
**任务状态**：⏳ 待开始
**预计时间**：15-20分钟
**复杂度**：低

#### 任务列表：
- [ ] 12.1 技术文档更新
  - 文件：`docs/修订工作记录*.md`
  - 内容：问题描述、解决方案、修改清单、测试结果

- [ ] 12.2 代码注释更新
  - 关键方法添加详细注释
  - 异步扫描流程说明

**完成标准**：
- [ ] 文档内容完整准确
- [ ] 代码注释清晰

---

## 📊 总进度追踪

| 阶段 | 任务 | 状态 | 开始时间 | 完成时间 | 编译状态 |
|------|------|------|----------|----------|----------|
| 一 | 需求分析与设计 | ✅ 完成 | - | - | - |
| 二 | 网络打印机配置对话框 | ⏳ 待开始 | - | - | - |
| 三 | 增强串口枚举 | ⏳ 待开始 | - | - | - |
| 四 | 增强并口枚举 | ⏳ 待开始 | - | - | - |
| 五 | 增强USB打印枚举 | ⏳ 待开始 | - | - | - |
| 六 | 增强网络打印枚举 | ⏳ 待开始 | - | - | - |
| 七 | 统一异步端口扫描框架 | ⏳ 待开始 | - | - | - |
| 八 | 状态栏进度反馈 | ⏳ 待开始 | - | - | - |
| 九 | 显示格式优化 | ⏳ 待开始 | - | - | - |
| 十 | 连接状态重检机制 | ⏳ 待开始 | - | - | - |
| 十一 | 编译验证与功能测试 | ⏳ 待开始 | - | - | - |
| 十二 | 文档更新与任务总结 | ⏳ 待开始 | - | - | - |

**总体进度**：0/12 阶段完成 (0%)

---

## 🎯 验收标准

### 功能验收
- [ ] 切换端口类型时自动扫描
- [ ] 状态栏实时显示扫描进度
- [ ] 端口列表显示设备信息
- [ ] 连接按钮始终启用
- [ ] 轻量级重检机制正常工作
- [ ] 错误提示信息准确明确
- [ ] 网络打印机配置对话框功能正常

### 性能验收
- [ ] 扫描总时间 ≤ 10秒
- [ ] UI响应时间 ≤ 50ms
- [ ] 内存占用增长 ≤ 10MB
- [ ] 编译0错误0警告

### 质量验收
- [ ] 扫描失败有回退机制
- [ ] 错误处理完善（超时、权限等）
- [ ] 线程安全（异步扫描）
- [ ] 资源正确释放（无内存泄漏）

---

## 📝 执行日志

### 日志记录格式
```
[时间] [阶段X.Y] [任务描述] - [结果]
[时间] [编译验证] - [状态]
```

### 关键里程碑
- [ ] 完成第一个阶段任务（阶段二）
- [ ] 完成50%任务（阶段七后）
- [ ] 完成编译验证
- [ ] 完成所有功能测试
- [ ] 完成全部12个阶段

---

## 🔄 修订版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-10-29 | 初始版本创建 | Claude Code |

---

**注**：本修订任务计划将根据执行过程中的实际情况进行动态调整和优化。
