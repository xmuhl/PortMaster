# PortMaster 项目核心功能分析与修订报告 (V3.0)

**编制日期**: 2025-09-29  
**编制依据**: 《项目核心功能验证报告.md》复核结论及最新源码检查

---

## 1. 本轮复核结论
- 可靠传输协议核心逻辑（发送线程、窗口管理、ACK/NAK 处理）在当前代码中已实现，原先“空壳”判断不再成立。
- 配置管理模块能够读写串口、并口、USB、网络、回环、协议及 UI 等配置段，原结论“仅支持串口+UI”不准确。
- 各传输通道（并口/USB/网络）均包含真实的系统调用与错误处理，非占位实现；需要关注的重点转向可靠性细节。
- 原报告列出的次要问题（任务调度与 UI 耦合、日志简单、高级 UI 功能缺失）仍然存在，与代码现状一致。
- 新增需优先整改的风险：可靠模式在普通发送路径未触发握手；网络发送未处理部分写入；UI 线程仍直接驱动长时间传输循环。

---

## 2. 核心功能核验要点

### 2.1 可靠传输协议现状
- `ReliableChannel::SendThread()` 会阻塞等待队列数据并调用 `SendPacket()` 发送，随后由 `ProcessThread()`、`ProcessDataFrame()` 和 `ProcessAckFrame()` 负责滑动窗口、ACK/NAK、统计更新，逻辑完整 (Protocol/ReliableChannel.cpp:732, Protocol/ReliableChannel.cpp:600, Protocol/ReliableChannel.cpp:1021, Protocol/ReliableChannel.cpp:1100)。
- `SendStart()` 控制帧编码与窗口登记均已实现，并在 `SendFile()` 调用链中触发握手 (Protocol/ReliableChannel.cpp:356, Protocol/ReliableChannel.cpp:1503)。
- `ReliableChannel::Send()` 仅在会话已连接的前提下将数据压入队列，不会主动发起握手或校验会话状态 (Protocol/ReliableChannel.cpp:233)。

### 2.2 配置管理模块
- `SerializeToJson()` / `DeserializeFromJson()` 针对 `parallel`、`usb`、`network`、`loopback`、`protocol` 及 `ui` 等段落逐项序列化/反序列化 (Common/ConfigStore.cpp:733-844, Common/ConfigStore.cpp:870-916)。
- 当前实现能够保持多端口参数、协议窗口/超时设置与界面布局信息的一致性，满足持久化需求。

### 2.3 传输通道实现
- 并口：`QueryPortStatus()` 通过 `DeviceIoControl` 查询硬件状态，并在不支持 IOCTL 时回退到零字节写入检测 (Transport/ParallelTransport.cpp:644-707)。
- USB：同步写入直接调用 `WriteFile`，并在 `SetDeviceTimeouts()` 中尝试 COMM 超时、USB 专用 IOCTL 等多种策略 (Transport/UsbPrintTransport.cpp:167-179, Transport/UsbPrintTransport.cpp:430-681)。
- 网络：`Write()` 根据协议分派到 RAW/LPR/IPP，LPR 流程含控制文件与数据文件发送；但底层 `SendData()` 仅调用一次 `send()`，存在部分写入风险 (Transport/NetworkPrintTransport.cpp:211-244, Transport/NetworkPrintTransport.cpp:701-718, Transport/NetworkPrintTransport.cpp:770-831)。

### 2.4 次要问题复核
- `CPortMasterDlg::PerformDataTransmission()` 仍在 UI 线程内执行分块发送、暂停/恢复与重试控制，逻辑复杂且与界面强耦合 (src/PortMasterDlg.cpp:548-758)。
- 日志仍通过 `CPortMasterDlg::WriteLog` 直接写文件，未实现集中化或异步处理 (src/PortMasterDlg.cpp:80-95)。
- 资源文件 `PortMaster.rc` 未包含“配置导入/导出”“测试向导”等扩展控件 (resources/PortMaster.rc:92-146)。
- 应用启动流程未实现 Splash 逻辑 (src/PortMaster.cpp:40-90)。

---

## 3. 需优先修复的问题与建议

### 3.1 可靠模式握手覆盖不足 (优先级 P0)
- **问题**: 普通文本发送通过 `ReliableChannel::Send()` 直接入队，无 START/ACK 握手，导致可靠模式在常见场景下形同虚设。
- **建议**: 在 `Send()` 进入队列前，检测握手状态；若尚未完成则自动执行握手流程（可封装为内部 `EnsureSessionStarted()`），或在 UI 层调用前明确触发一次 `SendFile` 风格握手。需配合超时与失败回滚处理。

### 3.2 网络发送缺乏部分写入处理 (优先级 P0)
- **问题**: `SendData()` 未循环发送，`send()` 返回小于请求长度时会导致数据截断。
- **建议**: 改为 `while (bytesSent < size)` 循环，结合超时、错误码（如 `WSAEWOULDBLOCK`）处理，并在失败时执行重连或错误上报。同步更新统计数据与日志。

### 3.3 传输任务与 UI 耦合 (优先级 P1)
- **问题**: UI 线程直接承担长时间循环，暂停/取消依赖成员变量轮询，易造成界面卡顿或状态不一致。
- **建议**: 抽象轻量级任务控制类（例如 `TransmissionTask`），由后台线程执行分块与重试，UI 仅发送控制指令和接收进度回调。短期也可将循环逻辑剥离到私有方法并以 `std::future`/线程管理代替直接在消息回调中执行。

---

## 4. 其他改进建议
- 为可靠/网络通道补充针对错误场景的单元测试或集成用例，验证握手失效、部分写入、重试超时等路径。
- 在日志模块中引入基础等级筛选与异步缓冲，避免高频 IO 对传输线程造成影响。
- 评估添加配置导入/导出与传输模板功能，以提升测试效率。

---

## 5. 测试说明
- 本轮仅进行静态代码审查，未运行自动化或手工功能测试；建议在完成上述修复后补充相关测试验证。
