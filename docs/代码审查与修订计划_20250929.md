# 代码审查与修订计划（重生成版）

日期：2025-09-29
适用范围：PortMaster 全工程（协议层 + UI层）

## 1. 背景与目标

基于两份分析报告（PortMaster_Data_Loss_And_Slow_Speed_Analysis.md、可靠模式接收窗口问题分析报告.md），重新输出可执行的修订计划，用于：

- 核实问题与结论的准确性与完整性
- 明确分层修复方案与具体代码改动点
- 给出验证与测试清单，确保修复后 0 error / 0 warning、功能与性能达标

## 2. 核查结论（确认）

- 报告2结论成立：可靠模式接收窗口空白、速度慢、保存失败的根因是握手后未重置滑动窗口基准（m_receiveBase / m_receiveNext）。ReliableChannel.cpp::ProcessStartFrame 未设置窗口基准，导致 IsSequenceInWindow 判定“出窗”，触发持续 NAK 与重传，队列空、缓存空，UI与保存逻辑无数据。
- 报告1结论部分成立：可靠模式接收路径不会忙等（Receive 使用条件变量与超时等待）；但原始/直通模式下，当 m_transport->Read 返回 0 时 UI层 while(m_isConnected) 存在轻微忙等风险，可能导致 CPU 占用偏高与界面空闲时抖动。应在无数据时加入小睡眠。

## 3. 修订方案与代码改动

P0（必须修）：协议层可靠模式

1) Protocol/ReliableChannel.cpp::ProcessStartFrame

- 在成功解析 Start 帧后，重置接收窗口基准：m_receiveBase、m_receiveNext（按协议约定设置为对端起始序号或 0），并清理/初始化相关队列与计数。
- 发送 ACK 后，保证窗口状态与会话状态一致（必要时调用 EnsureSessionStarted）。

2) Protocol/ReliableChannel.cpp::EnsureSessionStarted

- 当会话从未启动→启动时，同步设置/校验 m_receiveBase、m_receiveNext，避免竞态。

3) Protocol/ReliableChannel.h/.cpp（窗口判定与同步）

- 复核 IsSequenceInWindow：
  - 处理边界与环绕（序号取模）
  - 包含窗口起点与末端的正确性
- 如协议需要，确保 m_sendBase / m_sendNext 在会话建立后与接收窗口参数一致或完成必要协商。

4) 诊断与日志（受控级别）

- 在窗口重置、入队/出队、ACK/NAK 处打印关键字段（seq、base、next、window、queue size），并通过配置开关控制日志量。

P1（建议修）：UI层与直通模式

1) src/PortMasterDlg.cpp::StartReceiveThread

- 原始/直通路径：当 m_transport->Read 返回 0 时，在循环中加入 std::this_thread::sleep_for(2~5ms)，降低空转与CPU占用；可靠模式路径保持条件变量等待，不加睡眠。

2) src/PortMasterDlg.cpp::UpdateSaveButtonStatus

- 在可靠模式下，仅在 IsFileTransferActive 且缓存未完整写入时禁用保存；一旦收到完整数据或缓存非空，允许保存以避免“看起来不可保存”的误判。

3) src/PortMasterDlg.cpp::OnBnClickedButtonSaveAll

- 将“保存可用状态”与实际写入结果绑定：
  - 保存前再次读取临时缓存最新内容（用户确认后）
  - 写入失败时明确提示并提供重试选项

4) src/PortMasterDlg.cpp::ThreadSafeAppendReceiveData

- 复核 m_tempCacheFile 流状态：
  - 发现 fail()/bad() 或保存后句柄关闭时，自动恢复文件流并定位到末尾再追加
  - 保持 flush()，确保及时落盘

## 4. 验证与测试

- 功能测试：
  - 可靠模式：小/大文件、乱序、丢包、窗口重置后正常接收
  - 原始模式：空闲场景与低速传输，无忙等导致的高CPU
- 回归测试：
  - 保存完整性与统计一致性（VerifySavedFileSize / VerifyTempCacheFileIntegrity）
  - UI按钮状态联动（UpdateSaveButtonStatus）
- 压测：长时间传输，观察 CPU/内存/队列增长与日志量
- 自动化脚本：
  - verify_reliable_protocol.py（窗口与握手）
  - verify_save_integrity.py（缓存与保存）
- 构建验证：优先执行 autobuild_x86_debug.bat，确保 0 warning / 0 error；失败则执行 autobuild.bat。

## 5. 风险与回滚

- 协议窗口重置影响发送端协商：必要时在 Start→ACK 阶段补充“窗口参数确认”，避免两端窗口不一致。
- UI层加入睡眠可能略微影响空闲时的响应性：可通过配置项调整睡眠时长或禁用。
- 日志量增大：通过级别与开关控制，调试期开启、发布期降级。

## 6. 实施顺序

1) 协议层（P0）优先落地并基本自测通过
2) UI层与直通模式优化（P1）
3) 全量回归与自动化脚本验证
4) 形成修订记录与最终结论

## 7. 提交与记录

- 提交信息格式建议：
  - fix: 可靠模式窗口重置与接收性能优化
  - refactor: 保存按钮联动与缓存流恢复
- 文档同步：更新 docs/问题跟踪.md 与 docs/修订工作记录YYYYMMDD-HHMMSS.md（含目标、计划、执行与总结）

## 8. 具体修改点清单（便于开发执行）

- Protocol/ReliableChannel.cpp::ProcessStartFrame（重置 m_receiveBase/m_receiveNext、队列初始化、ACK后状态一致）
- Protocol/ReliableChannel.cpp::EnsureSessionStarted（会话启动时同步窗口基准）
- Protocol/ReliableChannel.h/.cpp::IsSequenceInWindow、m_receiveBase、m_receiveNext、m_sendBase、m_sendNext（边界与环绕校验）
- src/PortMasterDlg.cpp::StartReceiveThread（原始路径加入小睡眠）
- src/PortMasterDlg.cpp::UpdateSaveButtonStatus（可靠模式下的使能逻辑）
- src/PortMasterDlg.cpp::OnBnClickedButtonSaveAll（保存前后流程与失败重试）
- src/PortMasterDlg.cpp::ThreadSafeAppendReceiveData（流状态恢复与 flush）

——
若需我直接按上述清单修改代码并执行构建与验证，请告知先后顺序与优先级。
