# 故障诊断报告（进度条闪烁、保存按钮禁用、后台日志增长）

**报告日期**: 2025-10-13  
**参考记录**: `docs/修订工作记录20251013-164035.md`  
**实时日志**: `build/Debug/PortMaster_debug.log`

---

## 1. 问题现象

- 进度条显示异常：主进度条能正常前进，但持续出现闪烁或“被覆盖”的视觉问题。
- 文件传输完成后，“保存”按钮仍处于禁用状态，无法操作；即使手动触发后也提示“没有数据可保存”。
- 程序运行期间，后台日志文件体积持续增加（即使空闲）。

---

## 2. 原因分析（结合源代码与日志）

### 2.1 进度条闪烁/覆盖

- 双路更新竞争同一控件：
  - 传输任务路径（消息队列，UI线程安全）：`OnTransmissionProgress()` → `PostMessage(WM_USER + 11, 0, percent)` → `OnTransmissionProgressUpdate()` → `m_progress.SetPos(percent)`（`src/PortMasterDlg.cpp:640-740, 3860-3920`）。
  - 可靠通道回调路径（可能在非UI线程）：`OnReliableProgress()` 直接调用 `m_progress.SetPos(percent)`（`src/PortMasterDlg.cpp:3602-3700`）。
  - 两条路径同时更新同一控件 `m_progress`，其中一条可能不在 UI 线程执行，造成绘制竞争与重入刷新，表现为闪烁或被“覆盖”。
- 进度来源节奏不同步：发送侧 ACK 驱动与接收侧窗口推进节奏不同，进度值短时间内来回跳变，进一步加剧闪烁。
- 日志旁证：实时日志中存在高频 UI 更新记录（“轻量级UI更新信息”及进度消息），显示 UI 更新触发频繁。

### 2.2 保存按钮禁用与“没有数据可保存”

- 入口判定过于严格：
  - `UpdateSaveButtonStatus()` 仅在 `isReliableMode && m_reliableChannel && m_isConnected` 为真时进行可靠模式分支（`src/PortMasterDlg.cpp:3521-3580`）。
  - 传输完成后若 `m_isConnected` 被其他路径短暂重置或不一致，则可能跳过可靠分支，导致状态未刷新。
- 数据源判定依赖不可靠统计：
  - 临时缓存可用性依赖 `m_totalReceivedBytes > 0`（`src/PortMasterDlg.cpp:2703-2760`），但清理路径 `ClearTempCacheFile()` 会重置该统计为 0（`src/PortMasterDlg.cpp:4682-4710`），导致误判“无数据”。
  - 尽管临时文件可能已写入数据，但因统计为 0 → 判定为不可保存，用户看到“保存”禁用或点击后提示“没有数据可保存”（`src/PortMasterDlg.cpp:2943-2951`）。
- 稳定性等待导致延迟：
  - 保存流程调用 `WaitForReceiveDataStability()`（5 次×80ms），总等待约 400ms（`src/PortMasterDlg.cpp:2745-2830`）。如果文件刷新/统计未及时同步，会延长按钮启用时间或仍判为不可用。
- 旁证：日志与用户反馈表明传输完成后存在数秒延迟，且保存提示“没有数据可保存”，符合上述逻辑组合。

### 2.3 后台日志持续增长

- Debug 下默认启用详细协议日志：在多处创建可靠通道时调用 `SetVerboseLoggingEnabled(true)`（`src/PortMasterDlg.cpp:3140-3420`），协议线程在空闲仍持续输出（`Protocol/ReliableChannel.cpp:760-1320`）。
- UI 层“轻量级UI更新信息”不受节流控制：`OnTransportDataReceivedMessage` 中大量日志直接输出（`src/PortMasterDlg.cpp:3860-3920`），即使数据量较大也会持续写入。
- 即便已实施部分“节流日志”，空闲周期仍有心跳与周期性输出，从日志样例可见 `[节流日志]` 每 500ms/1000ms 输出一次，但总量仍随时间增长。

---

## 3. 代码定位摘要

- 进度更新双路竞争：
  - `OnTransmissionProgress()` → `PostMessage(WM_USER + 11, 0, percent)`（`src/PortMasterDlg.cpp:701-723`）。
  - `OnTransmissionProgressUpdate()` → `m_progress.SetPos((int)lParam)`（`src/PortMasterDlg.cpp:3904-3907`）。
  - `OnReliableProgress()` → `m_progress.SetPos(percent)`（`src/PortMasterDlg.cpp:3673-3699`）。
- 保存按钮状态与数据源判定：
  - `UpdateSaveButtonStatus()` 条件与分支（`src/PortMasterDlg.cpp:3521-3601`）。
  - 临时缓存可用性与保存流程（`src/PortMasterDlg.cpp:2703-2960`）。
  - 清理路径重置统计与截断文件（`src/PortMasterDlg.cpp:4660-4745`）。
- 日志输出路径：
  - 可靠通道详细日志开启点（`src/PortMasterDlg.cpp:3140-3420`）。
  - 协议层线程日志（处理/接收/心跳）（`Protocol/ReliableChannel.cpp:760-1320`）。
  - UI层“轻量级UI更新信息”日志（`src/PortMasterDlg.cpp:3860-3920`）。

---

## 4. 解决方案建议（本次仅建议，未改代码）

### 4.1 进度条闪烁修复
- 统一进度更新到消息队列（UI线程）：
  - 将 `OnReliableProgress()` 内的 `m_progress.SetPos(percent)` 改为 `PostMessage(WM_USER + 11, 0, percent)`，与传输任务一致，避免非 UI 线程直接触控控件。
- 进度来源去重与节流：
  - 明确仅显示“接收侧实际落盘进度”，忽略“发送侧 ACK 驱动”的百分比；或在 UI 层加单调性保护，避免倒退与大幅跳变。

### 4.2 保存按钮禁用与“无数据”修复
- 放宽入口判定：
  - `UpdateSaveButtonStatus()` 可靠分支入口移除 `m_isConnected` 约束，只要 `m_reliableChannel` 存在即可判断（传输完成后仍需保存）。
- 以文件大小为主依据：
  - `tempFileAvailable = PathFileExists && (GetTempCacheFileSize() > 0)`，避免依赖可能被重置的 `m_totalReceivedBytes`。
- 快速路径优化（传输完成时）：
  - `OnReliableComplete()` 先检查 `GetTempCacheFileSize()`，有数据则立即启用保存并跳过重试；无数据再回退到定时器重试与稳定性等待。
- 明确交互与提示：
  - “清空接收/停止传输”操作应提示会重置统计并影响保存；保存入口可提供“立即保存/等待稳定后保存”选项。

### 4.3 后台日志增长抑制
- 在 Debug 环境下可保持详细日志，但增加开关：
  - 在创建可靠通道后根据配置文件或 UI 开关控制 `SetVerboseLoggingEnabled`。
- 对 UI 层“轻量级UI更新信息”添加节流或级别控制：
  - 仅在关键进度（如每 10% 或每 N MB）输出，减少噪声。
- 协议层空闲日志节流进一步扩大周期：
  - 接收/处理线程空闲输出间隔提升（>1000ms），心跳日志仅在异常时输出。

---

## 5. 验证与风险提示

- 验证重点：
  - 大文件回路测试下，进度条是否稳定无闪烁；状态文本是否无重复；传输完成后保存按钮是否立即可用并可保存完整数据。
- 风险提示：
  - 若仍保留清空接收数据的快捷操作，应谨慎避免在保存前执行，以免误判“无数据”。
  - 在极端磁盘或缓存延迟下，`GetTempCacheFileSize()` 可能略滞后，快速路径仍需允许回退到重试机制。

---

## 6. 结论

- 进度闪烁的核心根因是非 UI 线程直接更新控件与双来源竞争，需统一到消息队列并去重来源。
- 保存按钮禁用与“无数据”源于入口条件与统计依赖不当，建议以文件大小为主依据并优化快速路径。
- 后台日志增长源于详细日志常开与 UI 侧高频输出，建议增加开关与节流策略。

（本次仅提交分析报告，未进行代码修改。）