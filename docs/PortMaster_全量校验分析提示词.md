# PortMaster 项目全量校验分析提示词

## 角色定义

你是一名精通 Windows C++/MFC 开发、代码质量审查和项目测试的高级软件工程师。你的任务是对 **PortMaster（端口大师）** 项目进行全面的代码审查、质量分析和缺陷检测,并生成详细的分析报告。

---

## 分析目标与范围

### 目标
对 PortMaster 项目的所有源代码、资源文件、配置文件和构建脚本进行全量校验分析,识别并定位所有潜在问题,提供可执行的修复方案,并在修复后进行二次验证。

### 范围
项目工作目录：`C:\Users\huangl\Desktop\PortMaster`（或对应的 WSL 路径）

审查内容包括但不限于：
- 所有 C++/MFC 源代码文件（.cpp, .h）
- 资源文件（.rc, .rc2）和资源头文件
- 项目配置文件（.vcxproj, .sln）
- 构建脚本（.bat）
- 配置管理代码（JSON 处理）
- 文档文件（.md）

---

## 审查维度与检测项

### 1. 语法错误检测

#### 1.1 编译器错误
- **检测项**：
  - C++ 语法错误（未闭合括号、缺少分号、类型不匹配等）
  - MFC 特定语法错误（消息映射、DDX/DDV 宏使用错误等）
  - 头文件包含错误或循环依赖
  - 链接错误（未定义符号、重复定义等）
- **定位要求**：精确到文件名、行号、具体代码片段
- **解决方案要求**：提供修正后的代码,说明修改理由

#### 1.2 编译器警告
- **检测项**：
  - 未使用的变量、参数、函数
  - 隐式类型转换（可能导致数据丢失）
  - 未初始化的变量
  - 符号的可见性问题
  - 弃用的 API 调用
- **定位要求**：精确到文件名、行号
- **解决方案要求**：消除所有警告,确保达到零警告标准

#### 1.3 编码规范违规
- **检测项**：
  - 文件编码是否为 UTF-8 带 BOM
  - 是否正确使用 `#pragma execution_character_set("utf-8")`
  - 字符串字面量是否使用中文（符合要求）
  - 注释是否使用中文
- **定位要求**：列出所有不符合规范的文件
- **解决方案要求**：提供编码转换或修正方案

---

### 2. 逻辑错误检测

#### 2.1 控制流错误
- **检测项**：
  - 空指针解引用风险
  - 数组越界访问
  - 资源泄漏（内存、句柄、GDI 对象等）
  - 死锁风险（互斥锁、临界区使用不当）
  - 无限循环或递归
  - 未处理的异常路径
  - 条件判断逻辑错误（恒真/恒假条件）
- **定位要求**：标注具体函数、代码行
- **解决方案要求**：提供修正逻辑,增加必要的边界检查和错误处理

#### 2.2 数据处理错误
- **检测项**：
  - 缓冲区溢出风险
  - 整数溢出/下溢
  - 浮点数比较错误
  - 字符串处理不当（strcpy 替代为 strcpy_s 等）
  - 字节序处理错误（小端要求）
  - 编码转换错误（UTF-8 与 Unicode 互转）
- **定位要求**：标注函数名、代码行、问题数据类型
- **解决方案要求**：使用安全函数,增加数据验证

#### 2.3 并发与同步错误
- **检测项**：
  - 多线程访问共享资源未加锁
  - OVERLAPPED I/O 使用不当
  - 事件/信号量使用错误
  - 线程安全问题（如 UI 线程与工作线程交互）
- **定位要求**：标注相关类、函数、成员变量
- **解决方案要求**：添加适当的同步机制,确保线程安全

---

### 3. 功能实现错误

#### 3.1 端口操作实现
- **检测项**：
  - **串口**：CreateFile、SetCommState、OVERLAPPED I/O 是否正确实现
  - **并口/USB**：句柄操作、DeviceIoControl 调用是否正确
  - **网络打印**：Socket 连接、RAW 9100/LPR/IPP 协议实现是否完整
  - **回路测试**：虚拟端口逻辑是否正确,统计功能是否有效
  - 端口占用检测是否准确
  - 读写超时设置是否生效
  - 错误处理是否完善
- **定位要求**：标注对应的 Transport 实现类和方法
- **解决方案要求**：依据 Windows API 文档和项目规格修正

#### 3.2 可靠传输协议实现
- **检测项**：
  - 帧格式是否符合规格（包头 0xAA55、包尾 0x55AA）
  - CRC32 计算是否正确（多项式 0xEDB88320,初始值 0xFFFFFFFF）
  - 帧类型定义是否完整（START/DATA/END/ACK/NAK）
  - 序号管理是否正确（溢出处理）
  - 状态机实现是否严格遵循设计（发送端、接收端状态转换）
  - ACK/NAK 响应逻辑是否正确
  - 超时重传机制是否有效
  - 粘包/半包处理是否完善
  - START 元数据解析是否正确（文件名、大小、时间戳）
- **定位要求**：标注 ReliableChannel、FrameCodec、CRC32 相关代码
- **解决方案要求**：修正协议实现,确保与设计规格一致

#### 3.3 UI 交互逻辑
- **检测项**：
  - 端口类切换时参数面板是否正确更新
  - "发送" → "暂停" → "继续" 按钮状态切换是否正确
  - "停止" 按钮是否在所有状态下都能正确终止传输
  - 十六进制复选框是否同步控制发送和接收窗口
  - 文件拖放功能是否正常（单文件限制、大文件处理）
  - "清空"、"清除"、"复制"、"保存" 按钮功能是否完整
  - 日志窗口是否正确记录操作和错误
  - 状态栏统计信息是否实时更新
  - 进度条显示是否准确
- **定位要求**：标注对话框类、消息处理函数、DDX 变量
- **解决方案要求**：修正控件状态更新逻辑,确保 UI 响应正确

#### 3.4 配置管理
- **检测项**：
  - JSON 配置文件读写是否正确
  - 配置项是否完整（所有端口类型的参数）
  - 配置保存路径逻辑是否正确（程序目录 → LOCALAPPDATA 回退）
  - 配置加载失败时的默认值处理
  - UI 状态（窗口大小、最近文件列表）持久化是否有效
- **定位要求**：标注 ConfigStore 类及相关函数
- **解决方案要求**：修正 JSON 解析逻辑,确保配置可靠

---

### 4. 交互响应错误

#### 4.1 UI 响应性
- **检测项**：
  - 长时间操作是否阻塞 UI 线程（大文件发送、网络连接等）
  - 是否使用后台线程处理耗时操作
  - 进度反馈是否及时
  - 按钮禁用/启用逻辑是否正确
  - 窗口卡顿或无响应的潜在风险
- **定位要求**：标注可能阻塞的操作
- **解决方案要求**：将耗时操作移至工作线程,使用消息通知更新 UI

#### 4.2 用户输入验证
- **检测项**：
  - 端口号、波特率等参数输入是否验证
  - IP 地址、端口号格式验证
  - 文件路径有效性检查
  - 非法输入的错误提示是否友好
- **定位要求**：标注输入验证相关代码
- **解决方案要求**：增加输入验证逻辑,提供明确的错误提示

#### 4.3 错误提示
- **检测项**：
  - 错误消息是否清晰、准确、中文化
  - 是否提供可操作的建议（如端口占用时提示重试）
  - 日志记录是否完整覆盖关键操作和错误
- **定位要求**：标注错误处理和日志记录代码
- **解决方案要求**：优化错误消息,增加详细的日志记录

---

### 5. 虚假开发检测

#### 5.1 未实现功能
- **检测项**：
  - 声明但未实现的函数（空函数体或仅返回固定值）
  - UI 控件关联了事件处理函数但函数内部为空
  - 配置项定义但未真正使用
  - 协议中定义的功能未实际实现（如断点续传、动态超时等）
- **定位要求**：列出所有虚假实现的函数和功能
- **解决方案要求**：补全实现或移除虚假声明

#### 5.2 桩代码（Stub）
- **检测项**：
  - TODO/FIXME 标记的代码
  - 硬编码的测试数据或返回值
  - 被注释掉但应该启用的关键代码
- **定位要求**：列出所有桩代码位置
- **解决方案要求**：完成实现或说明保留原因

#### 5.3 不可达代码
- **检测项**：
  - 永远不会执行的分支
  - 定义但从未调用的函数
  - 冗余的条件判断
- **定位要求**：标注不可达代码位置
- **解决方案要求**：移除或修正逻辑

---

### 6. 过度设计检测

#### 6.1 过度抽象
- **检测项**：
  - 不必要的接口层或抽象类
  - 过度使用设计模式导致代码复杂化
  - 仅有一个实现的接口
  - 层次过深的类继承
- **定位要求**：标注过度抽象的类和接口
- **解决方案要求**：简化设计,保持 KISS 原则

#### 6.2 冗余代码
- **检测项**：
  - 重复的代码块（应提取为公共函数）
  - 功能重叠的类或函数
  - 未使用的类、函数、变量
  - 冗余的头文件包含
- **定位要求**：列出所有冗余代码
- **解决方案要求**：重构消除冗余,提高代码复用性

#### 6.3 过度优化
- **检测项**：
  - 在非关键路径上进行的复杂优化
  - 牺牲可读性的微优化
  - 不必要的缓存或预处理
- **定位要求**：标注过度优化的代码
- **解决方案要求**：简化为清晰易懂的实现

---

### 7. 架构与设计符合性

#### 7.1 分层架构
- **检测项**：
  - 是否遵循 Application → Protocol → Transport → Hardware 分层
  - 层与层之间的依赖是否正确（不应出现反向依赖）
  - 接口定义是否清晰（ITransport 实现是否一致）
- **定位要求**：标注架构违规的类和依赖关系
- **解决方案要求**：调整类结构,确保分层清晰

#### 7.2 模块职责
- **检测项**：
  - 每个类的职责是否单一明确
  - UI 层是否混杂业务逻辑
  - Transport 层是否包含协议处理逻辑（应在 Protocol 层）
- **定位要求**：标注职责不清的类
- **解决方案要求**：重构分离职责

---

### 8. 兼容性与平台要求

#### 8.1 Windows 版本兼容
- **检测项**：
  - 是否使用了 Win7 不支持的 API
  - 是否有条件编译以回退旧 API
  - x86 与 x64 编译是否都正确
- **定位要求**：标注兼容性问题代码
- **解决方案要求**：添加条件编译或使用兼容 API

#### 8.2 运行库链接
- **检测项**：
  - 是否正确配置静态链接运行库（/MT 或 /MTd）
  - 是否静态链接 MFC
  - 是否生成单一 EXE 文件
- **定位要求**：检查项目配置文件（.vcxproj）
- **解决方案要求**：修正项目配置

#### 8.3 资源集成
- **检测项**：
  - PortMaster_Icon.ico 是否正确集成并包含所需分辨率
  - PortMaster_Splash.png 是否正确加载和显示
  - 所有资源是否打包进 EXE
- **定位要求**：检查 .rc 文件和资源加载代码
- **解决方案要求**：修正资源配置和加载逻辑

---

### 9. 构建系统检查

#### 9.1 构建脚本
- **检测项**：
  - `autobuild_x86_debug.bat` 是否存在且可正常运行
  - `autobuild.bat` 是否正确配置所有构建配置
  - 脚本是否正确检测 Visual Studio 环境
  - 日志输出路径是否正确
- **定位要求**：标注脚本问题行
- **解决方案要求**：修正脚本逻辑,确保可靠构建

#### 9.2 构建输出
- **检测项**：
  - 是否达到零错误零警告标准
  - 日志文件（msbuild_*.log）是否正确生成
  - 输出目录是否符合预期
- **定位要求**：分析构建日志
- **解决方案要求**：修复所有构建问题

---

### 10. 文档与注释

#### 10.1 代码注释
- **检测项**：
  - 关键函数是否有注释说明
  - 复杂算法是否有注释
  - 注释是否准确（不与代码脱节）
  - 注释是否使用中文
- **定位要求**：标注缺少注释或注释错误的代码
- **解决方案要求**：补充或修正注释

#### 10.2 文档完整性
- **检测项**：
  - 是否存在总体设计说明
  - 是否有架构图和状态机图
  - 是否有手动测试指引
  - 是否有构建指南
- **定位要求**：列出缺失的文档
- **解决方案要求**：补充必要文档

---

## 分析流程

### 阶段一：环境准备与代码获取

1. **环境检测**
   - 识别当前运行环境（WSL 或 PowerShell）
   - 设置工作目录：`C:\Users\huangl\Desktop\PortMaster`
   - 验证目录结构和关键文件存在性

2. **代码同步**
   - 执行 `git pull --rebase` 获取最新代码
   - 确认当前分支和最新提交信息

3. **文件清单**
   - 遍历工作目录,列出所有待审查文件：
     - 源代码文件（.cpp, .h）
     - 资源文件（.rc, .rc2）
     - 项目配置文件（.vcxproj, .sln）
     - 构建脚本（.bat）
     - 文档文件（.md）

---

### 阶段二：系统性代码审查

按照上述 10 个维度逐一进行审查,对每个文件执行以下操作：

1. **静态分析**
   - 检查语法错误、编译警告
   - 分析代码逻辑和控制流
   - 检测资源泄漏和内存安全问题

2. **功能验证**
   - 对照设计规格检查实现完整性
   - 验证关键算法正确性（如 CRC32 计算）
   - 检查协议实现是否符合规范

3. **设计审查**
   - 评估架构分层合理性
   - 检查模块职责划分
   - 识别过度设计和虚假开发

4. **兼容性检查**
   - 验证 Windows 版本兼容性
  - 检查编码规范遵守情况
   - 确认资源集成正确性

---

### 阶段三：构建验证

1. **执行构建**
   - 优先运行 `autobuild_x86_debug.bat`
   - 如失败则运行 `autobuild.bat`
   - 记录构建输出和日志

2. **构建结果分析**
   - 检查 `msbuild_*.log` 文件
   - 统计错误和警告数量
   - 分析错误类型和位置

3. **零警告验证**
   - 确认是否达到零错误零警告标准
   - 对每个警告提供修复建议

---

### 阶段四：问题归类与定位

将所有检测到的问题按以下格式归类：

```
【问题编号】: PMQA-001
【问题类型】: 语法错误 / 逻辑错误 / 功能实现错误 / 交互响应错误 / 虚假开发 / 过度设计
【严重级别】: 致命 / 严重 / 一般 / 轻微
【问题描述】: 简要描述问题现象
【影响范围】: 受影响的功能或模块
【文件位置】: 文件路径
【代码位置】: 具体行号或代码片段
【问题分析】: 详细分析问题原因
【解决方案】: 提供可执行的修复方案
【修复代码】: 给出修正后的代码（如适用）
【验证方法】: 说明如何验证修复效果
```

---

### 阶段五：修复方案生成

对每个问题提供：

1. **修复代码**
   - 给出完整的修正代码
   - 标注修改部分
   - 说明修改理由

2. **修复步骤**
   - 详细的操作步骤
   - 必要的配置更改
   - 依赖的其他修复

3. **风险评估**
   - 修复可能带来的副作用
   - 需要额外测试的场景
   - 建议的验证方法

---

### 阶段六：二次校验

在提供修复方案后,进行二次校验：

1. **逻辑验证**
   - 模拟代码执行路径
   - 验证修复方案的正确性
   - 检查是否引入新问题

2. **一致性检查**
   - 确保修复与设计规格一致
   - 验证与其他模块的协调性
   - 检查编码规范符合性

3. **完整性确认**
   - 确认所有相关代码都已修正
   - 验证配套文档是否需要更新
   - 检查测试用例覆盖

---

### 阶段七：报告生成

生成详细的分析报告,包含以下章节：

#### 1. 执行摘要
- 审查时间和环境
- 审查范围和文件清单
- 问题总数统计（按类型和严重级别）
- 关键发现和建议

#### 2. 构建状态
- 构建脚本执行结果
- 编译错误和警告统计
- 构建日志关键片段

#### 3. 问题清单
按严重级别排序的完整问题列表,每个问题包含：
- 问题编号和类型
- 严重级别
- 问题描述
- 文件和代码位置
- 问题分析
- 解决方案
- 修复代码
- 验证方法

#### 4. 设计符合性评估
- 架构分层符合性
- 功能实现完整性
- 协议规范符合性
- 兼容性达标情况

#### 5. 代码质量评估
- 代码风格一致性
- 注释完整性
- 测试覆盖度
- 维护性评分

#### 6. 修复优先级建议
按紧急程度排列的修复顺序：
1. 致命问题（阻塞功能运行）
2. 严重问题（影响核心功能）
3. 一般问题（影响用户体验）
4. 轻微问题（优化项）

#### 7. 遗留问题与风险
- 暂时无法修复的问题
- 潜在的技术债务
- 未来版本改进建议

---

## 报告格式要求

报告使用 Markdown 格式,保存为：`PortMaster_全量校验分析报告_YYYYMMDD-HHMMSS.md`

报告应包含：
- 清晰的章节结构
- 使用表格汇总统计信息
- 代码片段使用代码块格式
- 重要内容使用加粗或高亮
- 适当使用列表和编号

---

## 特殊注意事项

### 1. 协议实现重点审查
可靠传输协议是项目核心,必须特别关注：
- CRC32 计算的每个参数（多项式、初始值、最终异或值）
- 帧格式的每个字节（包头、类型、序号、长度、CRC、数据、包尾）
- 状态机的每个状态转换条件
- ACK/NAK/超时的处理逻辑
- 粘包/半包的处理机制

### 2. 平台兼容性验证
- 所有 Windows API 调用必须检查 Win7 支持情况
- 条件编译宏是否正确使用
- 64位平台下的指针和整数转换

### 3. UI 线程安全
- 后台线程不得直接操作 UI 控件
- 必须使用 PostMessage/SendMessage 或 Invoke 机制
- 长时间操作必须在工作线程中执行

### 4. 资源管理
- 所有 new 必须有对应的 delete
- 所有 CreateFile/OpenFile 必须有 CloseHandle
- GDI 对象必须释放
- COM 对象必须 Release

### 5. 错误处理完整性
- 所有可能失败的操作必须检查返回值
- 必须提供清晰的错误消息
- 必须记录到日志
- 必须有合理的错误恢复策略

---

## 最终交付

完成分析后,交付以下内容：

1. **分析报告**：`PortMaster_全量校验分析报告_YYYYMMDD-HHMMSS.md`
2. **问题清单**：独立的问题列表文件（可选）
3. **修复补丁**：对每个问题的修复代码片段（可选）
4. **验证脚本**：自动化验证修复效果的脚本（可选）

报告保存路径：项目根目录或 Reports 子目录

---

## 执行示例

### 启动命令（示例）

```
请对 PortMaster 项目进行全量校验分析。工作目录位于 C:\Users\huangl\Desktop\PortMaster。
请严格按照"PortMaster_全量校验分析提示词.md"中的要求,执行系统性代码审查,
并生成详细的分析报告。报告应涵盖所有语法错误、逻辑错误、交互响应错误、
虚假开发、过度设计等问题,并为每个问题提供具体的文件位置、代码位置、
问题分析、解决方案和验证方法。在提供修复方案后,进行二次校验确认无误。
最终生成的报告保存为 Markdown 格式。
```

---

## 审查原则

1. **全面性**：不遗漏任何文件和问题
2. **准确性**：定位必须精确到行号
3. **可操作性**：解决方案必须具体可执行
4. **严格性**：按照项目规格严格审查
5. **二次验证**：修复方案必须经过逻辑验证

---

## 成功标准

分析报告被认为成功,当且仅当：

✅ 所有源代码文件都经过审查  
✅ 所有检测维度都已覆盖  
✅ 每个问题都有明确的定位和解决方案  
✅ 构建状态达到零错误零警告  
✅ 修复方案经过二次校验确认  
✅ 报告格式规范、内容完整  

---

**本提示词版本**：v1.0  
**生成日期**：2025-10-21  
**适用项目**：PortMaster（端口大师）  
**审查标准**：基于项目设计文档《PortMaster_项目开发.md》
