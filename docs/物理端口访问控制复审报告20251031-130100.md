# 物理端口访问控制复审报告（2025-10-31 13:01）

## 1. 审查范围与基线
- 参照 USB 打印端口修复成果，对并口、串口、网口访问控制的配置解析、权限校验、资源释放与异常防护进行比对。
- 重点关注端口选择正确性、句柄/套接字生命周期管理、错误日志与状态回调一致性。

## 2. USB 端口基线特征
- USB 传输优先使用实际设备路径，避免退回默认端口号（`Transport/UsbPrintTransport.cpp:82-123`）。
- 写入流程通过 `WriteFileProtected` 结合错误分类确保 SEH 与设备断链均被捕获（`Transport/UsbPrintTransport.cpp:639-727`）。
- 状态监控与异步线程在 `Close` 中统一回收，避免僵尸线程（`Transport/UsbPrintTransport.cpp:145-159`,`Transport/UsbPrintTransport.cpp:168-206`）。

## 3. 并口访问控制评估
### 3.1 现状概览
- 基于 `ParallelPortConfig` 的访问模式/共享模式配置，并在 `OpenPortHandle` 时记录调试信息（`Transport/ParallelTransport.h:17-37`,`Transport/ParallelTransport.cpp:662-705`）。
- 仅在启用双向模式时暴露读取接口，默认保持只写（`Transport/ParallelTransport.cpp:200-221`）。

### 3.2 主要问题
- **严重**：会话控制层未同步 `portName`，导致总是尝试打开默认 LPT1。`PortSessionController` 只写入 `deviceName` 而未刷新基类 `portName`，`ParallelTransport::Open` 又将 `deviceName` 重置为 `NormalizePortName(m_config.portName)`，最终忽略用户选择（`Protocol/PortSessionController.cpp:246-259`,`Transport/ParallelTransport.cpp:82-84`）。
- **中**：启用 `enableBidirectional` 时未自动切换访问权限。配置默认 `accessMode=GENERIC_WRITE`，即便允许读取也不会重新配置成 `GENERIC_READ | GENERIC_WRITE`，实际 `ReadFile` 会失败（`Transport/ParallelTransport.h:17-26`,`Transport/ParallelTransport.cpp:200-221`,`Transport/ParallelTransport.cpp:662-705`）。
- **低**：与 USB 基线相比，缺乏对 `TransportConfig.devicePath` 的利用，也未调用 `PortDetector::QuickCheckDevice` 进行快速预筛，存在设备路径与可用性判断偏差的风险（`Transport/ParallelTransport.cpp:59-90`）。

### 3.3 建议
- 在 `PortSessionController` 创建并口配置时同步写入 `portName`，并在 `ParallelTransport::Open` 中保留外部传入的 `devicePath` 以支持特殊驱动。
- `ConfigurePort` 或 `Open` 阶段根据 `enableBidirectional` 自动升级 `accessMode` 并记录日志，避免误判为读失败。
- 增加与 USB 一致的预检测与日志格式，提升定位效率。

## 4. 串口访问控制评估
### 4.1 现状概览
- `Open` 过程在尝试 `CreateFileW` 前先调用 `PortDetector::QuickCheckDevice`，具备基础的预检测能力（`Transport/SerialTransport.cpp:59-108`）。
- 写入实现支持分段与异步 IO，错误通过 `ReportError` 回调上报（`Transport/SerialTransport.cpp:226-320`）。

### 4.2 发现的问题
- **中**：缺少显式配置校验与错误日志。`Open` 直接拷贝 `SerialConfig` 后展开流程，若 `portName` 为空或波特率非法只能依赖底层错误码，缺乏与 USB 一致的参数验证（`Transport/SerialTransport.cpp:41-58`）。
- **低**：`Close` 释放事件句柄后未在后续 `Open` 中重建，如组件在同一对象上多次开关串口会出现空句柄（`Transport/SerialTransport.cpp:200-219`）。当前控制器每次重连都会重建对象，风险暂可控，但应在实现层修复。

### 4.3 建议
- 引入 `ValidateConfig` 判断端口名、波特率、数据位等范围，并将结果写入日志以对齐 USB 基线。
- 在 `Open` 检查事件句柄是否存在，必要时重新创建，确保组件复用场景安全。

## 5. 网口访问控制评估
### 5.1 现状概览
- `Open` 包含 Winsock 初始化、超时/保活配置及可选认证流程，失败路径能够关闭套接字（`Transport/NetworkPrintTransport.cpp:80-205`）。
- 支持 RAW/LPR/IPP 三种协议，并通过重连线程维持长连接。

### 5.2 发现的问题
- **中**：端口名称未随用户输入同步。`NetworkPrintConfig` 默认将 `portName` 设为 `hostname:port`，但 `PortSessionController` 只更新 `hostname`/`port` 字段，`GetPortName` 因此始终返回默认值 `192.168.1.100:9100`，日志与 UI 显示将失真（`Transport/NetworkPrintTransport.h:25-62`,`Protocol/PortSessionController.cpp:296-316`,`Transport/NetworkPrintTransport.cpp:380`）。
- **低**：当前认证流程只构建 Basic 头部并缓存，未配合后续 HTTP 请求发送，也未对 NTLM/证书做降级提示，建议在文档中明确限制并补充告警（`Transport/NetworkPrintTransport.cpp:1186-1235`）。

### 5.3 建议
- 在 `PortSessionController` 同步更新 `networkConfig.portName`，或在 `NetworkPrintTransport::Open` 内基于最新 `hostname`/`port` 重建展示名称。
- 补充认证流程的调用链或在日志中告知当前仅准备认证头，避免误判为已完成鉴权。

## 6. 风险评级与整改优先级
- **P0**：并口端口永远指向 LPT1（功能性故障），需优先修复并回归测试。
- **P1**：并口双向访问权限遗漏、网口端口名称不同步，影响用户识别与读写功能，应与 P0 同期处理。
- **P2**：串口配置校验缺失、事件句柄复用风险、网络认证提示不足，建议列入下一次端口稳定性迭代。

## 7. 验证与回归建议
- 针对并口：修复后通过选择 LPT2/LPT3 验证日志与 `GetPortName` 输出，配合打印机实际回环读写验证双向模式。
- 针对串口：补齐参数校验后构造异常配置用例（空端口、非法波特率）确保能提前阻断并给出中文提示。
- 针对网口：调整端口名称同步后，抓取日志确认显示内容与用户输入一致，并在 RAW/LPR 模式下执行基本连接测试。
