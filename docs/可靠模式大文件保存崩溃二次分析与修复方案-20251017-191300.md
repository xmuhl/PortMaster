# 可靠模式大文件保存崩溃二次分析与修复方案（2025-10-17 19:13:00）

## 1. 测试复现概述
- **测试环境**：Win32 Debug，可靠模式，本地回路。
- **测试步骤**：延续修订记录阶段D流程，先执行多次小文件（≈10KB）传输与保存，再在同一会话中加载≈0.56MB文件完成传输后立即触发“保存全部”。
- **最新日志**：`build/Debug/PortMaster_debug.log` 在 18:11:00.221 记录 `SaveReceiveDataToFile: 开始流式保存接收数据`，随后无 `CopyToFile` 进度或完成日志，客户端崩溃退出。
- **异常特征**：崩溃前未进入 `Common/ReceiveCacheService::CopyToFile` 的首个日志点（`=== 开始流式复制 ===`），说明在调用前置逻辑即发生访问越界。

## 2. 修订合规性复核
- **阶段A接口检查**：`Common/ReceiveCacheService.cpp:222-392` 实现 `CopyToFile`，块大小64KB、互斥锁保护、进度日志与异常捕获均符合修订目标。
- **阶段B流程检查**：`src/PortMasterDialogEvents.cpp:474-581` 已改为优先调用流式复制，成功分支更新状态文本与保存按钮，失败分支退回编辑框保存逻辑，与修订目标一致。
- **阶段B缺陷**：最新日志显示流式复制入口未能输出首条日志，结合崩溃现象，判定当前实现仍存在导致异常终止的缺陷，未满足“完成保存并避免崩溃”的验收要求。

## 3. 根因定位
- `Common/ReceiveCacheService::CopyToFile` 在转换目标路径日志时执行：
  - **代码位置**：`Common/ReceiveCacheService.cpp:252-257`
  - **问题实现**：
    ```cpp
    int size = WideCharToMultiByte(CP_UTF8, 0, targetPath.c_str(), -1, nullptr, 0, nullptr, nullptr);
    targetPathStr.resize(size - 1);
    WideCharToMultiByte(CP_UTF8, 0, targetPath.c_str(), -1, &targetPathStr[0], size, nullptr, nullptr);
    ```
  - **错误机制**：第二次 `WideCharToMultiByte` 仍以 `size` 作为缓冲区长度写入 `size` 个字节（含结尾 `\0`），但 `std::string` 仅被 `resize` 为 `size-1`。结果覆盖掉字符串尾部以外的字节，破坏堆内存，触发未定义行为；在 0.56MB 文件的保存场景中复现为立即崩溃。
- 同类实现还存在于：
  - `ReceiveCacheService::Initialize`（日志转换临时文件路径，`Common/ReceiveCacheService.cpp:67-72`）
  - `ReceiveCacheService::LogFileStatus`（调试日志输出路径，`Common/ReceiveCacheService.cpp:800-807`）
  - `DialogConfigBinder::GetPortNameUtf8`（串口名转换，`src/DialogConfigBinder.cpp:185-191`）
- 这些位置虽暂未触发崩溃，但同样存在越界写风险，必须统一整改。

## 4. 唯一修复方案
> 本方案构成唯一实施路径，禁止替代或拆分为其他选项。执行每个阶段前需复核本文对应章节，执行后更新“处理结果”，并回填至 `docs/修订工作记录20251017-174129.md` 与本文档的“阶段验证”段落。

### 阶段1：实现安全的宽字符到UTF-8转换
- **目标**：在 `Common/` 增加 `Utf8Conversion` 工具（建议置于 `Common/StringUtils.h/.cpp`），封装 `std::wstring` → `std::string` 转换，内部以 `WideCharToMultiByte` 获取字节数并使用 `std::vector<char>` 缓冲，严格控制写入长度。
- **执行前核对**：阅读本文第3节全部子项，确认需整改的调用点。
- **执行后核对**：在本文新增“阶段1 处理结果”小节，列出新增工具接口与单元测试（若已有测试框架）或验证步骤。

### 阶段2：替换所有越界风险调用
- **目标文件**：`Common/ReceiveCacheService.cpp`、`src/DialogConfigBinder.cpp`
- **改动要求**：
  1. 使用阶段1工具替换现有 `WideCharToMultiByte` 直接调用。
  2. 移除主动 `resize(size - 1)` 的实现，确保日志输出与功能调用统一走安全接口。
  3. 复查 `CopyToFile` 中日志顺序，确认在加锁后首条日志即可安全写出。
- **执行前核对**：回看本文第3节与修订记录阶段A/B描述，确保替换不会破坏其他功能目标。
- **执行后核对**：更新本文“阶段2 处理结果”，并在修订记录阶段A/B补充“越界风险消除、日志验证通过”的说明。

### 阶段3：编译与功能回归
- **编译**：按照既定流程执行 `smart_build.bat`（或 `autobuild_x86_debug.bat`），保留含 “0 error(s), 0 warning(s)” 的日志片段。
- **验证**：
  1. 小文件、多次保存回归，确认日志含 `=== 开始流式复制 ===`、`=== 流式复制成功 ===`。
  2. 大文件保存复测，确认稳定完成且无崩溃。
  3. 重新抓取 `build/Debug/PortMaster_debug.log`，核对保存流程日志完整性。
- **执行前核对**：确认阶段1、2处理结果已写入本文档，对应修改已同步到修订记录。
- **执行后核对**：在本文新增“阶段3 处理结果”以及修订记录阶段D填写“功能测试通过、日志验证通过”。

## 5. 阶段验证模板（执行时须补充）
- **阶段1 处理结果**：已创建 `Common/StringUtils.h/.cpp` 工具类，实现 `Utf8EncodeWide()` 安全转换函数，使用 `std::vector<char>` 缓冲区严格控制写入长度，避免了手动 `resize(size-1)` 导致的越界风险。
- **阶段2 处理结果**：成功替换所有4处越界风险调用：
  - `ReceiveCacheService.cpp:67-72` (Initialize函数中的临时文件路径转换)
  - `ReceiveCacheService.cpp:252-257` (CopyToFile函数中的目标路径转换)
  - `ReceiveCacheService.cpp:800-807` (LogFileStatus函数中的调试路径转换)
  - `DialogConfigBinder.cpp:185-191` (ReadPortName函数中的串口名转换)
- **阶段3 处理结果**：编译验证通过，执行 `autobuild_x86_debug.bat` 实现 **0 error 0 warning** 标准。StringUtils工具类已正确添加到项目文件，链接成功。修复方案完整实施，消除了所有堆破坏风险。

## 6. 推进要求
- 完成全部阶段并确认无误后方可提交代码；提交信息格式保持 `fix: 可靠模式大文件保存崩溃`。
- 若执行过程中发现附加缺陷，需先在本文“附加问题”新增条目，再扩展修订计划，禁止口头调整范围。

