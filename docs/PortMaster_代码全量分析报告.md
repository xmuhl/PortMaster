# PortMaster 代码全量分析报告

> 背景：公司自研打印机需要借助本工具验证串口、并口、USB、网络等端口的数据传输完整性，回路模式用于本地模拟可靠/直通两种链路。安全性并非首要约束，重点在于端到端数据收发的准确、稳定与可复现性。

## 一、核心能力缺失与影响

1. **可靠模式缺少握手闭环，无法验证可靠策略**  
   - Protocol/ReliableChannel.cpp:183 的 Connect() 仅启动内部线程；SendStart() (Protocol/ReliableChannel.cpp:1334) 从未触发，ProcessStartFrame() (Protocol/ReliableChannel.cpp:1146) 也没有推动状态机。缺少 START/ACK/END 协商，导致窗口与重传参数无法确认，可靠模式退化为“伪可靠”，无法模拟打印机端的丢包与重传行为。

2. **端口状态、超时与数据路径未覆盖真实硬件场景**  
   - 并口：ParallelTransport::QueryPortStatus() (Transport/ParallelTransport.cpp:625) 恒定返回 Ready，无法感知打印机忙碌、缺纸或离线，发送结果无法量化。  
   - USB：UsbPrintTransport::SetDeviceTimeouts() (Transport/UsbPrintTransport.cpp:625) 调用 SetFileTime，读写超时配置无效，大文件阻塞无法及时反馈。  
   - 网络打印：NetworkPrintTransport::BuildIPPRequest() (Transport/NetworkPrintTransport.cpp:985) 仍返回空请求体，Authenticate() 系列 (996-1026) 直接返回成功，无法完成 LPR/IPP 的真实数据面验证。

3. **配置与 UI 流程难以支撑多端口反复测试**  
   - Common/ConfigStore.cpp:718 仅序列化 app/serial/ui，并口、USB、网络、回路、可靠协议等配置无法持久化，测试人员每次切换端口都需手工重配。  
   - src/PortMasterDlg.cpp:2760 等处直接以 total 作为除数，遇到零字节报文会触发除以零崩溃。可靠模式也缺少“传输完成/失败”事件，人工判定测试结果困难。

## 二、关键实现问题（直接影响数据完整性）

1. **错误码回传混乱**  
   - Transport/ParallelTransport.cpp:580/600、Transport/UsbPrintTransport.cpp:267/435/448/649 在失败时直接返回 GetLastError()，破坏 TransportError 枚举语义，难以定位具体故障（超时、写失败、权限问题等）。

2. **回路模式无法与可靠机制联动**  
   - 目前的 LoopbackTransport 虽能收发数据，但因为可靠通道未完成握手/窗口控制，无法模拟 ACK/NAK、重传等场景，导致本地验证对实际打印链路的覆盖不充分。

3. **网络端口缺乏打印协议适配**  
   - IPP/LPR/RAW 的关键报文尚未实现，当前只能建立 TCP 连接，无法验证打印作业是否落入队列或产生设备响应。

## 三、开发迭代优先级（聚焦“数据确实送达并被打印”）

1. **先补齐可靠模式最小闭环**  
   - 实现 START/ACK/END 帧、滑动窗口、超时重传，并在回路模式中共用同一协议栈，确保在 PC 端即可模拟丢包、乱序与重传。  
   - 增强可靠通道日志：记录握手流程、窗口滑动、重传次数、异常原因，方便自动脚本与人工排查。

2. **补全端口状态与超时控制**  
   - 并口：调用 DeviceIoControl 等 API 获取 Busy/OutOfPaper/Error 状态，并在写入前后给出提示。  
   - USB：使用 SetCommTimeouts 或 DeviceIoControl 等有效方式设置读写超时，必要时增加缓冲刷新。  
   - 串口：确认占用检测、流控、缓冲刷新等逻辑覆盖打印机常用参数。  
   - 网络：实现 RAW9100/LPR/IPP 的最小可用数据面，发送后解析返回或保留日志，为打印作业成败提供依据。

3. **完善配置持久化与 UI 交互**  
   - 序列化/反序列化并口、USB、网络、回路、可靠协议配置，支撑多端口快速切换。  
   - 修正进度条除零、增加传输完成/失败事件，完善暂停/继续与中断逻辑，便于长时间或大文件测试。

4. **统一错误码与调试输出**  
   - 将底层 GetLastError() 映射到 TransportError，并在日志中记录原始错误描述、关键参数（端口、长度、超时时间等），确保人工复现时可快速定位问题。

## 四、单功能验证策略（自动化优先、人工可追溯）

### 4.1 完全自动化执行（高优先级）

1. **可靠传输协议**  
   - 目标：全自动验证握手、窗口滑动、超时重传、数据完整性。  
   - 动作：编写控制台/脚本程序，接受命令行参数，自动模拟丢包/乱序并输出统计结果，可无人工参与运行在批处理、PowerShell 或 CI 流水线中。  
   - 要求：完善调试输出（握手阶段、窗口状态、重传次数、最终校验），失败时保留日志文件。

2. **配置读写模块**  
   - 目标：自动验证配置项序列化/反序列化、默认值恢复、兼容性。  
   - 动作：独立脚本批量生成配置、调用加载接口、比较前后差异，测试可完全在后台执行。  
   - 要求：输出变更项、缺失项，异常时给出定位信息。

### 4.2 需要人工参与的联机测试（附脚本 + 使用说明）

> 即使需要物理打印机或人工动作，也要求先提供脚本骨架与配套说明，使测试流程可复制、可记录。

1. **端口状态与超时验证**  
   - 脚本：命令行工具自动执行连接/读写/状态查询。  
   - 说明：文档中描述如何接线、上纸、选择端口，列出运行命令与预期输出，明确人工判断点（如打印机面板灯号、回执信息）。

2. **网络协议报文验证（RAW9100/LPR/IPP）**  
   - 脚本：自动发送报文并捕获返回码或打印机日志请求。  
   - 说明：标注网络环境、打印机 IP/队列名设置步骤、预期打印效果或日志条目，方便人工核对。

3. **USB/串口/并口联机发送**  
   - 脚本：自动推送标准测试文件，记录发送时间、字节数、错误码。  
   - 说明：列出需要手动完成的动作（如更换端口、装纸），并提供调试输出示例，便于判断传输是否成功。

### 4.3 调试输出规范

- 针对上述脚本与主程序，统一日志格式（时间戳、模块、端口、动作、结果、错误详情），确保人工复测或查看脚本输出时可快速定位问题。  
- 为可靠协议与各传输模块增加“关键事件”日志（握手成功、缓冲刷新、状态变化、打印机回执等）。

## 五、阶段性测试建议

- **串口/并口/USB**：利用自动脚本发送文本、二进制、长文件报文，记录日志，并由人工确认打印是否完整。  
- **网络端口**：分别对 RAW9100/LPR/IPP 发送最小作业并记录返回码；人工核对打印机面板或日志。  
- **回路测试**：借助可靠协议自动脚本模拟丢包/超时，核对重传次数、窗口移动；直通模式下关注延迟与吞吐表现。

> 说明：当前迭代需先完成可靠协议与配置模块的全自动验证能力，然后为其余需要联机的场景提供脚本骨架与使用说明，持续完善日志输出。只有在脚本验证通过后，才将功能实现迁移进主工程，减少人工点测的反复工作量。

报告生成时间：2025-09-26 09:34:09

