# 可靠模式存储截断问题分析报告

**日期**: 2025-09-29  
**测试环境**: 最新修订版 PortMaster（使用可靠传输模式）

---

## 1. 现象概述
- 发送文件：约 21 MB 的压缩包（原始大小 21,981,282 字节）。
- 传输结束后点击“保存全部”，导出的文件只有 21,786,624 字节。
- 该问题在旧版本中已修复，但在本次重构后复现。

---

## 2. 日志证据解析
对比 `build\Debug\PortMaster_debug.log` 的关键时间段（10:48:48 ~ 10:48:49）：

1. **保存动作触发**  
   - `[10:48:48.350] ... File size = 21786624`  
   - `[10:48:48.416] ReadDataFromTempCacheUnlocked: 临时文件大小 21786624 字节`  
   - `[10:48:48.481] ReadDataFromTempCacheUnlocked: ✅ 数据读取完整，成功读取 21786624 字节`  
   - 保存逻辑在这一时刻获取到的快照即 21,786,624 字节。

2. **随后仍有数据写入**  
   - 紧接着出现 `ThreadSafeAppendReceiveData` 日志，连续写入 4,096 字节的数据块，并刷新临时文件。  
   - `[10:48:49.804] 文件系统中文字仍在增长，最终到达 21,981,282 字节`。

3. **最终结果**  
   - 保存对话框完成写盘并通过 `VerifySavedFileSize` 验证时，仍然使用的是 21,786,624 字节的旧快照，因此导出的文件缺少后续到达的 194,658 字节（21981282 - 21786624）。

> 结论：保存操作在接收线程尚未完全落盘时就读取了临时文件，导致截断。

---

## 3. 相关代码分析

### 3.1 保存流程
- `OnBnClickedButtonSaveAll` (`src/PortMasterDlg.cpp:2529` 起)：
  1. 检查是否使用临时文件，若可用则直接读取。
  2. `ReadAllDataFromTempCacheUnlocked()` 在持有 `m_receiveFileMutex` 的情况下读取临时文件内容，并在读取完毕后重新以追加模式打开文件。
  3. 一旦读取完毕，互斥锁释放，随后接收线程可继续写入。

### 3.2 读取实现
- `ReadDataFromTempCacheUnlocked` (`src/PortMasterDlg.cpp:4112` 起)：
  - 在读取前调用 `file.seekg` 获取当前文件大小，并按照“先关闭写句柄 -> 64KB 循环读取 -> 重新打开写句柄”的顺序执行。
  - **缺陷**：读取后不会再次验证文件大小是否发生变化，也不会等待数据稳定。

### 3.3 接收线程写入
- `ThreadSafeAppendReceiveData` (`src/PortMasterDlg.cpp:3990` 前后)：
  - 接收线程持锁写入临时文件，并刷新到磁盘。
  - 当保存线程释放互斥锁后，新的数据块继续被写入。

### 3.4 旧版本行为
- 早期版本在保存前会调用 `StabilityTracker::IsDataStable()` 等逻辑，等待传输停止或连续两次读取一致后才继续保存。
- 当前版本为了压缩流程，移除稳定性检测，导致该回归问题再次出现。

---

## 4. 根本原因
1. **缺少数据稳定性校验**：保存流程没有确认接收线程是否已经完全结束写入，对临时文件的读取不是“最终快照”。
2. **并发窗口**：虽然保存期间持有 `m_receiveFileMutex`，但在读取完成后立即释放，接收线程可以继续写入剩余数据；保存操作没有复核文件长度是否变化。

---

## 5. 修复建议
1. **恢复“稳定性”二次校验**：在保存流程中引入等待/重读机制，保证两次读取到的文件大小一致，或检测在固定时间窗口内 `m_totalReceivedBytes` 是否仍在增长。
2. **保存后复核文件大小**：读取临时文件后保存前，再次比较 `m_totalReceivedBytes` 与读取得到的长度；若不一致，重新读取或提示用户等待。
3. **传输完成通知**：在可靠模式下等待 `OnTransportDataReceived` 完全结束（例如 ACK 收尾、`m_pendingWrites` 为空）后再允许保存按钮处于可点击状态。

---

## 6. 结论
- 截断由保存操作过早读取临时文件引起，日志清晰地表明在保存过程中接收线程继续写入额外的 194,658 字节数据。
- 需要恢复或补充“数据稳定性”机制，确保保存使用的文件快照与最终接收结果一致。
