# 传输任务回归问题分析

## 现象
- 在默认直通模式下发送大文件，传输接近尾声弹出 `DebugError! abort has been called` 对话框。
- 传输状态栏 `IDC_STATIC_PORT_STATUS` 在更新状态文本时出现乱码。

## 原因定位
1. **任务线程自阻塞导致的 abort**  
   - 新引入的 `TransmissionTask` 在线程执行完毕后调用 `ReportCompletion()`，直接回调 `CPortMasterDlg::OnTransmissionCompleted()`（`src/PortMasterDlg.cpp:680-709`）。
   - 回调中立即执行 `m_currentTransmissionTask.reset()`，析构函数 `TransmissionTask::~TransmissionTask()` 会调用 `Stop()` → `Cancel()` → `join()`（`src/TransmissionTask.cpp:107-119`）。
   - 由于回调仍运行在任务线程自身中，此时 `join()` 试图等待当前线程，自阻塞导致 C++ 运行时触发 `std::terminate()`，最终弹出 `abort` 对话框。
   - 修订前发送逻辑由 UI 线程创建的单独线程自主管理生命周期，不会在回调中析构自身线程对象，因此不存在此问题。

2. **状态文本编码不匹配造成的乱码**  
   - `TransmissionTask` 内部使用 `std::string` 保存 UTF-8 编码的中文状态文本（`#pragma execution_character_set("utf-8")`，见 `src/TransmissionTask.cpp:132-140`、`src/TransmissionTask.cpp:439-463`）。
   - `CPortMasterDlg::OnTransmissionProgress()` 中直接将该窄字符串传入 `CString`（`src/PortMasterDlg.cpp:663-668`），MFC 以系统 ANSI 码页解释 UTF-8 原始字节，导致显示乱码。
   - 旧实现使用 `_T()` 字面量构造 `CString`，不会发生跨编码转换问题。

## 建议修复
1. **避免在任务线程中析构任务对象**  
   - 在完成回调中仅投递消息或设置标志，由 UI 线程在处理 WM_USER 消息后再销毁 `m_currentTransmissionTask`。
   - 或在 `TransmissionTask::Stop()` 中检测当前线程，与 `m_workerThread` 相同则跳过 `join()`，防止自阻塞。

2. **统一状态文本编码**  
   - 将状态字符串改用 Unicode/`std::wstring` 存储，并在回调中使用宽字符 `CString`。  
   - 或在构造 `CString` 前通过 `CA2T(progress.statusText.c_str(), CP_UTF8)`（或 `MultiByteToWideChar`）从 UTF-8 转换到 Unicode。
