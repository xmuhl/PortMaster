# PortMaster 代码核心功能符合度与修订要点报告 (V2.0)

**文档版本:** 2.0
**分析日期:** 2025年9月28日
**核心原则:** 本报告遵循“实用、稳定、快速落地”的要求，聚焦于对核心功能有重大影响的设计差距与代码缺陷，并提供精确的代码定位。

---

## 1. 总体情况评估

当前项目已实现基础的UI框架和部分端口（串口、回路）的直通传输功能。近期对大文件保存的修订解决了基础的并发竞争和文件读取问题。然而，项目距离设计文档中“稳定可靠”的目标仍有显著差距，核心的“可靠传输模式”基本处于不可用状态，且多数端口实现和配置管理功能不完整。

**结论：** 项目完成了约40%的设计目标，核心的可靠性和功能的完整性存在严重短板，亟待修复。

---

## 2. 核心问题与高优先级修订要点

以下是为保证工具“实用、稳定”必须解决的关键问题。

### 2.1. 可靠传输协议：功能完全缺失

- **问题描述**: “可靠模式”名不副实。尽管UI上可以勾选，但底层的 `ReliableChannel` 类仅有空洞的框架，未实现任何会话握手（START/ACK）、数据确认（DATA/ACK）、超时重传（NAK）和结束会话（END）的核心逻辑。
- **对稳定性和实用性的影响**: 这是**最高优先级**的问题。此缺陷使得工具无法用于任何需要验证数据完整性的场景，完全违背了项目“可靠传输辅助工具”的核心定位。
- **源文件**: `Protocol/ReliableChannel.cpp`
- **代码定位与修订建议**:
    - **`Connect()` 函数**: `[起始行: 203, 终止行: 211]`
        - **分析**: 当前仅启动了几个线程，但没有发送 `START` 帧以发起会话协商。
        - **建议**: 在此函数中，或在 `Send` 函数首次被调用时，构建并发送符合协议规范的 `START` 帧，并等待对方的 `ACK` 响应，真正建立起一个可靠会话。
    - **`SendThread()` 函数**: `[起始行: 268, 终止行: 278]`
        - **分析**: 线程主循环为空，不会从 `m_sendQueue` 队列中取出数据进行发送。
        - **建议**: 在此实现核心的发送逻辑：从队列取数据，封装成 `DATA` 帧，发送后存入“待确认窗口”，并启动超时计时器。
    - **`ProcessDataFrame()` 函数**: `[起始行: 301, 终止行: 305]`
        - **分析**: 函数体为空。无法处理收到的数据帧。
        - **建议**: 在此实现接收逻辑：校验CRC32、检查序号是否符合预期，如果正确，则将数据负载（payload）提交给上层（UI），并回复 `ACK` 帧。
    - **`ProcessAckFrame()` 函数**: `[起始行: 307, 终止行: 311]`
        - **分析**: 函数体为空。发送端无法确认数据是否被成功接收。
        - **建议**: 在此实现ACK处理逻辑：根据收到的ACK序号，将“待确认窗口”中的对应数据包标记为已确认，并滑动窗口以发送新的数据。

### 2.2. 配置管理：功能严重不完整

- **问题描述**: `ConfigStore` 仅实现了串口和部分UI配置的保存与加载，其他所有端口（并口、USB、网络）的参数以及可靠模式的配置在程序重启后全部丢失。
- **对稳定性和实用性的影响**: 严重影响实用性。测试人员每次切换端口或重启程序都必须手动重新输入所有参数，效率极低且容易出错。
- **源文件**: `Common/ConfigStore.cpp`
- **代码定位与修订建议**:
    - **`SerializeToJson()` 函数**: `[起始行: 716, 终止行: 834]`
    - **`DeserializeFromJson()` 函数**: `[起始行: 836, 终止行: 1032]`
        - **分析**: 这两个核心函数中，只包含了对 `app`, `serial`, `ui` 三个配置对象的处理逻辑。
        - **建议**: 参照现有对 `serial` 的处理方式，在这两个函数中补充对 `parallel`, `usb`, `network`, `loopback`, `protocol` 这几个配置对象的JSON序列化与反序列化代码，确保所有配置都能被完整读写。

### 2.3. 部分端口（Transport）实现：功能缺失

- **问题描述**: 并口和USB打印端口的功能实现非常表面，无法获取设备真实状态；网络打印功能则完全不可用。
- **对稳定性和实用性的影响**: 作为打印机公司的内部工具，这些端口的支持是核心需求。当前状态下，这些端口的测试价值几乎为零。
- **源文件**: `Transport/ParallelTransport.cpp`, `Transport/UsbPrintTransport.cpp`, `Transport/NetworkPrintTransport.cpp`
- **代码定位与修订建议**:
    - **`ParallelTransport::QueryPortStatus()`**: `[起始行: 625, 终止行: 631]`
        - **分析**: 函数直接返回 `PORT_READY`，是硬编码的假数据。
        - **建议**: 使用 `DeviceIoControl` 配合 `IOCTL_PAR_QUERY_INFORMATION` 等控制码来获取并口的真实状态（如缺纸、忙碌等）。
    - **`UsbPrintTransport::Write()`**: `[起始行: 435, 终止行: 482]`
        - **分析**: 缺少对 `WriteFile` 超时和错误的有效处理。虽然使用了 `OVERLAPPED`，但没有完全发挥其异步能力。
        - **建议**: 结合 `GetOverlappedResult` 和 `WaitForSingleObject`，实现一个带有真实超时机制的写入操作。
    - **`NetworkPrintTransport::Send()`**: `[起始行: 484, 终止行: 530]`
        - **分析**: 函数内部关于 `LPR` 和 `IPP` 协议的部分被完全注释掉了 (`// TODO`)。
        - **建议**: 至少为 `RAW (9100)` 协议实现一个基础的TCP数据发送逻辑。对于 `LPR`，需要根据RFC 1179规范，实现一个最小化的控制文件和数据文件发送流程。

---

## 3. 次要问题与可选优化项

以下问题不影响核心功能的稳定性，可根据时间和资源决定是否修订。

- **问题1：任务调度逻辑与UI高度耦合**
  - **分析**: 设计文档要求的 `TaskOrchestrator` 模块缺失，所有传输控制逻辑（如分块发送、暂停/继续）都在 `CPortMasterDlg::PerformDataTransmission` (`[起始行: 608, 终止行: 828]`) 中实现。这使得代码难以维护。
  - **实用性建议**: **不必**完全重构成一个独立的 `TaskOrchestrator` 类。但可以将 `PerformDataTransmission` 函数内部的 `while` 循环和状态标志位（`m_transmissionPaused` 等）封装到一个新的私有成员函数中，以简化主函数逻辑，这是一种成本较低的改进。

- **问题2：日志系统过于简单**
  - **分析**: 设计要求独立的 `LogCenter`，但当前仅有 `CPortMasterDlg::WriteLog` (`[起始行: 80, 终止行: 99]`)，直接写入文件，可能在频繁调用时产生性能瓶颈。
  - **实用性建议**: 对于内部工具，当前的日志功能**基本够用**。暂时无需升级为带异步队列的复杂日志系统。只需确保在关键的错误处理路径中都调用了 `WriteLog` 即可。

- **问题3：UI与设计稿存在差距**
  - **分析**: `PortMaster.rc` 文件定义的对话框 (`IDD_PORTMASTER_DIALOG`) 缺少了设计文档中提到的“配置导入导出”、“测试向导”、“日志过滤”等高级功能菜单或按钮。
  - **实用性建议**: 这些属于体验优化功能，优先级较低，可在核心功能稳定后再考虑添加。

- **问题4：启动画面缺失**
  - **分析**: `CPortMasterApp::InitInstance` (`[起始行: 40, 终止行: 68]`) 中没有实现 Splash 启动画面。
  - **实用性建议**: 此为纯视觉功能，对核心无任何影响，**优先级最低**。

---

**总结:** 为快速提升工具的实用性和稳定性，建议集中资源优先解决 **2.1 (可靠协议)、2.2 (配置管理)、2.3 (端口实现)** 中指出的核心缺陷。