# PortMasterDlg模块拆分整改完整修订计划

## 📋 计划概览

根据`docs/PortMasterDlg拆分整改执行清单.md`的要求，本计划将严格按照6个阶段执行模块拆分整改任务，每个任务执行前后都会对照文档验证一致性。

---

## 🎯 阶段0：准备与基线确认

### 任务文档参考位置
- **执行前阅读**：第5-9行（阶段0完整内容）
- **验证对照**：第6-8行（编译要求、行数记录、功能验证）

### 执行步骤

1. **编译基线验证**
   - 使用`cmd.exe /c autobuild_x86_debug.bat`编译项目
   - 验证标准：0 error / 0 warning
   - 记录编译日志关键信息

2. **代码基线记录**
   - 执行`wc -l src/PortMasterDlg.cpp`获取当前行数
   - 当前基线：2519行
   - 记录到修订工作记录文件

3. **核心功能验证**
   - 连接/断开操作测试
   - 直通发送测试
   - 可靠发送测试
   - 文件接收保存测试
   - 十六进制显示切换测试
   - 配置读写测试
   - 记录每个用例的操作与结果

4. **文档更新**
   - 创建修订工作记录文件（按照CLAUDE.md模板）
   - 标注"阶段0完成"
   - 附加编译日志和功能验证结果

---

## 🎯 阶段1：控件管理与日志统一整改

### 任务文档参考位置
- **执行前阅读**：第11-19行（阶段1完整内容）
- **验证对照**：第12行（目标）、第14-17行（迁移要求）

### 执行步骤

1. **控件操作审计**
   - 读取任务文档第14行要求
   - 检查`CPortMasterDlg`中所有控件操作
   - 使用`rg "SetWindowText|GetWindowText|EnableWindow|SetDlgItemText|GetDlgItemText" src/PortMasterDlg.cpp`
   - 逐项核对是否已迁移到`DialogUiController`或`StatusDisplayManager`

2. **DialogUiController接口完善**
   - 读取任务文档第15行要求
   - 检查`DialogUiController.h`接口是否涵盖所有UI操作
   - 在`CPortMasterDlg`中搜索所有UI控件调用，确保全部替换为控制器接口
   - 验证无残留的直接控件操作

3. **StatusDisplayManager日志统一**
   - 读取任务文档第16行要求
   - 确保所有日志、统计、进度相关调用都在`StatusDisplayManager`内完成
   - `WriteLog`等函数仅负责写文件和调用`StatusDisplayManager`
   - 验证不再直接操作UI

4. **残留控件调用清理**
   - 读取任务文档第17行要求
   - 移除`CPortMasterDlg`中所有直接控件调用
   - 确认UI控件只在控制器/显示管理器内访问

5. **编译验证**
   - 执行`cmd.exe /c autobuild_x86_debug.bat`
   - 确保0 error / 0 warning
   - 记录编译日志

6. **文档更新**
   - 对照任务文档第19行
   - 列出迁移的函数清单
   - 记录编译结果
   - 标注"阶段1完成"

---

## 🎯 阶段2：端口流程收尾

### 任务文档参考位置
- **执行前阅读**：第21-28行（阶段2完整内容）
- **验证对照**：第22行（目标）、第24-26行（验证要求）

### 执行步骤

1. **端口流程函数检查**
   - 读取任务文档第24行要求
   - 检查`OnBnClickedButtonConnect/Disconnect`
   - 检查`InitializeTransportConfig`
   - 确认只调用服务接口，UI更新交由控制器

2. **控件操作替换**
   - 读取任务文档第25行要求
   - 搜索残留的`SetDlgItemText`调用
   - 替换为控制器接口
   - 验证端口状态文本、按钮、保存按钮状态全部通过控制器更新

3. **PortConfigPresenter验证**
   - 读取任务文档第26行要求
   - 验证是否涵盖所有端口类型
   - 检查参数组合完整性
   - 验证回调接口完整性

4. **编译验证**
   - 执行`cmd.exe /c autobuild_x86_debug.bat`
   - 确认0 error / 0 warning

5. **文档更新**
   - 对照任务文档第28行
   - 注明阶段2修订点与编译结果
   - 标记"阶段2完成"

---

## 🎯 阶段3：事件调度集中化修复

### 任务文档参考位置
- **执行前阅读**：第30-38行（阶段3完整内容）
- **验证对照**：第31行（目标）、第33-36行（迁移要求）

### 执行步骤

1. **事件函数逐一核对**
   - 读取任务文档第33行要求
   - 核对以下事件函数：
     - `OnBnClickedButtonSend/Stop/File`
     - `OnBnClickedButtonClearAll/ClearReceive/CopyAll/SaveAll`
     - `OnBnClickedCheckHex`
     - `OnDropFiles`
     - `OnBnClickedButtonConnect/Disconnect`
   - 确认全部调用`m_eventDispatcher`对应方法
   - 验证不再含业务代码

2. **保存流程迁移**
   - 读取任务文档第34行要求
   - 将`OnBnClickedButtonSaveAll`中的完整保存流程迁移至`PortMasterDialogEvents::HandleSaveAll`
   - 确保事件调度器逻辑可直接运行
   - 删除`CPortMasterDlg`中冗余流程和重复日志

3. **十六进制切换迁移**
   - 读取任务文档第35行要求
   - 将`OnBnClickedCheckHex`中的模式切换逻辑迁移到`HandleToggleHex`
   - 确保控制器返回的文案与日志由`StatusDisplayManager`输出

4. **调度器函数清理**
   - 读取任务文档第36行要求
   - 检查调度器中未使用的函数
   - 确认被调用情况
   - 删除重复或无引用的函数

5. **编译验证**
   - 执行`cmd.exe /c autobuild_x86_debug.bat`
   - 确认0 error / 0 warning

6. **文档更新**
   - 对照任务文档第38行
   - 列出迁移的事件函数列表
   - 记录编译结果
   - 标记"阶段3完成"

---

## 🎯 阶段4：状态展示与日志统一回归

### 任务文档参考位置
- **执行前阅读**：第40-47行（阶段4完整内容）
- **验证对照**：第41行（目标）、第43-45行（职责划分要求）

### 执行步骤

1. **StatusDisplayManager接口检查**
   - 读取任务文档第43行要求
   - 遍历`StatusDisplayManager`暴露的接口
   - 确保在`CPortMasterDlg`或事件调度器中均有对应调用
   - 移除或补全未使用的接口

2. **职责划分调整**
   - 读取任务文档第44行要求
   - 检查`DialogUiController`与`StatusDisplayManager`的职责划分
   - 避免重复功能
   - 调整为单一模块负责

3. **节流逻辑统一**
   - 读取任务文档第45行要求
   - 确保节流逻辑仅在一个模块内管理
   - 若`StatusDisplayManager`提供节流接口，删除`DialogUiController`中相同功能
   - 调整调用关系

4. **编译验证**
   - 执行`cmd.exe /c autobuild_x86_debug.bat`
   - 确认0 error / 0 warning

5. **文档更新**
   - 对照任务文档第47行
   - 记录阶段4完成情况
   - 包括控制器与展示器职责划分
   - 记录编译结果

---

## 🎯 阶段5：状态数据容器评估（维持跳过策略）

### 任务文档参考位置
- **执行前阅读**：第49-54行（阶段5完整内容）
- **验证对照**：第50行（目标）、第52-53行（验证要求）

### 执行步骤

1. **旧组件引用验证**
   - 读取任务文档第52行要求
   - 使用`rg "UIStateManager" .`搜索
   - 确认旧组件无引用
   - 定期验证

2. **状态管理评估**
   - 读取任务文档第53行要求
   - 评估`std::atomic`状态管理是否满足当前需求
   - 若出现新需求需改动，另行列出设计方案再执行

3. **文档更新**
   - 对照任务文档第54行
   - 重申跳过理由
   - 记录验证证据
   - 注明"阶段5保持跳过状态"

---

## 🎯 阶段6：余留清理与终验

### 任务文档参考位置
- **执行前阅读**：第56-63行（阶段6完整内容）
- **验证对照**：第57-62行（清理和验证要求）

### 执行步骤

1. **旧模块清理检查**
   - 读取任务文档第57行要求
   - 检查源文件中是否包含被排除的旧模块（ThreadSafeProgressManager等）
   - 决定归档或删除
   - 若仅排除编译，在`docs`中说明处理策略

2. **工程文件引用复查**
   - 读取任务文档第58行要求
   - 复查工程文件（.vcxproj）引用
   - 确保不再包含已废除的源文件

3. **编译与静态分析**
   - 读取任务文档第59行要求
   - 执行`cmd.exe /c autobuild_x86_debug.bat`
   - 确认0 error / 0 warning
   - 执行静态分析：`cmd.exe /c msbuild PortMaster.sln /t:Rebuild /p:Configuration=Debug /p:Platform=Win32 /p:RunCodeAnalysis=true`
   - 保存分析结果

4. **阶段汇总**
   - 读取任务文档第60行要求
   - 汇总阶段0-6的执行情况与结果
   - 更新`docs/PortMasterDlg模块拆分完整任务计划导出.md`
   - 更新修订记录
   - 标记每阶段"完成"或"跳过"状态

5. **提交准备**
   - 读取任务文档第61行要求
   - 编写提交摘要
   - 说明自动编译与静态分析结论

6. **测试通知**
   - 读取任务文档第62行要求
   - 所有自动验证完成且文档更新后
   - 通知测试团队按标准用例执行人工回归测试
   - 人工测试结果另行记录

---

## ✅ 验证机制

### 每个阶段执行前
1. 读取任务文档对应行的要求
2. 理解目标和验证标准
3. 准备执行环境

### 每个阶段执行中
1. 严格按照文档步骤执行
2. 使用工具验证每个修改点
3. 记录执行过程和发现的问题

### 每个阶段执行后
1. 对照文档验证是否完成所有要求
2. 执行编译验证
3. 更新修订记录文档
4. 标记阶段完成状态

---

## 📊 质量保证

- **0错误0警告原则**：每个阶段编译验证必须达到0 error / 0 warning
- **文档一致性原则**：每个步骤必须与任务文档完全一致
- **验证完整性原则**：不遗漏任何验证点
- **记录详细性原则**：所有执行过程和结果都详细记录
