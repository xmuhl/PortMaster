# PortMaster 第六轮修订计划（基于完整分析报告）

## 📋 计划概述

**修订基线**：`PortMaster_全量校验分析报告_20251021-142522.md` 第 13 节"必须落实的问题清单"

**前期修订遗漏**：第六轮仅完成了 4 个问题（串口分段读写、UI提示、缓存保留、状态栏同步），尚有 9 个关键问题未解决

**本轮目标**：
1. 完成分析报告第 13 节的全部 13 个问题
2. 每阶段完成后都对照分析报告验证
3. 不能出现"暂未处理"，必须给出明确的修改或替代方案决议

---

## 🔴 需要立即修复的问题清单

### 第 1 类：编码规范与编译警告（分析报告 #13.1）✅ 部分完成

| 问题 | 位置 | 现状 | 修复方案 | 验证方法 |
|------|------|------|---------|---------|
| C4244 警告 | `DialogUiController.cpp:403-413`、`StatusDisplayManager.cpp:213-223` | 已修复为 `ULONGLONG` | ✅ 已完成 | 编译时无 C4244 警告 |
| C6302 警告 | `src/PortMasterDlg.cpp:152,2074,2371` | 仍使用不安全的 `CString::Format(%s, std::string)` | **需修复** | 使用 `CA2T`、`%hs` 或 `StringUtils` |
| #pragma charset | `src/PortMasterDlg.cpp/.h`、`src/PortMaster.cpp`、`src/PortMasterDialogEvents.cpp` | 缺失 `#pragma execution_character_set("utf-8")` | **需修复** | 文件首部添加 pragma |

### 第 2 类：串口实现与线程同步（分析报告 #13.2）✅ 部分完成

| 问题 | 位置 | 现状 | 修复方案 | 验证方法 |
|------|------|------|---------|---------|
| 分段读写 | `Transport/SerialTransport.cpp:175-345` | ✅ 已完成循环分段 | — | 编译 0E/0W |
| 资源泄漏 | `Transport/SerialTransport.cpp:25-33, 120-141` | `CloseHandle` 缺失 | **需修复** | Read方法验证事件释放 |
| 原子变量 | `Transport/SerialTransport.h:52-75` | `m_stopReading` 仍为普通 `bool` | **需修复** | 改为 `std::atomic<bool>` |
| CancelIoEx | `Transport/SerialTransport.cpp:337-348` | 仍使用 `CancelIo` | **需改进** | 改用 `CancelIoEx`（跨线程兼容） |

### 第 3 类：数据读写安全（分析报告 #13.3）❌ 需要重新设计

| 问题 | 位置 | 现状 | 修复方案 | 验证方法 |
|------|------|------|---------|---------|
| **大文件截断** | `src/PortMasterDialogEvents.cpp:638-652` | 512MB 限制被虚假宣传为"完整" | **必须重新设计** | 见下文详细方案 |
| **m_memoryCache** | `Common/ReceiveCacheService.cpp:125-138` | 仍保留双重缓存（内存+磁盘） | **必须删除** | 仅使用 CopyToFile |
| **编辑框回退** | `src/PortMasterDialogEvents.cpp:539-603` | 仍有编辑框写盘逻辑 | **必须删除** | 保存仅依赖文件缓存 |

**❌ 大文件问题详情**：
```
当前代码（虚假"完整缓存"）：
- 对 ≤512MB 文件：读取完整文件
- 对 >512MB 文件：仅读取前 512MB 并截断
- 文档宣称"完整缓存"，实际限制 512MB
- 违背分析报告要求"禁止截断"

必须修复为以下之一：
选项A（推荐）：流式发送 - 不缓存超大文件
  - LoadDataFromSelectedFile：预览前 32KB 用于UI显示
  - 实际发送：从文件分段读取、逐块发送
  - 优点：内存无限制，支持任意大小
  - 缺点：停止后无法重新续传该文件

选项B（备选）：分段缓冲
  - 最多缓存 512MB（内存限制）
  - 文档明确说明"大于512MB文件不支持缓存"
  - 用户加载>512MB文件时明确提示限制
  - 优点：向下兼容，清晰明确
  - 缺点：无法完整处理超大文件

决议：采用选项A（流式发送） + 文档说明
```

### 第 4 类：传输层修复（分析报告 #13.4）✅ 已完成

| 问题 | 位置 | 现状 | 修复方案 |
|------|------|------|---------|
| Socket 关闭 | `Transport/NetworkPrintTransport.cpp:332-353` | ✅ 已实现 shutdown | — |
| LPRResponse 空响应 | `Transport/NetworkPrintTransport.cpp:899-914` | ✅ 已处理 | — |

### 第 5 类：可靠传输 TODO 清理（分析报告 #13.5）✅ 已完成

| 问题 | 位置 | 现状 | 修复方案 |
|------|------|------|---------|
| 压缩/加密桩代码 | `Protocol/ReliableChannel.cpp:1745-1760` | ✅ 已移除调用，保留空实现 | — |

### 第 6 类：UI 与保存流程（分析报告 #13.6）⚠️ 部分完成

| 问题 | 位置 | 现状 | 修复方案 | 验证方法 |
|------|------|------|---------|---------|
| LoopbackConfig 传递 | `src/PortMasterDlg.cpp:1672-1690` | ✅ 已完成 | — | — |
| 模式切换断开重连 | `src/PortMasterDlg.cpp:1237-1264` | ✅ 已完成 | — | — |
| HandleDisconnect 失败提示 | `src/PortMasterDialogEvents.cpp:90-120` | ✅ 已完成 | — | — |
| HandleStop 缓存保留 | `src/PortMasterDialogEvents.cpp:168-187` | ✅ 已完成 | — | — |
| HandleCopyAll 状态栏同步 | `src/PortMasterDialogEvents.cpp:396-482` | ✅ 已完成 | — | — |
| **保存流程简化** | `Common/ReceiveCacheService.cpp` + `src/PortMasterDialogEvents.cpp:539-603` | ❌ 仍保留 m_memoryCache 与编辑框回退 | **必须删除** | 仅使用 CopyToFile |

### 第 7 类：输入验证（分析报告 #13.7）❌ 需要修复

| 问题 | 位置 | 现状 | 修复方案 | 验证方法 |
|------|------|------|---------|---------|
| hostname:port 格式 | `src/DialogConfigBinder.cpp:288-358` | 缺少正则校验 | **需添加** | 网络配置失败时有错误提示 |

### 第 8 类：资源与构建配置（分析报告 #13.8）❌ 需要修复

| 问题 | 位置 | 现状 | 修复方案 | 验证方法 |
|------|------|------|---------|---------|
| **运行库** | `PortMaster.vcxproj:66/98` | `/MDd`、`/MD` | **决议需要** | 见下文 |
| **资源清理** | `resources/PortMaster.rc:73` + `PortMaster_Icon.ico` | 冗余图标 | **需删除** | 编译后验证资源正确 |
| **Splash 逻辑** | `src/PortMaster.cpp` | 未实现 | **取消或实现** | — |

**❌ 运行库问题详情**：
```
分析报告要求：改为 /MTd（Debug）、/MT（Release）- 静态链接
当前配置：/MDd、/MD - 动态链接 DLL

之前的决议：保持 /MDd 以兼容 _AFXDLL
问题：
1. 分析报告未批准此决议
2. 修订记录文档说明不足，未获正式审批
3. 若确需保留 /MDd，必须补充需求签核和技术说明

必须做出明确决议：
选项A（推荐）：改为 /MTd、/MT - 按原要求执行
选项B（当前）：保持 /MDd、/MD - 需要签核并更新需求文档

决议：采用选项A - 改为 /MTd、/MT（如有兼容性问题需要解决）
```

### 第 9 类：其他未完成项目

| 问题 | 优先级 | 现状 | 说明 |
|------|--------|------|------|
| 端口占用检测 | 高 | 占位符实现 | 分析报告 #13.4 未标记为"必须"，可在后续迭代 |
| 网络打印发现 | 低 | 占位符实现 | 同上，可后续迭代 |
| 静态分析警告 | 高 | 多条 | 修复后需重新验证 |

---

## 🔧 修订执行步骤

### 阶段 0：准备（先做 1-5 分钟）

创建新修订记录文件，记录执行进度：
```bash
docs/修订工作记录20251022-xxxxxx.md
```

### 阶段 1：编码规范修复（需验证）

**目标**：修复 C6302、添加 #pragma、消除静态分析警告

**修改内容**：
1. 修复 `src/PortMasterDlg.cpp:152,2074,2371` 中的 `CString::Format`
2. 在以下文件首部添加 `#pragma execution_character_set("utf-8")`：
   - `src/PortMasterDlg.cpp`
   - `src/PortMasterDlg.h`
   - `src/PortMaster.cpp`
   - `src/PortMasterDialogEvents.cpp`

**验证方法**（对照分析报告 #13.1）：
- 编译 0E/0W
- 静态分析无 C6302、C4244 警告
- 中文提示框显示正确（无乱码）

### 阶段 2：串口资源与同步修复（需验证）

**目标**：修复线程同步问题、资源泄漏

**修改内容**：
1. `Transport/SerialTransport.h:52-75` - 改为 `std::atomic<bool> m_stopReading`
2. `Transport/SerialTransport.cpp:120-141` Close 方法 - 添加事件句柄释放
3. `Transport/SerialTransport.cpp:337-348` - 改用 `CancelIoEx`

**验证方法**（对照分析报告 #13.2）：
- 编译 0E/0W
- 无资源泄漏（检查 Close 调用）
- 线程安全（原子变量）

### 阶段 3：大文件与缓存问题重新设计（需验证）

**目标**：实现流式发送，删除 m_memoryCache 和编辑框回退

**修改内容**：
1. 重新设计 `LoadDataFromSelectedFile`：
   - 预览显示：前 32KB
   - 实际发送：流式读取，不缓存

2. 删除 `Common/ReceiveCacheService.cpp:125-138` 中的 m_memoryCache

3. 删除 `src/PortMasterDialogEvents.cpp:539-603` 中的编辑框回退逻辑

4. 修改 `Common/ReceiveCacheService.cpp:CopyToFile` 使用 uint64_t

**验证方法**（对照分析报告 #13.3）：
- 编译 0E/0W
- 加载大文件（>512MB）不截断提示
- 保存流程仅依赖 CopyToFile
- 保存失败时有明确错误提示

### 阶段 4：输入验证（需验证）

**目标**：添加 hostname:port 格式校验

**修改内容**：
1. 在 `src/DialogConfigBinder.cpp:288-358` 中添加正则表达式校验

**验证方法**（对照分析报告 #13.7）：
- 编译 0E/0W
- 无效格式被拒绝并提示

### 阶段 5：运行库改为 /MTd（决议后执行）

**目标**：改为静态链接，消除 _AFXDLL 依赖

**修改内容**：
1. `PortMaster.vcxproj:66` 改为 `<RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>`
2. 检查是否有编译兼容性问题

**验证方法**（对照分析报告 #13.8）：
- 编译 0E/0W
- 如出现 #error，需要调整项目配置

### 阶段 6：资源清理（需验证）

**目标**：删除冗余资源文件

**修改内容**：
1. 删除 `PortMaster_Icon.ico`
2. 取消或实现 Splash 逻辑

**验证方法**（对照分析报告 #13.8）：
- 编译 0E/0W
- RC 文件资源正确引用

---

## 📊 验证清单（每阶段必须检查）

对照 `PortMaster_全量校验分析报告_20251021-142522.md` 第 13 节，逐项验证：

- [ ] 编码规范 #13.1：C6302/C4244 消除，#pragma 补齐
- [ ] 串口同步 #13.2：资源释放、原子变量、CancelIoEx
- [ ] 数据读写 #13.3：大文件流式发送、删除 m_memoryCache、删除编辑框回退
- [ ] 传输层 #13.4：已完成（socket 关闭、LPRResponse）
- [ ] TODO 清理 #13.5：已完成（压缩/加密）
- [ ] UI 流程 #13.6：已完成（LoopbackConfig、模式切换、错误提示、缓存保留、状态栏同步）
- [ ] 输入验证 #13.7：hostname:port 格式校验
- [ ] 资源与构建 #13.8：/MTd、资源清理、Splash

---

## 🎯 最终目标

**完成后状态**：
```
编译：0 error / 0 warning
静态分析：0 warnings
分析报告 #13 完成度：13/13（100%）
是否可提交：是
```

**不能出现的情况**：
```
❌ "暂未处理" / "待后续迭代"
❌ "编译通过但有隐藏问题"
❌ "虚假宣传" （512MB 被称为"完整"）
```
