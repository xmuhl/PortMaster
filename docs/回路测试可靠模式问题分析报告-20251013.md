# 回路测试可靠模式问题全面分析报告

**报告日期**: 2025-10-13  
**适用范围**: PortMaster 本地回路测试端口在“可靠传输模式”下的错误诊断与改进建议  
**参考设计文档**: `docs/PortMaster 项目开发.md`

---

## 1. 背景与目标

- 回路测试端口用于在本机验证直通与可靠模式的传输流程，无需真实设备参与。近期在可靠模式下频繁出现握手超时、NAK 风暴、CRC 失败与重传异常等问题。
- 本报告对照项目需求与协议规格，对现有实现进行全量分析，明确错误现象与根因，并提出本地可行的改进与验证方案。

---

## 2. 测试环境与真实双机差异

**真实场景（双主机、双串口）**
- 两端分别运行独立进程，物理链路存在真实延迟与缓冲；读写线程相对独立，ACK/NAK/重传在各自时钟与队列下推进。
- 可靠协议以“窗口=1、逐包确认”为基础，RTT 与超时估算更贴近物理环境。

**本地回路测试（单机、单进程）**
- 发送路径与接收路径共享同一进程资源；LoopbackTransport 以内存队列模拟链路，延迟/丢包为软件注入，近似“零拷贝”。
- 调度顺序与线程占用更容易出现“写线程占优、读线程饥饿”现象，ACK 生成与投递可能被延后，导致超时与重传偏高。
- 近零延迟会干扰 RTT 平滑估算（过小的超时阈值在调度抖动下更易误判超时）。
- 由于无真正的双节点，启动握手与接收窗口的同步若依赖对端状态机，则需在本地模拟端严格遵循协议推进，否则容易出现会话未建立即发送数据导致异常。

结论：单机回路模型在总体上可验证握手与数据往返，但必须在调度、最小超时、窗口同步、错误注入等方面进行“本地化处理”。

---

## 3. 规范对照与实现符合性检查

**协议规格要点（摘自设计文档）**
- 帧格式（小端）：包头 `0xAA55` + 类型 + 序号 + 长度 + `CRC32(EDB88320, init 0xFFFFFFFF, final xor 0xFFFFFFFF，覆盖“类型|序号|长度|数据”)` + 数据 + 包尾 `0x55AA`。
- 流程：发送端 `START → ACK → DATA(N) 逐包 ACK/NAK/超时重传 → END → ACK → 完成`；接收端按序处理并确认。
- 窗口：滑动窗口=1（逐包 ACK），支持断点续传；RTT 动态估算驱动超时与重试。

**关键实现入口（代码检索）**
- 握手启动与等待：`Protocol/ReliableChannel.cpp::EnsureSessionStarted()`（握手 START 发送与 `WaitForHandshakeCompletion()` 等待），`Protocol/ReliableChannel.h` 中维护握手条件与状态（如 `m_handshakeCondition`, `m_handshakeCompleted`）。
- ACK 处理与握手完成：`Protocol/ReliableChannel.cpp::ProcessAckFrame()` 对握手序号的 ACK 进行完成标记与条件通知（检索结果显示握手 ACK 路径已实现）。
- START 处理与接收窗口同步：`Protocol/ReliableChannel.cpp::ProcessStartFrame()` 在回送 ACK 的同时，同步 `m_receiveBase/m_receiveNext` 至 `START.sequence + 1`，用于消除 NAK 风暴风险。
- 数据帧与窗口推进：`Protocol/ReliableChannel.cpp::ProcessDataFrame()`、`ProcessAckFrame()` 负责滑动窗口与统计推进（检索结果显示逻辑已存在）。
- Loopback 双工模拟：`Transport/LoopbackTransport.cpp::ProcessSendQueue()` 模拟延迟与丢包，队列回推至接收侧，并统计 `loopbackRounds` 与触发 `NotifyDataReceived()` 回调。

**符合性结论**
- 与早期报告“可靠协议为空壳”的结论不同，当前代码已具备握手、ACK/NAK 与窗口推进的主体逻辑（参考：`ReliableChannel.cpp` 多处实现）。
- 仍存在风险点与改进空间：
  - 普通发送路径可能未确保在首包前调用握手（见《项目核心功能分析与修订报告_V3.md》中的提示）。
  - RTT/超时在本地近零延迟环境下过小，容易触发“假超时”。
  - Loopback 的队列/回调调度若无独立接收线程或优先级控制，ACK 投递可能延后，诱发重传与窗口阻塞。

---

## 4. 错误现象与根因对应

- 现象A：频繁出现 NAK 风暴，窗口无法推进。
  - 根因1：接收窗口基准未与 `START.sequence + 1` 同步，导致后续数据被判为“窗外”或“序号错位”。
  - 根因2：握手未真正完成便进入数据发送，接收端状态机尚未进入 `Receiving`，误判为错误。
  - 现状：`ProcessStartFrame()`已包含同步接收窗口的逻辑，但需确保在所有发送入口前触发握手。

- 现象B：握手超时，随后进入重试或失败。
  - 根因1：本地 Loopback 的回调/队列在写线程占优下延迟 ACK 投递，`WaitForHandshakeCompletion()` 超时。
  - 根因2：模拟丢包在握手阶段触发，START 或其 ACK 被丢弃。
  - 根因3：超时阈值过小（近零延迟场景），轻微调度抖动即触发超时。

- 现象C：CRC 失败导致 NAK 增多。
  - 根因1：编码/解码覆盖字段不一致（应覆盖“类型|序号|长度|数据”）；若实现覆盖不当或端序处理错误，会导致误报。
  - 根因2：粘包/半包处理不充分，数据边界出现错位造成 CRC 校验失败。

- 现象D：重传异常，出现“过度重试”或“窗口卡死”。
  - 根因1：ACK 未及时处理，发送窗口未滑动，导致同一序号重复发送。
  - 根因2：超时算法在近零延迟环境下过敏，触发多轮无效重试。
  - 根因3：错误后的缓冲清理不足，旧数据污染新会话。

---

## 5. 双工通信模拟与本地特殊处理建议

- 调度与线程分离：
  - 在 LoopbackTransport 内保证“发送→接收”两个执行路径的线程分离与公平调度，必要时提高接收处理回调的优先级，避免 ACK 饥饿。
  - 对 `NotifyDataReceived()` 的回调处理设置上限间隔或批量化以减少抖动影响。

- 最小 RTT 与超时下限：
  - 在近零延迟环境下设置 `RTT_min`（如 10–20ms）与 `timeout_min`（如 50–100ms），避免假超时导致的重传风暴。
  - 对 RTT 平滑（如 EWMA）引入“地板值”与“抖动抑制”，使本地仿真与真实串口更接近。

- 握手前置与统一路径：
  - 在所有可靠模式发送入口统一调用 `EnsureSessionStarted()`，并在握手完成后再进入 `SendPacket()`，杜绝“未建会话先发数据”。
  - 对 `ProcessAckFrame()` 的握手 ACK 处理保持原子性：设置完成标记 → 条件通知 → 更新窗口。

- 粘包/半包与边界处理：
  - 对 `FrameCodec` 的解码器强化边界与帧同步策略（包头/包尾与长度一致性），必要时引入“重新同步”机制以处理失步。
  - 在错误后执行输入队列清理与标志复位，消除旧数据影响。

- 丢包与乱序仿真：
  - 保持 Loopback 的“模拟延迟/丢包”注入，但握手阶段默认禁用丢包；数据阶段允许低比例丢包以验证重传路径。
  - 由于窗口=1，不建议在本地仿真乱序；重点验证 ACK/NAK 与重传即可。

---

## 6. 数据包确认机制与错误恢复流程核查

- ACK 生成与发送：`ReliableChannel.cpp::SendAck()` 应在 `ProcessStartFrame()` 与每个数据包正确接收后触发，保证逐包确认与窗口推进。
- NAK 触发条件：CRC 错误、序号不匹配、窗口外数据；触发后应立即调度重传，并根据超时与最大重试次数决定失败与清理。
- 超时重传：基于动态 RTT 设置超时；在本地仿真中加入最小阈值与退避策略，避免过度重试。
- 错误后的清理：在发生协议错误或超时达到阈值后，对发送/接收环形缓冲与队列进行清理，重置会话标志，避免“旧帧残留”。

备注：检索结果显示 ACK/握手路径与窗口更新均已实现，但需在入口处强制握手、在本地设定超时下限，并确保回调调度公平，才能在回路测试下稳定运行。

---

## 7. 改进方案与可行性评估

1) 协议侧改进（高优先级）
- 统一握手入口：在可靠模式的所有发送路径前统一调用 `EnsureSessionStarted()`；对 UI/任务层的“发送”按钮与文件传输入口进行守卫。
- 接收窗口同步：保持 `ProcessStartFrame()` 的窗口同步逻辑，并在断点续传/重连场景下复核基准刷新。
- RTT/超时地板：引入最小 RTT 与超时地板值，避免近零延迟环境的假超时；加入指数退避或线性退避。

2) 传输侧改进（中优先级）
- 双工调度优化：LoopbackTransport 的队列处理增加独立接收线程或提高接收回调优先级；握手阶段禁用丢包。
- 粘包处理加强：在 `FrameCodec` 解码器中引入重同步策略（包头/包尾/长度一致性校验失败时，丢弃至下一个包头）。

3) 诊断与日志（中优先级）
- 在窗口重置、ACK/NAK、超时处打印关键字段（`seq/base/next/window/queue size`）并可通过配置开关控制日志量。
- 在握手与文件传输入口打印“是否已建会话”等诊断信息，便于快速定位入口缺失问题。

4) 回归与验证（必需）
- 运行 `autobuild_x86_debug.bat`，确认 0 error / 0 warning。
- AutoTest 集成：执行 `AutoTest.exe --unit-tests` 与 `--integration`，重点覆盖握手、逐包 ACK/NAK 与重传路径。
- 手工测试：UI 选择 Loopback + 可靠模式，发送文件，观察日志中 `START/ACK/DATA/END` 的完整序列与统计稳定性。

可行性：上述改进均为局部调整，涉及协议入口守卫、超时参数与传输调度，无需大规模重构，风险可控，验证路径明确。

---

## 8. 代码与文档参考（关键位置）

- 设计规范：`docs/PortMaster 项目开发.md` 第3章协议规格与第2.3节操作特性。
- 握手启动：`Protocol/ReliableChannel.cpp::EnsureSessionStarted()`（握手 START 发送与等待）。
- 握手完成：`Protocol/ReliableChannel.cpp::ProcessAckFrame()`（握手 ACK 处理与条件通知）。
- 窗口同步：`Protocol/ReliableChannel.cpp::ProcessStartFrame()`（回送 ACK 并同步接收窗口基准）。
- 数据与确认：`Protocol/ReliableChannel.cpp::ProcessDataFrame()` / `ProcessAckFrame()`（窗口推进与进度统计）。
- 回路传输：`Transport/LoopbackTransport.cpp::ProcessSendQueue()`（延迟/丢包仿真与接收回调）。
- 相关报告：`docs/项目核心功能分析与修订报告_V3.md`、`docs/代码审查与修订计划_20250929.md`、`docs/可靠模式回路测试分析报告.md`。

---

## 9. 结论与后续行动

- 结论：当前实现具备可靠协议的基本能力，但在本地回路场景下，握手入口守卫、窗口同步、RTT/超时地板与双工调度优化是稳定运行的关键。频繁错误的主要根因在于本地仿真与真实环境的差异与入口未统一触发握手。
- 后续：
  - 在不改动协议主体的前提下，先行完成入口守卫与参数地板的配置级改进；调整 Loopback 调度与握手阶段的丢包策略。
  - 完成上述改进后，执行脚本化与手工回归测试，记录 ACK/NAK/重传统计并评估稳定性。
  - 如需更贴近“双节点”，可在后续引入双进程互联或内部管道实现的“成对可靠通道”实验，但非当前阻断项。

---

## 10. 附录：术语与缩写

- RTT：往返时延（Round-Trip Time）
- EWMA：指数加权移动平均（Exponential Weighted Moving Average）
- ACK/NAK：确认/否认帧（Acknowledgement / Negative Acknowledgement）
- 窗口=1：单包滑动窗口，逐包确认