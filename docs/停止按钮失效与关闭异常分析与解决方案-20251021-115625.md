# 停止按钮失效与关闭异常分析与解决方案

## 1. 复现场景
- 测试流程：在大文件传输过程中点击“中断”暂停，随后点击“继续”恢复；其后点击“停止”按钮无反应；继续在传输进行时点击窗口关闭按钮触发系统错误弹窗。
- 日志来源：`build/Debug/PortMaster_debug.log`，时间窗口 `11:48:19`–`11:48:28`。
- 当前构建：采用最新暂停/恢复修复后的版本，仍未执行进一步代码改动。

## 2. 关键日志证据
- 传输恢复后仍持续落盘，未见“传输已被用户终止”日志，显示停止逻辑未触发。
- 日志 `build/Debug/PortMaster_debug.log:2321` 记录 `[11:48:28.409] 程序关闭：正在取消活跃的传输任务...` 后戛然而止，说明退出流程在任务取消阶段异常中断。

## 3. 根因分析
### 3.1 停止按钮始终禁用
- `DialogUiController::UpdateTransmissionButtons` (`src/DialogUiController.cpp:203-215`) 仅在 `transmitting == true` 时启用停止按钮。
- `CPortMasterDlg::StartTransmission()`、`PauseTransmission()`、`ResumeTransmission()` 中从未调用 `UpdateTransmissionButtons(true, …)`，仅在初始化时调用 `UpdateTransmissionButtons(false, false)` (`src/PortMasterDlg.cpp:455-459`)。
- 因此发送开始后 `IDC_BUTTON_STOP` 仍保持禁用状态，用户看似可点击但实际上Windows阻止事件触发，导致 `PortMasterDialogEvents::HandleStop()` (`src/PortMasterDialogEvents.cpp:147-178`) 永远不会被执行。

### 3.2 关闭窗口时出现系统错误
- 关闭窗口触发 MFC 默认的 `OnCancel()` → `DestroyWindow()` → `PostNcDestroy()` 调用链。
- 真正的清理逻辑集中在 `CPortMasterDlg::PostNcDestroy()` (`src/PortMasterDlg.cpp:547-598`)，此时窗口句柄已失效，但函数仍调用 `m_transmissionCoordinator->Cancel()`。
- `TransmissionCoordinator::Cancel()` (`src/TransmissionCoordinator.cpp:84-90`) 会销毁当前任务，而 `TransmissionTask::~TransmissionTask()` (`src/TransmissionTask.cpp:18-131`) 在 `Cancel()` 内部调用 `UpdateProgress()`，进一步触发 `CPortMasterDlg::OnTransmissionProgress()`。
- `OnTransmissionProgress()` (`src/PortMasterDlg.cpp:810-829`) 通过 `PostMessage` 将状态回传 UI；由于窗口在 `PostNcDestroy()` 中已经被销毁，`CWnd::PostMessage` 得到无效句柄并触发系统级错误，导致退出流程被中断且未能写出后续日志。

## 4. 唯一解决方案
1. **完整接管按钮状态管理**  
   - 在 `StartTransmission()` 与 `ResumeTransmission()` 完成状态刷新后调用 `m_uiController->UpdateTransmissionButtons(true, false)`；在 `PauseTransmission()` 中调用 `UpdateTransmissionButtons(true, true)`；在终止、完成或异常分支统一调用 `UpdateTransmissionButtons(false, false)`。  
   - 该调整确保停止按钮仅在传输生命周期内启用，并与暂停态保持一致。
2. **将传输清理迁移至窗口销毁前**  
   - 新增 `CPortMasterDlg::ShutdownActiveTransmission()` 私有方法，封装原 `PostNcDestroy()` 中的四段清理逻辑（取消任务、停接收、关闭缓存、断开连接），并在函数开头加入幂等保护。  
   - 重载 `OnCancel()` 和 `OnClose()` 调用该方法后再调用基类实现，使所有 `PostMessage` 都在窗口句柄仍然有效时发出。  
   - `PostNcDestroy()` 精简为仅调用 `CDialogEx::PostNcDestroy()`，避免销毁后继续触发回调。

## 5. 修订任务清单
1. 阶段一（按钮状态修复）  
   - 执行前验证：复查本节 3.1 对应代码与日志缺失情况。  
   - 操作内容：在 `StartTransmission()`、`PauseTransmission()`、`ResumeTransmission()` 及传输完成/终止分支添加统一的 `UpdateTransmissionButtons` 调用；确保 `m_isTransmitting`、`m_transmissionPaused` 与 UI 状态同步。  
   - 执行后验证：构建 Debug 版本并手动触发发送→停止，确认 `PortMaster_debug.log` 出现 “传输已被用户终止...”。
2. 阶段二（退出流程整改）  
   - 执行前验证：核对 `PostNcDestroy()` 当前调用链，确认无其他模块依赖。  
   - 操作内容：实现 `ShutdownActiveTransmission()`（含幂等标志），在 `OnCancel()`/`OnClose()` 中调用；移除 `PostNcDestroy()` 中的清理代码，仅保留基类调用。  
   - 执行后验证：在传输进行中关闭窗口，确认日志出现完整的 “程序关闭：传输任务已取消/已停止/已断开”等语句且无系统错误弹窗。
3. 阶段三（质量门禁）  
   - 执行前验证：确保阶段一、二修改后的代码路径全部覆盖在 `ShutdownActiveTransmission()` 中。  
   - 操作内容：运行 `./smart_build_wsl.sh`（或 Windows 对应脚本）取得 “0 error(s), 0 warning(s)” 构建结果，并重放 “发送→停止→关闭” 两轮，记录关键日志片段。  
   - 执行后验证：在《修订工作记录》与本文件补充测试结果、日志编号，并准备 `fix: 修复传输停止与退出异常` 提交说明。

## 6. 验证与交付准则
- 按阶段三要求截取含 “0 error(s), 0 warning(s)” 的构建日志并归档。
- 需提供包含 `PortMasterDebug.log` 中停止、关闭流程的行号证据，验证按钮启用与退出流程均生效。
- 推送前同步主仓库与备用仓库，提交信息固定为 `fix: 修复传输停止与退出异常`。
