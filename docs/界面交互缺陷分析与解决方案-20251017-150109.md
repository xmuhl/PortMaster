# 界面交互缺陷分析与解决方案（2025-10-17 15:01:09）

## 1. 现象回溯
- 本地回路测试中，直通 / 可靠模式均能写入缓存与临时文件，但“接收数据”编辑框始终空白。
- 可靠模式传输结束后，状态栏仍显示“正在传输”，同时“保存”按钮保持禁用。
- 切换直通 ⇄ 可靠模式时未即时提示需要重新连接，只有在点击“发送”后才弹出提示。
- 日志 `build/Debug/PortMaster_debug.log` 显示 `ReceiveCacheService::AppendData` 持续写入缓存并刷新临时文件 (`14:46:56` 至 `14:46:57`)，`TransmissionTask::ExecuteTransmission` 已记录“传输成功完成”，但随后的 UI 状态未更新。

## 2. 根因分析（执行任何修复前需核对）

### 2.1 接收窗口无数据显示
1. `OnTransportDataReceived` (`src/PortMasterDlg.cpp:1619-1696`) 将数据写入 `ReceiveCacheService`，但未更新 `m_receiveDataCache` / `m_receiveCacheValid`。
2. `UpdateReceiveDisplayFromCache` (`src/PortMasterDlg.cpp:938-961`) 仅在 `m_receiveCacheValid && !m_receiveDataCache.empty()` 时刷新 UI。
3. 由于 `m_receiveDataCache` 永远为空，节流定时器即便触发也只能清空显示，导致窗口始终空白。

### 2.2 状态栏与保存按钮未恢复
1. `OnTransmissionComplete` (`src/PortMasterDlg.cpp:1951-2051`) 成功分支未调用 `UpdateSaveButtonStatus()`，保存按钮依赖的状态仍来自旧逻辑。
2. `UpdateSaveButtonStatus` (`src/PortMasterDlg.cpp:1525-1587`) 首先检查 `reliableChannel->IsFileTransferActive()`；可靠模式下该标志在握手结束前仍保持 `true`，即便 `m_isTransmitting` 已置为 `false`。
3. `OnTransmissionStatusUpdate` (`src/PortMasterDlg.cpp:1833-1895`) 在 `m_isTransmitting` 已清零后仍把“正在传输 …”写回状态栏，覆盖了完成状态。

### 2.3 模式切换缺乏即时提示
1. `OnBnClickedRadioReliable/Direct` (`src/PortMasterDlg.cpp:1115-1134`,`1340-1350`) 仅更新 UI 文本，并未检测连接状态。
2. 连接仍保持旧模式，直到点击“发送”时 `StartTransmission` 才发现模式与通道不匹配并提示用户，造成体验延迟。

## 3. 唯一修复方案

> 以下阶段必须按顺序执行。执行前复核本节对应小节，执行后在本文件追加“处理结果”并同步 `docs/修订工作记录20251017-111429.md` 中的阶段记录。

### 阶段A：恢复接收缓存与显示同步
1. 在 `OnTransportDataReceived` 中，在 `AppendData` 成功后调用 `m_receiveCacheService->GetMemoryCache()`，生成最新快照赋值给 `m_receiveDataCache`，并设置 `m_receiveCacheValid = !m_receiveDataCache.empty()`。
2. 在同一位置更新 `m_bytesReceived` 与 `m_totalReceivedBytes` 的原子统计，确保 UI 消息处理无需再自算累积。
3. 在 `OnTransportDataReceivedMessage` 中移除对 `m_bytesReceived += dataSize` 的重复累加，改用快照值，防止显示与统计滞后。

### 阶段B：修复状态栏与保存按钮状态流
1. 在 `OnTransmissionComplete` 成功分支调用 `UpdateSaveButtonStatus()`，并在调用前将 `m_isTransmitting = false`（已存在）作为统一门禁。
2. 调整 `UpdateSaveButtonStatus`：若 `m_isTransmitting` 为 `true`，直接禁用保存按钮；否则优先依据 `ReceiveCacheService::GetTotalReceivedBytes()`、`m_receiveDataCache.size()` 判断是否有数据，不再依赖 `ReliableChannel::IsFileTransferActive()`；保留日志输出用于诊断。
3. 在 `OnTransmissionStatusUpdate` 中若 `!m_isTransmitting` 则跳过状态文本更新，确保完成态不被“正在传输”覆盖。

### 阶段C：模式切换即时提示与按钮管控
1. 在 `OnBnClickedRadioReliable` / `OnBnClickedRadioDirect` 中检测 `m_isConnected`：
   - 若已连接，立刻弹出提示要求重新连接，并调用 `m_uiController->UpdateTransmissionButtons(false,false)` 禁用发送/停止按钮；
   - 设置新成员 `m_requiresReconnect = true` 并通过 `m_uiController->SetStatusText(_T("模式已切换，请重新连接"))` 提示用户。
2. 在 `HandleConnect` 成功分支清除 `m_requiresReconnect`，并在 `HandleSend` 中若该标志为真则直接提示用户重新连接而不进入传输流程。
3. 将 `UpdateConnectionStatus()` 调整为：若 `m_requiresReconnect` 为真，则状态文本保持“模式已切换，请重新连接”，并保持保存按钮禁用，避免错用旧连接。

### 阶段D：验证闭环
1. 执行 `autobuild_x86_debug.bat`，确认编译输出 `0 error(s), 0 warning(s)`。
2. 回路环境下分别测试直通、可靠模式：
   - 接收窗口实时显示数据；
   - 可靠传输结束后状态栏更新为“传输完成…”，保存按钮可用；
   - 切换模式立即提示并禁用发送，重新连接后恢复。
3. 将关键日志与验证结论回填到 `docs/修订工作记录20251017-111429.md` 对应阶段“处理结果”。

## 4. 验证要求
1. 阶段A/B 完成后立即运行 `autobuild_x86_debug.bat`；保留包含 “0 error(s), 0 warning(s)” 的日志片段。
2. 直通/可靠模式各执行一次 14KB 以上的回路传输，截取接收窗口截图或记录日志确认数据已显示。
3. 切换模式后未重新连接时，发送按钮应被禁用并提示；重新连接后按钮恢复、状态提示更新。
4. 确保 `docs/修订工作记录20251017-111429.md` 与本文件同步维护阶段结果，完成后方可提交。

（尚未执行代码修改，待阶段任务完成后请在本文件追加“处理结果”小节。）***
