# PortMaster 控件功能调整修订方案

**修订日期**：2025-10-20
**修订范围**：控件功能定义与显示逻辑调整
**文档版本**：v1.0 (方案阶段)

---

## 一、修订概述

### 修订目标

调整PortMaster UI界面中两个关键显示控件的功能定义和显示逻辑：

1. **IDC_STATIC_PORT_STATUS**：改为显示端口类型和连接状态信息（如"COM3 (已连接)"或"COM1 (占用)"）
2. **IDC_STATIC_SPEED**：改为显示当前传输进度百分比（如"45%"或"100%"）
3. **日志信息**：将传输结束后的接收数据大小、文件保存路径等操作信息统一迁移到日志栏显示

### 修订意义

- **用户体验优化**：使界面显示信息更清晰、更符合用户的操作习惯
- **功能区分**：明确区分端口信息、进度显示、日志记录的显示区域
- **逻辑一致性**：统一操作信息的展示位置，便于用户追踪操作过程

---

## 二、问题分析

### 当前状态分析

#### 2.1 IDC_STATIC_PORT_STATUS 当前实现

**资源定义**：
- 位置：`resources/PortMaster.rc:139-140`
- 初始值：`"COM1"`

**实现逻辑**：
- 位置：`src/DialogUiController.cpp:233-240`
- 功能：显示连接状态（"已连接"/"未连接"）
- 问题：
  - ❌ 仅显示连接状态，不显示端口类型信息
  - ❌ 用户无法快速识别当前使用的是哪个端口
  - ❌ 端口状态变更需要结合主窗口其他控件才能完整了解信息

**调用链路**：
```cpp
PortMasterDlg::UpdateConnectionStatus()           // src/PortMasterDlg.cpp:1552-1575
    ↓
DialogUiController::UpdateConnectionStatus()      // src/DialogUiController.cpp:233-240
    ↓
CStatic::SetWindowText()
```

**相关代码**：
```cpp
// src/DialogUiController.cpp:233-240
void DialogUiController::UpdateConnectionStatus(bool connected)
{
    if (!IsControlValid(m_controls.staticPortStatus))
        return;

    CString statusText = connected ? _T("已连接") : _T("未连接");
    m_controls.staticPortStatus->SetWindowText(statusText);
}
```

#### 2.2 IDC_STATIC_SPEED 当前实现

**资源定义**：
- 位置：`resources/PortMaster.rc:145`
- 初始值：`"12KB/s"`

**实现逻辑**：
- 位置1：`src/StatusDisplayManager.cpp:54-62` 和 `src/DialogUiController.cpp:253-261`
- 功能：显示当前传输速率（发送速率 + 接收速率）
- 计算公式：`(sendSpeed + receiveSpeed) / 1024 = XXX KB/s`
- 问题：
  - ❌ 显示传输速率而非进度百分比
  - ❌ 进度百分比信息分散在进度条显示中，不够直观
  - ❌ 用户需要同时关注进度条和速率，信息展示不够集中

**调用链路**：
```cpp
PortMasterDlg::UpdateStatistics()                 // src/PortMasterDlg.cpp:1624-1631
    ↓
StatusDisplayManager::UpdateSpeedDisplay()        // src/StatusDisplayManager.cpp:54-62
    ↓
SetDlgItemText(IDC_STATIC_SPEED, "XXX KB/s")
```

**相关代码**：
```cpp
// src/StatusDisplayManager.cpp:54-62
void StatusDisplayManager::UpdateSpeedDisplay(uint32_t sendSpeed, uint32_t receiveSpeed)
{
    if (!m_parentDialog)
        return;

    CString speedText;
    speedText.Format(_T("%uKB/s"), (sendSpeed + receiveSpeed) / 1024);
    m_parentDialog->SetDlgItemText(IDC_STATIC_SPEED, speedText);
}
```

#### 2.3 操作信息显示当前实现

**接收数据大小显示**：
- 位置：`src/PortMasterDlg.cpp:1552` 附近
- 位置：`src/DialogUiController.cpp` 多个位置
- 问题：
  - ❌ 数据大小信息分散在不同位置
  - ❌ 没有统一的显示规范
  - ❌ 用户需要在多个地方查看信息

**文件保存路径显示**：
- 位置：`src/PortMasterDlg.cpp:1221-1305`（SaveDataToFile函数）
- 问题：
  - ❌ 信息输出到日志栏，但不够突出
  - ❌ 保存路径信息格式不统一

**日志显示控件**：
- 控件ID：`IDC_STATIC_LOG`（1032）
- 位置：底部状态栏
- 优势：
  - ✅ 可以显示多行信息
  - ✅ 时间戳前缀自动添加
  - ✅ 所有操作信息统一展示

---

## 三、控件功能变更详细方案

### 3.1 IDC_STATIC_PORT_STATUS 变更方案

#### 现状
- 显示内容：连接状态（"已连接"/"未连接"）
- 显示位置：`src/DialogUiController.cpp:233-240`

#### 目标
- 显示内容：端口类型 + 连接状态
- 显示格式：`"COM3 (已连接)"` 或 `"COM1 (占用)"` 或 `"Serial Port (未连接)"`
- 信息来源：
  1. 端口类型：从当前选中的Transport类型获取（PortSessionController）
  2. 连接状态：从Transport连接状态获取
  3. 端口可用状态：从Transport初始化结果获取

#### 修改点列表

| 文件 | 行号 | 修改内容 | 优先级 |
|------|------|--------|-------|
| `src/DialogUiController.h` | 待补充 | 修改UpdateConnectionStatus函数签名，增加portName参数 | P0 |
| `src/DialogUiController.cpp` | 233-240 | 重新实现UpdateConnectionStatus()，显示端口类型+连接状态 | P0 |
| `src/PortMasterDlg.cpp` | 1552-1575 | 修改UpdateConnectionStatus()的调用，传递当前端口名称 | P0 |
| `src/PortConfigPresenter.cpp` | 待确认 | 提供获取端口显示名称的方法（如getPortDisplayName） | P0 |
| `Protocol/PortSessionController.cpp` | 待确认 | 补充获取当前端口信息的接口 | P0 |

#### 技术实现要点

1. **获取端口类型名称**
   - 从PortSessionController获取当前Transport类型
   - 从Transport对象获取端口名称（如COM3、/dev/ttyS0等）
   - 如果不可用，使用PortType枚举对应的显示名称

2. **获取连接状态**
   - 从m_isConnected标志或Transport状态获取
   - 状态值：已连接、未连接、占用等

3. **组合显示**
   - 格式：`{端口名称} ({连接状态})`
   - 例如：
     - `"COM3 (已连接)"`
     - `"COM1 (未连接)"`
     - `"COM5 (占用)"`
     - `"USB Printer (已连接)"`

### 3.2 IDC_STATIC_SPEED 变更方案

#### 现状
- 显示内容：传输速率（KB/s）
- 显示格式：`"12KB/s"`
- 显示位置：`src/StatusDisplayManager.cpp:54-62`

#### 目标
- 显示内容：当前传输进度百分比
- 显示格式：`"45%"` 或 `"100%"`
- 信息来源：从TransmissionCoordinator或进度条控件获取

#### 修改点列表

| 文件 | 行号 | 修改内容 | 优先级 |
|------|------|--------|-------|
| `src/StatusDisplayManager.h` | 待补充 | 删除UpdateSpeedDisplay()方法，新增UpdateProgressDisplay()方法 | P0 |
| `src/StatusDisplayManager.cpp` | 54-62 | 删除UpdateSpeedDisplay()实现，新增UpdateProgressDisplay() | P0 |
| `src/DialogUiController.h` | 待补充 | 删除UpdateSpeedDisplay()，新增UpdateProgressDisplay() | P0 |
| `src/DialogUiController.cpp` | 253-261 | 删除UpdateSpeedDisplay()，新增UpdateProgressDisplay() | P0 |
| `src/PortMasterDlg.cpp` | 1624-1631 | 修改UpdateStatistics()逻辑，调用UpdateProgressDisplay()而非UpdateSpeedDisplay() | P0 |
| `src/PortMasterDialogEvents.cpp` | 待确认 | 在传输进度回调中调用UpdateProgressDisplay() | P0 |

#### 技术实现要点

1. **获取进度百分比**
   - 从TransmissionCoordinator.GetProgressPercent()获取
   - 或从进度条控件GetPos()获取
   - 范围：0-100

2. **显示格式**
   - 纯数字百分比：`"{percent}%"`
   - 例如：`"0%"`、`"45%"`、`"100%"`

3. **更新时机**
   - 传输进度变化时实时更新
   - 传输完成时显示"100%"
   - 未传输时显示"0%"或隐藏

### 3.3 日志栏统一显示方案

#### 现状
- 日志控件：IDC_STATIC_LOG（1032）
- 显示方式：单行文本，最新消息覆盖前一条
- 写入入口：`PortMasterDlg::WriteLog()`

#### 目标
- 统一显示所有操作信息：
  - 接收数据大小：`"接收数据: 1024 B"`
  - 文件保存路径：`"文件已保存: D:\\Downloads\\data.bin"`
  - 传输统计信息：`"传输完成: 发送 512 B，接收 2048 B"`
  - 错误信息：`"错误: 连接超时"`

#### 修改点列表

| 文件 | 行号 | 修改内容 | 优先级 |
|------|------|--------|-------|
| `src/PortMasterDlg.cpp` | 1552附近 | 修改接收数据大小显示，输出到日志栏 | P1 |
| `src/PortMasterDlg.cpp` | 1221-1305 | 确保文件保存路径信息输出到日志栏 | P1 |
| `src/DialogUiController.cpp` | 273-336 | 补充日志信息格式化标准 | P1 |
| `src/StatusDisplayManager.cpp` | 95-103 | 规范日志消息格式 | P1 |

#### 日志信息格式规范

```
[HH:MM:SS] 操作类型: 具体信息
```

例如：
- `[14:32:45] 接收完成: 2048 B`
- `[14:32:46] 文件保存: D:\Downloads\data.bin`
- `[14:32:47] 传输统计: 发送 512B 接收 2048B`
- `[14:32:48] 错误: 连接超时，请重新连接`

---

## 四、关键代码分析与修改指南

### 4.1 IDC_STATIC_PORT_STATUS 修改指南

#### 步骤1：修改DialogUiController接口

**文件**：`src/DialogUiController.h`

**修改前**：
```cpp
void UpdateConnectionStatus(bool connected);
```

**修改后**：
```cpp
// 显示端口类型和连接状态
// 格式："{portName} ({statusText})"
// 例如：COM3 (已连接)，USB Printer (占用)
void UpdateConnectionStatus(const CString& portName, bool connected, const CString& statusExtInfo = _T(""));
```

#### 步骤2：修改DialogUiController实现

**文件**：`src/DialogUiController.cpp:233-240`

**修改前**：
```cpp
void DialogUiController::UpdateConnectionStatus(bool connected)
{
    if (!IsControlValid(m_controls.staticPortStatus))
        return;

    CString statusText = connected ? _T("已连接") : _T("未连接");
    m_controls.staticPortStatus->SetWindowText(statusText);
}
```

**修改后**：
```cpp
void DialogUiController::UpdateConnectionStatus(const CString& portName, bool connected, const CString& statusExtInfo)
{
    if (!IsControlValid(m_controls.staticPortStatus))
        return;

    CString statusText;
    if (connected)
    {
        statusText = _T("已连接");
    }
    else if (!statusExtInfo.IsEmpty())
    {
        statusText = statusExtInfo;  // 如"占用"、"错误"等
    }
    else
    {
        statusText = _T("未连接");
    }

    // 组合显示：端口名 + 连接状态
    CString displayText;
    displayText.Format(_T("%s (%s)"), portName.GetString(), statusText.GetString());
    m_controls.staticPortStatus->SetWindowText(displayText);
}
```

#### 步骤3：修改PortMasterDlg调用

**文件**：`src/PortMasterDlg.cpp:1552-1575`

**修改前**：
```cpp
void CPortMasterDlg::UpdateConnectionStatus()
{
    if (m_requiresReconnect)
    {
        if (m_uiController)
        {
            m_uiController->SetStatusText(_T("模式已切换，请重新连接"));
            m_uiController->UpdateSaveButton(false);
        }
        return;
    }

    if (m_uiController)
    {
        m_uiController->UpdateConnectionStatus(m_isConnected);  // 仅传递连接状态
        m_uiController->UpdateConnectionButtons(m_isConnected);
    }

    UpdateSaveButtonStatus();
}
```

**修改后**：
```cpp
void CPortMasterDlg::UpdateConnectionStatus()
{
    if (m_requiresReconnect)
    {
        if (m_uiController)
        {
            m_uiController->SetStatusText(_T("模式已切换，请重新连接"));
            m_uiController->UpdateSaveButton(false);
        }
        return;
    }

    if (m_uiController)
    {
        // 获取当前端口名称
        CString portName = GetCurrentPortName();  // 新增：获取端口名称

        // 传递端口名称和连接状态
        m_uiController->UpdateConnectionStatus(portName, m_isConnected);
        m_uiController->UpdateConnectionButtons(m_isConnected);
    }

    UpdateSaveButtonStatus();
}

// 新增：获取当前端口显示名称
CString CPortMasterDlg::GetCurrentPortName()
{
    if (m_sessionController)
    {
        // 从PortSessionController获取当前端口信息
        std::string portName = m_sessionController->GetCurrentPortName();
        return CString(portName.c_str());
    }

    // 备选方案：从配置或UI控件获取
    // ...
    return _T("未知端口");
}
```

#### 步骤4：确保PortSessionController提供接口

**文件**：`Protocol/PortSessionController.h`

需要确保以下接口存在：
```cpp
// 获取当前端口名称（如"COM3"、"LPT1"等）
std::string GetCurrentPortName() const;

// 获取当前Transport类型显示名称
std::string GetTransportTypeName() const;

// 获取Transport连接状态
TransportState GetTransportState() const;
```

### 4.2 IDC_STATIC_SPEED 修改指南

#### 步骤1：修改StatusDisplayManager接口

**文件**：`src/StatusDisplayManager.h`

**修改前**：
```cpp
void UpdateSpeedDisplay(uint32_t sendSpeed, uint32_t receiveSpeed);
```

**修改后**：
```cpp
// 删除此方法
// void UpdateSpeedDisplay(uint32_t sendSpeed, uint32_t receiveSpeed);

// 新增：显示传输进度百分比
void UpdateProgressDisplay(int progressPercent);
```

#### 步骤2：修改StatusDisplayManager实现

**文件**：`src/StatusDisplayManager.cpp:54-62`

**修改前**：
```cpp
void StatusDisplayManager::UpdateSpeedDisplay(uint32_t sendSpeed, uint32_t receiveSpeed)
{
    if (!m_parentDialog)
        return;

    CString speedText;
    speedText.Format(_T("%uKB/s"), (sendSpeed + receiveSpeed) / 1024);
    m_parentDialog->SetDlgItemText(IDC_STATIC_SPEED, speedText);
}
```

**修改后**：
```cpp
// 新增：显示传输进度百分比
void StatusDisplayManager::UpdateProgressDisplay(int progressPercent)
{
    if (!m_parentDialog)
        return;

    // 边界检查
    if (progressPercent < 0)
        progressPercent = 0;
    if (progressPercent > 100)
        progressPercent = 100;

    CString progressText;
    progressText.Format(_T("%d%%"), progressPercent);
    m_parentDialog->SetDlgItemText(IDC_STATIC_SPEED, progressText);
}
```

#### 步骤3：修改DialogUiController接口

**文件**：`src/DialogUiController.h`

**修改前**：
```cpp
void UpdateSpeedDisplay(uint32_t sendSpeed, uint32_t receiveSpeed);
```

**修改后**：
```cpp
// 删除此方法
// void UpdateSpeedDisplay(uint32_t sendSpeed, uint32_t receiveSpeed);

// 新增：显示传输进度百分比
void UpdateProgressDisplay(int progressPercent);
```

#### 步骤4：修改DialogUiController实现

**文件**：`src/DialogUiController.cpp:253-261`

**修改前**：
```cpp
void DialogUiController::UpdateSpeedDisplay(uint32_t sendSpeed, uint32_t receiveSpeed)
{
    if (!IsControlValid(m_controls.staticSpeed))
        return;

    CString speedText;
    speedText.Format(_T("%uKB/s"), (sendSpeed + receiveSpeed) / 1024);
    m_controls.staticSpeed->SetWindowText(speedText);
}
```

**修改后**：
```cpp
// 新增：显示传输进度百分比
void DialogUiController::UpdateProgressDisplay(int progressPercent)
{
    if (!IsControlValid(m_controls.staticSpeed))
        return;

    // 边界检查
    if (progressPercent < 0)
        progressPercent = 0;
    if (progressPercent > 100)
        progressPercent = 100;

    CString progressText;
    progressText.Format(_T("%d%%"), progressPercent);
    m_controls.staticSpeed->SetWindowText(progressText);
}
```

#### 步骤5：修改PortMasterDlg调用

**文件**：`src/PortMasterDlg.cpp:1624-1631`（UpdateStatistics函数）

需要找到调用UpdateSpeedDisplay的位置，并修改为调用UpdateProgressDisplay。

**修改前**（示例）：
```cpp
void CPortMasterDlg::UpdateStatistics()
{
    // ...
    m_statusDisplayManager->UpdateSpeedDisplay(sendSpeed, receiveSpeed);
    // ...
}
```

**修改后**：
```cpp
void CPortMasterDlg::UpdateStatistics()
{
    // ...
    // 获取当前进度百分比（从TransmissionCoordinator或进度条获取）
    int progressPercent = GetCurrentProgressPercent();
    m_statusDisplayManager->UpdateProgressDisplay(progressPercent);
    // ...
}

// 新增：获取当前传输进度百分比
int CPortMasterDlg::GetCurrentProgressPercent()
{
    // 方式1：从TransmissionCoordinator获取
    if (m_transmissionCoordinator)
    {
        return m_transmissionCoordinator->GetProgressPercent();
    }

    // 方式2：从进度条控件获取
    CProgressCtrl* progressCtrl = (CProgressCtrl*)GetDlgItem(IDC_PROGRESS);
    if (progressCtrl && progressCtrl->GetSafeHwnd())
    {
        return progressCtrl->GetPos();
    }

    return 0;
}
```

#### 步骤6：传输进度更新时调用

**文件**：`src/PortMasterDialogEvents.cpp` 或其他传输事件处理处

在传输进度更新的回调函数中调用UpdateProgressDisplay：

**示例**：
```cpp
void CPortMasterDlg::OnTransmissionProgress(const TransmissionProgress& progress)
{
    // ...
    if (m_statusDisplayManager)
    {
        m_statusDisplayManager->UpdateProgressDisplay(progress.percentComplete);
    }
    // ...
}
```

### 4.3 日志栏信息格式规范

#### 操作信息统一输出格式

**文件**：`src/PortMasterDlg.cpp` 的WriteLog函数及调用处

#### 接收数据大小显示

**修改前**：
```cpp
// 分散在不同位置，格式不统一
uint64_t receivedBytes = m_receiveCacheService->GetTotalReceivedBytes();
```

**修改后**：
```cpp
// 统一使用日志栏显示
uint64_t receivedBytes = m_receiveCacheService->GetTotalReceivedBytes();
CString logMessage;
logMessage.Format(_T("接收完成: %I64u 字节"), receivedBytes);
WriteLog(logMessage);
```

#### 文件保存路径显示

**文件**：`src/PortMasterDlg.cpp:1221-1305`（SaveDataToFile函数）

**修改前**：
```cpp
CString logMessage;
logMessage.Format(_T("文本数据保存至: %s (%d 字节)"), fileName.GetString(), utf8Length);
```

**修改后**：
```cpp
CString logMessage;
logMessage.Format(_T("文件保存: %s (%I64u 字节)"), filePath.GetString(), utf8Length);
WriteLog(logMessage);
```

#### 传输统计信息

**新增**：
```cpp
// 传输完成时调用
void CPortMasterDlg::LogTransmissionStatistics(uint64_t sentBytes, uint64_t receivedBytes)
{
    CString logMessage;
    logMessage.Format(_T("传输统计: 发送 %I64u B，接收 %I64u B"), sentBytes, receivedBytes);
    WriteLog(logMessage);
}
```

---

## 五、需要修改的代码文件清单

### 核心修改文件（优先级P0 - 必须修改）

| 序号 | 文件 | 修改位置 | 修改内容 | 影响范围 |
|------|------|--------|--------|--------|
| 1 | `src/DialogUiController.h` | UpdateConnectionStatus函数签名 | 增加portName参数 | 接口变更 |
| 2 | `src/DialogUiController.cpp` | 233-240行 | 重新实现UpdateConnectionStatus() | 端口状态显示 |
| 3 | `src/DialogUiController.h` | UpdateSpeedDisplay函数 | 删除，新增UpdateProgressDisplay() | 接口变更 |
| 4 | `src/DialogUiController.cpp` | 253-261行 | 删除UpdateSpeedDisplay，新增UpdateProgressDisplay() | 传输进度显示 |
| 5 | `src/PortMasterDlg.cpp` | 1552-1575行 | 修改UpdateConnectionStatus()调用 | 端口状态显示 |
| 6 | `src/PortMasterDlg.cpp` | 1624-1631行 | 修改UpdateStatistics()调用 | 传输进度显示 |
| 7 | `src/StatusDisplayManager.h` | UpdateSpeedDisplay函数 | 删除，新增UpdateProgressDisplay() | 接口变更 |
| 8 | `src/StatusDisplayManager.cpp` | 54-62行 | 删除UpdateSpeedDisplay，新增UpdateProgressDisplay() | 传输进度显示 |

### 辅助修改文件（优先级P1 - 建议修改）

| 序号 | 文件 | 修改位置 | 修改内容 | 影响范围 |
|------|------|--------|--------|--------|
| 1 | `Protocol/PortSessionController.h` | 新增接口 | GetCurrentPortName()、GetTransportTypeName()等 | 端口信息获取 |
| 2 | `Protocol/PortSessionController.cpp` | 新增实现 | 上述接口的实现 | 端口信息获取 |
| 3 | `src/PortMasterDlg.cpp` | 新增函数 | GetCurrentPortName()、GetCurrentProgressPercent()、LogTransmissionStatistics() | 辅助函数 |
| 4 | `src/PortMasterDialogEvents.cpp` | 传输事件处理 | 在OnTransmissionProgress中调用UpdateProgressDisplay() | 进度实时更新 |
| 5 | `src/PortMasterDlg.cpp` | 1552附近 | 修改接收数据大小显示逻辑 | 日志信息统一 |
| 6 | `src/PortMasterDlg.cpp` | 1221-1305 | 确保文件保存信息输出到日志栏 | 日志信息统一 |

### 验证检查文件（优先级P2 - 需要验证）

| 序号 | 文件 | 检查项 | 目的 |
|------|------|--------|------|
| 1 | `resources/PortMaster.rc` | 控件资源定义 | 确认IDC_STATIC_PORT_STATUS和IDC_STATIC_SPEED的初始值 |
| 2 | `resources/resource.h` | 资源ID定义 | 确认控件ID常量定义正确 |
| 3 | `src/PortMasterDialogEvents.cpp` | 事件处理 | 验证传输进度回调是否会调用更新函数 |
| 4 | `Protocol/PortSessionController.cpp` | 端口管理 | 验证是否能获取当前端口信息 |

---

## 六、修改实施步骤

### 第一阶段：界面状态显示修改（IDC_STATIC_PORT_STATUS）

**步骤1**：修改DialogUiController接口和实现
- 修改`src/DialogUiController.h`中的UpdateConnectionStatus函数签名
- 修改`src/DialogUiController.cpp:233-240`实现新逻辑

**步骤2**：修改PortMasterDlg调用
- 修改`src/PortMasterDlg.cpp:1552-1575`中的UpdateConnectionStatus调用
- 新增GetCurrentPortName()辅助函数

**步骤3**：补充PortSessionController接口
- 在`Protocol/PortSessionController.h`中新增GetCurrentPortName()等接口
- 在`Protocol/PortSessionController.cpp`中实现

**验证**：
```cpp
// 编译验证：确保UpdateConnectionStatus调用语法正确
// 功能验证：检查UI显示是否为 "COM3 (已连接)" 格式
```

### 第二阶段：传输进度显示修改（IDC_STATIC_SPEED）

**步骤1**：删除旧的speed显示，新增progress显示
- 修改`src/StatusDisplayManager.h`删除UpdateSpeedDisplay，新增UpdateProgressDisplay
- 修改`src/StatusDisplayManager.cpp:54-62`实现新逻辑

**步骤2**：修改DialogUiController对应接口
- 修改`src/DialogUiController.h`删除UpdateSpeedDisplay，新增UpdateProgressDisplay
- 修改`src/DialogUiController.cpp:253-261`实现新逻辑

**步骤3**：修改PortMasterDlg调用
- 修改`src/PortMasterDlg.cpp:1624-1631`调用新的UpdateProgressDisplay
- 新增GetCurrentProgressPercent()辅助函数

**步骤4**：确保传输进度更新时实时调用
- 在`src/PortMasterDialogEvents.cpp`的OnTransmissionProgress中调用UpdateProgressDisplay

**验证**：
```cpp
// 编译验证：确保UpdateProgressDisplay调用语法正确
// 功能验证：检查UI显示是否为 "45%" 格式，且随传输进度变化
```

### 第三阶段：日志信息统一（可选但推荐）

**步骤1**：规范接收数据显示
- 修改`src/PortMasterDlg.cpp`相关位置
- 将接收数据大小统一通过WriteLog输出到日志栏

**步骤2**：规范文件保存信息
- 修改`src/PortMasterDlg.cpp:1221-1305`SaveDataToFile函数
- 确保文件保存路径通过WriteLog输出

**步骤3**：新增传输统计信息
- 在`src/PortMasterDlg.cpp`中新增LogTransmissionStatistics函数
- 在传输完成时调用此函数

**验证**：
```
检查日志栏显示格式：
[14:32:45] 接收完成: 2048 字节
[14:32:46] 文件保存: D:\Downloads\data.bin (2048 字节)
[14:32:47] 传输统计: 发送 512 B，接收 2048 B
```

---

## 七、关键技术要点

### 7.1 端口名称获取策略

**优先级顺序**：
1. PortSessionController::GetCurrentPortName() - 优先从Transport获取
2. UI港口选择器当前值 - 备选方案
3. ConfigStore中的保存值 - 最后备选

```cpp
CString CPortMasterDlg::GetCurrentPortName()
{
    // 方式1：从PortSessionController获取（推荐）
    if (m_sessionController && m_sessionController->IsConnected())
    {
        std::string portName = m_sessionController->GetCurrentPortName();
        if (!portName.empty())
        {
            return CString(portName.c_str());
        }
    }

    // 方式2：从UI控件获取
    int nIndex = m_portTypeCombo.GetCurSel();
    if (nIndex != CB_ERR)
    {
        CString selectedPort;
        m_portTypeCombo.GetLBText(nIndex, selectedPort);
        if (!selectedPort.IsEmpty())
        {
            return selectedPort;
        }
    }

    // 方式3：从配置获取
    TransportConfig config = g_configStore.GetTransportConfig();
    if (!config.portName.empty())
    {
        return CString(config.portName.c_str());
    }

    return _T("未知端口");
}
```

### 7.2 进度百分比同步问题

**风险**：PortMasterDlg中可能同时维护进度条和IDC_STATIC_SPEED，需要确保显示的进度值一致

**解决方案**：
- 从统一的源头获取进度（TransmissionCoordinator）
- 同时更新进度条和IDC_STATIC_SPEED控件
- 或者从进度条控件获取当前值，再同步到IDC_STATIC_SPEED

```cpp
// 推荐：从TransmissionCoordinator获取
if (m_transmissionCoordinator)
{
    int percent = m_transmissionCoordinator->GetProgressPercent();
    progressCtrl->SetPos(percent);  // 更新进度条
    m_statusDisplayManager->UpdateProgressDisplay(percent);  // 更新百分比显示
}
```

### 7.3 线程安全问题

**注意**：确保以下场景中的线程安全性
- 后台接收线程调用UpdateProgressDisplay时
- UI线程读取m_isConnected标志时
- 多个线程同时更新端口状态时

**解决方案**：
- 使用现有的线程同步机制（m_mutex、m_isConnected原子变量等）
- 确保所有UI更新都通过PostMessage转到UI线程执行
- 如果m_sessionController提供的接口不是线程安全的，需要在调用前加锁

---

## 八、测试验证清单

### 单元测试

- [ ] DialogUiController::UpdateConnectionStatus输出格式正确
- [ ] DialogUiController::UpdateProgressDisplay百分比显示正确
- [ ] 进度值边界处理（0%、100%）
- [ ] 端口名称为空时的处理

### 集成测试

- [ ] 连接成功时，IDC_STATIC_PORT_STATUS显示 "COM3 (已连接)"
- [ ] 断开连接时，IDC_STATIC_PORT_STATUS显示 "COM3 (未连接)"
- [ ] 传输开始时，IDC_STATIC_SPEED从0%开始
- [ ] 传输过程中，IDC_STATIC_SPEED实时显示百分比
- [ ] 传输完成时，IDC_STATIC_SPEED显示100%
- [ ] 模式切换后，IDC_STATIC_PORT_STATUS显示 "模式已切换，请重新连接"

### 界面验证

- [ ] IDC_STATIC_PORT_STATUS和IDC_STATIC_SPEED的显示位置清晰可见
- [ ] 两个控件之间没有信息混淆
- [ ] 日志栏显示所有操作信息
- [ ] 没有显示"12KB/s"等速率信息

### 性能验证

- [ ] 频繁更新进度时，UI不卡顿
- [ ] 端口状态变化时，更新及时
- [ ] 内存使用稳定，无泄漏

---

## 九、回滚方案

如果修改过程中出现问题，可通过以下方式回滚：

### 快速回滚（仅恢复代码逻辑）

1. 恢复UpdateConnectionStatus为仅显示连接状态
2. 恢复UpdateSpeedDisplay显示KB/s而非百分比
3. 注释掉新增的日志输出代码

### 完整回滚（恢复Git版本）

```bash
# 查看最近的修改
git log --oneline -10

# 回退到修改前的版本
git reset --hard <commit-id>
```

---

## 十、文档更新建议

此方案文档应保存为项目技术档案，建议在以下情况更新：

- [ ] 实施过程中发现新的修改点
- [ ] 测试过程中发现设计缺陷
- [ ] 代码审查阶段收到反馈
- [ ] 最终实施完成后总结经验

---

## 附录：相关代码文件导航

### 核心文件（需要了解）

```
项目根目录
├── src/
│   ├── PortMasterDlg.h/.cpp          - 主对话框类
│   ├── DialogUiController.h/.cpp     - UI控制器（关键修改）
│   ├── StatusDisplayManager.h/.cpp   - 状态显示管理（关键修改）
│   ├── PortMasterDialogEvents.cpp    - 事件处理
│   ├── PortConfigPresenter.h/.cpp    - 端口配置呈现
│   └── DialogConfigBinder.h/.cpp     - 配置绑定
├── Protocol/
│   ├── PortSessionController.h/.cpp  - 会话控制（需补充接口）
│   └── ReliableChannel.h/.cpp        - 可靠通道
├── Common/
│   ├── ConfigStore.h/.cpp            - 配置存储
│   └── DataPresentationService.h/.cpp - 数据呈现
└── resources/
    ├── PortMaster.rc                 - 资源文件（验证）
    └── resource.h                    - 资源头文件（验证）
```

### 文件关系图

```
PortMasterDlg (主窗口)
    ↓
    ├─→ DialogUiController (UI管理)
    │       ├─→ UpdateConnectionStatus() ← 需修改
    │       └─→ UpdateProgressDisplay() ← 新增
    │
    ├─→ StatusDisplayManager (状态显示)
    │       ├─→ UpdateSpeedDisplay() ← 删除
    │       └─→ UpdateProgressDisplay() ← 新增
    │
    ├─→ PortSessionController (会话管理)
    │       ├─→ GetCurrentPortName() ← 需新增
    │       └─→ GetTransportState()
    │
    ├─→ TransmissionCoordinator (传输管理)
    │       └─→ GetProgressPercent() ← 用于获取进度
    │
    └─→ DialogConfigBinder (配置绑定)
            └─→ SaveFromUI() / LoadToUI()
```

---

## 修订方案生成时间

文档生成时间：2025-10-20
方案阶段版本：v1.0
预计实施工时：4-6小时
预计测试工时：2-3小时

**后续步骤**：
1. ✅ 完成方案文档生成
2. ⏳ 等待方案评审和确认
3. ⏳ 开始代码实施
4. ⏳ 执行单元测试和集成测试
5. ⏳ 提交变更并生成最终工作记录

