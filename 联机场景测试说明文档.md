# PortMaster 联机场景测试说明文档

## 文档概述

本文档提供 PortMaster 应用程序的联机场景测试指南，涵盖各种传输模式下的端到端测试方案。用于验证第四阶段建立的自动化验证体系的实际应用效果。

---

## 测试环境准备

### 基本环境要求

- **操作系统**: Windows 7/8/10/11 (x86/x64)
- **Visual Studio**: 2022 Community/Professional/Enterprise
- **Python**: 3.7+ (用于运行验证脚本)
- **硬件设备**: 根据测试传输类型准备相应硬件

### 验证脚本清单

1. **可靠协议验证脚本**: `verify_reliable_protocol.py`
   - 验证握手闭环、会话ID生成、状态管理
   - 运行: `python verify_reliable_protocol.py`

2. **配置系统验证脚本**: `verify_config_system.py`
   - 验证配置读写、默认值回退、持久化
   - 运行: `python verify_config_system.py`

---

## 传输模式测试方案

### 1. 串口传输测试 (Serial Transport)

#### 测试设备配置
```
发送端: COM1, 9600bps, 8N1, 无流控
接收端: COM2, 9600bps, 8N1, 无流控
连接方式: 交叉串口线或USB转串口适配器
```

#### 测试用例

##### 1.1 基础数据传输
```
目标: 验证串口基本收发功能
步骤:
1. 配置发送端 - 选择COM1，9600bps
2. 配置接收端 - 选择COM2，9600bps
3. 发送端输入: "Hello PortMaster!"
4. 点击"发送"按钮
5. 验证接收端显示相同内容

预期结果:
- 连接状态显示"已连接"
- 数据完整传输，无丢失
- 发送/接收字节数统计正确
```

##### 1.2 大文件传输
```
目标: 验证大文件的稳定传输和UI响应性
步骤:
1. 准备测试文件 (建议1MB以上)
2. 通过文件按钮或拖拽加载文件
3. 选择可靠传输模式
4. 开始传输并观察进度条和接收窗口
5. 验证传输完成后的数据完整性

预期结果:
- 进度条正常更新，无卡顿
- 接收窗口不出现频繁闪烁 (验证节流机制)
- 传输完成后可重复发送 (验证缓存修复)
- 文件内容完全一致
```

##### 1.3 十六进制模式传输
```
目标: 验证十六进制显示和二进制数据处理
步骤:
1. 勾选"十六进制显示"复选框
2. 发送端输入十六进制数据: "48 65 6C 6C 6F 20 57 6F 72 6C 64"
3. 执行传输
4. 验证接收端十六进制显示格式

预期结果:
- 数据以标准十六进制格式显示 (16字节/行)
- 右侧显示ASCII对照
- 地址偏移正确显示
```

### 2. 并口传输测试 (Parallel Transport)

#### 测试设备配置
```
发送端: LPT1
接收端: 通过并口线连接的打印机或并口设备
连接方式: 标准并口打印线
```

#### 测试用例

##### 2.1 并口设备检测
```
目标: 验证并口设备的自动检测功能
步骤:
1. 连接并口设备到LPT1
2. 启动PortMaster，选择并口传输
3. 检查端口列表是否显示LPT1
4. 测试连接状态

预期结果:
- 端口列表显示可用的LPT端口
- 连接状态正确显示设备状态
- 设备占用检测功能正常
```

##### 2.2 打印数据传输
```
目标: 验证向并口打印设备发送数据
步骤:
1. 连接支持的并口打印机
2. 发送简单文本数据
3. 观察打印机响应
4. 检查传输状态和错误处理

预期结果:
- 数据成功传输到打印设备
- 错误情况下有明确的错误提示
- 传输状态正确反映设备响应
```

### 3. USB打印传输测试 (USB Print Transport)

#### 测试设备配置
```
设备: USB打印机或USB打印服务器
连接: 直接USB连接或网络共享打印机
```

#### 测试用例

##### 3.1 USB打印机识别
```
目标: 验证USB打印设备的自动识别
步骤:
1. 连接USB打印机
2. 选择USB传输模式
3. 检查设备列表更新
4. 测试设备选择和连接

预期结果:
- USB设备自动出现在端口列表
- 设备名称正确显示
- 连接建立成功
```

##### 3.2 数据格式兼容性
```
目标: 验证不同数据格式的打印兼容性
步骤:
1. 发送纯文本数据
2. 发送包含控制字符的数据
3. 发送二进制数据
4. 验证打印输出结果

预期结果:
- 各种格式数据正确处理
- 控制字符正确解释
- 二进制数据不损坏传输
```

### 4. 网络传输测试 (Network Transport)

#### 测试环境配置
```
网络环境: 局域网或本地环回
测试端口: 9100 (RAW), 631 (IPP), 自定义端口
协议类型: TCP/UDP
```

#### 测试用例

##### 4.1 网络连接建立
```
目标: 验证网络传输的连接建立
步骤:
1. 配置目标IP地址和端口
2. 选择TCP或UDP协议
3. 测试连接建立过程
4. 验证连接状态显示

预期结果:
- 网络连接成功建立
- 连接超时机制正常工作
- 连接错误有清晰提示
```

##### 4.2 网络数据传输
```
目标: 验证网络环境下的数据传输
步骤:
1. 建立网络连接
2. 发送测试数据包
3. 监控网络传输状态
4. 验证数据完整性

预期结果:
- 网络数据包正确发送
- 传输速度统计准确
- 网络中断能正确检测和恢复
```

### 5. 环回测试 (Loopback Transport)

#### 测试配置
```
模式: 内部环回测试
目的: 功能验证和性能测试
```

#### 测试用例

##### 5.1 功能验证测试
```
目标: 验证所有功能在环回模式下正常工作
步骤:
1. 选择环回传输模式
2. 测试基本发送接收功能
3. 验证可靠传输协议
4. 测试各种显示模式

预期结果:
- 发送数据立即在接收窗口显示
- 可靠传输握手流程正常
- 所有UI功能响应正确
```

##### 5.2 性能压力测试
```
目标: 验证系统在高负载下的稳定性
步骤:
1. 环回模式下发送大量数据
2. 连续多次传输测试
3. 监控内存使用和CPU占用
4. 验证长时间运行稳定性

预期结果:
- 系统保持稳定运行
- 内存使用合理，无泄漏
- UI响应及时，无卡顿
```

---

## 可靠传输协议专项测试

### 握手机制验证

#### 自动化验证
```bash
# 运行可靠协议验证脚本
python verify_reliable_protocol.py

预期输出:
✅ 动态会话ID生成
✅ START帧窗口管理
✅ 真正握手等待机制
✅ 握手状态追踪
🎉 可靠传输协议验证全部通过！
```

#### 手工验证步骤
```
目标: 手工验证握手机制的正确性
步骤:
1. 选择任意传输类型，启用可靠模式
2. 发送数据时观察日志输出
3. 检查会话ID是否为非零唯一值
4. 验证START/ACK/DATA/END帧序列
5. 确认握手超时和重试机制

检查点:
- 会话ID每次启动都不同
- START帧得到ACK响应后才发送数据
- 超时后有重传机制
- 握手失败有明确错误提示
```

### 错误处理和恢复

#### 连接中断测试
```
目标: 验证连接中断时的处理
步骤:
1. 建立连接并开始传输
2. 人为中断连接 (拔线、关闭设备等)
3. 观察系统响应
4. 恢复连接后测试功能

预期结果:
- 连接中断被及时检测
- 用户收到明确的错误提示
- 系统状态正确更新
- 重连后功能正常恢复
```

#### 数据损坏处理
```
目标: 验证数据完整性检查
步骤:
1. 在可靠模式下发送数据
2. 模拟数据传输中的CRC错误
3. 验证NAK机制和重传
4. 确认最终数据完整性

预期结果:
- CRC校验错误被检测
- 自动发送NAK并请求重传
- 重传机制正常工作
- 最终数据完整无损
```

---

## 配置管理测试

### 配置持久化验证

#### 自动化验证
```bash
# 运行配置系统验证脚本
python verify_config_system.py

预期输出:
✅ JSON配置文件读写
✅ 默认值回退机制
✅ 多层配置存储
✅ 配置自动持久化
🎉 配置系统验证全部通过！
```

#### 手工配置测试
```
目标: 验证配置的保存和恢复
步骤:
1. 修改各种设置 (端口、波特率、显示模式等)
2. 关闭程序
3. 重新启动程序
4. 验证所有设置正确恢复

检查点:
- 传输参数正确保存
- UI状态正确恢复
- 最近使用文件列表保持
- 窗口大小和位置恢复
```

### 配置损坏恢复
```
目标: 验证配置文件损坏时的处理
步骤:
1. 手动损坏配置文件 (删除或格式错误)
2. 启动程序
3. 验证默认配置加载
4. 测试功能正常性

预期结果:
- 程序能正常启动
- 使用合理的默认配置
- 所有功能可正常使用
- 新配置能正确保存
```

---

## 性能和稳定性测试

### 长期运行测试
```
目标: 验证长期运行的稳定性
测试时间: 24小时连续运行
测试内容:
1. 定期自动发送数据
2. 模拟各种使用场景
3. 监控资源占用
4. 记录异常和错误

评估标准:
- 内存使用稳定，无明显泄漏
- CPU占用合理
- UI响应正常
- 无崩溃或异常退出
```

### 并发连接测试
```
目标: 验证多连接场景下的表现
步骤:
1. 同时打开多个PortMaster实例
2. 使用不同传输类型
3. 同时进行数据传输
4. 观察系统整体表现

预期结果:
- 各实例独立运行
- 资源占用合理分配
- 不同传输类型互不干扰
- 配置隔离正确
```

---

## 故障排查和诊断

### 常见问题诊断

#### 连接问题
```
症状: 无法建立连接
可能原因:
1. 端口被其他程序占用
2. 硬件设备未正确连接
3. 驱动程序问题
4. 权限不足

诊断步骤:
1. 检查设备管理器中的端口状态
2. 使用系统工具验证端口可用性
3. 检查程序日志的错误信息
4. 尝试以管理员身份运行
```

#### 传输问题
```
症状: 数据传输失败或不完整
可能原因:
1. 传输参数配置错误
2. 硬件连接不稳定
3. 数据格式不兼容
4. 缓冲区溢出

诊断步骤:
1. 验证传输参数设置
2. 检查物理连接稳定性
3. 尝试不同的数据格式
4. 减少数据量进行测试
```

#### 性能问题
```
症状: 传输速度慢或UI卡顿
可能原因:
1. 硬件性能限制
2. 系统资源不足
3. 网络延迟或丢包
4. 软件配置不当

诊断步骤:
1. 监控CPU和内存使用
2. 检查网络质量
3. 调整缓冲区大小
4. 优化传输参数
```

### 日志分析

#### 日志文件位置
```
默认日志位置: %LOCALAPPDATA%\PortMaster\logs\
日志文件格式: portmaster_YYYYMMDD.log
日志级别: ERROR, WARNING, INFO, DEBUG
```

#### 关键日志信息
```
连接建立: [INFO] Transport connected: COM1
数据传输: [INFO] Data sent: 1024 bytes
协议握手: [INFO] Handshake completed: Session ID 0x1234
错误信息: [ERROR] Connection failed: Device not found
```

---

## 测试报告模板

### 基本信息
```
测试日期: [填写测试日期]
测试人员: [填写测试人员]
程序版本: [填写程序版本]
测试环境: [操作系统版本，硬件配置]
```

### 测试结果汇总
```
| 测试项目 | 测试用例数 | 通过数 | 失败数 | 通过率 | 备注 |
|----------|------------|---------|---------|---------|------|
| 串口传输 | 6 | 6 | 0 | 100% | 全部通过 |
| 并口传输 | 4 | 3 | 1 | 75% | 一个用例设备问题 |
| USB传输 | 4 | 4 | 0 | 100% | 全部通过 |
| 网络传输 | 6 | 5 | 1 | 83% | 网络环境问题 |
| 可靠协议 | 8 | 8 | 0 | 100% | 全部通过 |
| 配置管理 | 6 | 6 | 0 | 100% | 全部通过 |
```

### 问题记录
```
问题1:
描述: [详细描述问题现象]
重现步骤: [列出重现步骤]
预期结果: [期望的正确结果]
实际结果: [实际观察到的结果]
严重级别: [高/中/低]
解决建议: [解决方案建议]
```

### 改进建议
```
1. 功能改进建议
2. 性能优化建议
3. 用户体验改进建议
4. 文档完善建议
```

---

## 自动化测试集成

### 持续集成流程
```bash
# CI/CD 流水线中的测试步骤
1. 编译验证
   autobuild_x86_debug.bat

2. 协议验证
   python verify_reliable_protocol.py

3. 配置验证
   python verify_config_system.py

4. 回归测试
   python run_regression_tests.py

5. 生成测试报告
   python generate_test_report.py
```

### 测试环境自动化部署
```bash
# 测试环境准备脚本
setup_test_env.bat:
1. 安装必要的驱动程序
2. 配置虚拟串口
3. 准备测试数据文件
4. 启动测试服务进程
```

---

## 文档维护

### 更新频率
- 每次重大功能更新后更新测试文档
- 发现新问题或测试用例时及时补充
- 至少每季度回顾和更新一次

### 版本控制
- 文档版本与软件版本保持同步
- 重要变更记录变更日志
- 保留历史版本用于参考对比

---

**文档版本**: 1.0
**最后更新**: 2025年9月26日
**维护人员**: PortMaster开发团队

---

*此文档作为PortMaster项目第四阶段自动化验证体系的重要组成部分，为确保软件质量和用户体验提供全面的测试指导。*